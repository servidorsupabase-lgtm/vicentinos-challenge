<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Panel Admin ‚Äî Vicentinos</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  body{background:#0b1220;color:#e9f6ff;font-family:'Inter',sans-serif;margin:0;padding:20px}
  h1{margin:0 0 8px}
  .card{background:#0e1730;border:1px solid #2f6cff33;border-radius:10px;padding:16px;margin-bottom:14px}
  .grid{display:grid;grid-template-columns:1fr;gap:14px}
  @media(min-width:980px){.grid{grid-template-columns:1fr 1fr}}
  input,button,select{width:100%;padding:10px;border-radius:8px;border:1px solid #335; background:#081025;color:#e9f6ff;margin-top:6px}
  button{background:#2f6cff;border:none;font-weight:600;cursor:pointer}
  button:hover{filter:brightness(1.06)}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .row>*{flex:1}
  .list{max-height:300px;overflow:auto;border:1px solid #2f6cff33;border-radius:10px;padding:10px;background:#0b142e}
  .item{padding:8px;border-bottom:1px dashed #2f6cff33}
  .msg{padding:8px;margin-bottom:6px;border:1px solid #2f6cff33;border-radius:8px;background:#0b142e}
  .pill{display:inline-block;padding:2px 8px;background:#19356e;border-radius:999px;font-size:.8rem;margin-left:8px}
  .ok{background:#1e7b45}
  .warn{background:#7b3d1e}
  .toast{position:fixed;top:16px;right:16px;background:#081025;border:1px solid #2f6cff;color:#e9f6ff;padding:10px 14px;border-radius:8px;opacity:0;transform:translateY(-8px);transition:.3s;z-index:1000}
  .toast.show{opacity:1;transform:none}
  .hidden{display:none}
</style>
</head>
<body>
<div class="toast" id="toast"></div>

<h1>Panel de Administraci√≥n</h1>
<p style="opacity:.8;margin-top:0">Control total: usuarios, monedas, chat y recaudaci√≥n.</p>

<!-- LOGIN TOKEN -->
<div class="card" id="cardLogin">
  <h3>Ingreso de Administrador</h3>
  <div class="row">
    <input type="password" id="adminToken" placeholder="Ingresar token secreto" />
    <button id="btnLogin">Entrar</button>
  </div>
  <p class="small" style="opacity:.8;margin:6px 0 0">El token no es visible en el sitio de jugadores.</p>
</div>

<div id="app" class="hidden">

  <div class="grid">
    <!-- USUARIOS -->
    <div class="card">
      <h3>Usuarios</h3>
      <div class="row">
        <input type="text" id="buscar" placeholder="Buscar por alias‚Ä¶" />
        <button id="btnReload">Actualizar</button>
      </div>
      <div class="list" id="listaUsuarios"></div>
      <div class="row">
        <input type="text" id="uid" placeholder="ID seleccionado" readonly />
        <input type="text" id="ualias" placeholder="Alias seleccionado" readonly />
      </div>
      <div class="row">
        <input type="number" id="cant" placeholder="Cantidad de monedas" />
        <button id="btnCargar">Cargar monedas</button>
        <button id="btnRestar">Restar monedas</button>
      </div>
      <div class="row">
        <button id="btnBloquear">‚õî Bloquear usuario</button>
        <button id="btnEliminar" style="background:#b02424">üóëÔ∏è Eliminar usuario</button>
      </div>
    </div>

    <!-- CHAT / MODERACI√ìN -->
    <div class="card">
      <h3>Chat (moderaci√≥n)</h3>
      <div class="row">
        <input type="text" id="aliasAdminChat" placeholder="Alias visible (ej: Staff Estadio)" />
        <input type="text" id="txtAdminMsg" placeholder="Mensaje a enviar‚Ä¶" />
        <button id="btnAdminEnviar">Enviar</button>
      </div>
      <div class="list" id="listaChat"></div>
      <div class="row">
        <button id="btnBorrarChat" style="background:#b02424">üßπ Borrar chat completo</button>
      </div>
    </div>

    <!-- RECAUDACI√ìN -->
    <div class="card">
      <h3>Recaudaci√≥n</h3>
      <div id="recaudacion" class="msg">Total recaudado: $0</div>
      <p style="opacity:.8">Se calcula como <strong>apuestas + compras - cargas</strong>, seg√∫n la vista <code>admin_recaudacion</code>.</p>
      <button id="btnRefrescarRecauda">Refrescar</button>
    </div>

    <!-- DETALLE USUARIO -->
    <div class="card">
      <h3>Detalle / Acciones r√°pidas</h3>
      <div id="detalle" class="msg">Seleccion√° un usuario para ver info.</div>
    </div>
  </div>

</div>

<script>
/* ====== CONFIG ====== */
const SUPABASE_URL = "https://aqkqbtunbyifbfrvkpxv.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFxa3FidHVuYnlpZmJmcnZrcHh2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyOTg5NDgsImV4cCI6MjA3MDg3NDk0OH0.Xqtii5yiIO6tFOzzqza70ZA7N1KmbcTIkoNtV5YCVDY";
const ADMIN_TOKEN = "20250819802006";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ====== UI ====== */
const $ = (id)=>document.getElementById(id);
const toast=(t)=>{const el=$("toast"); el.textContent=t; el.classList.add("show"); setTimeout(()=>el.classList.remove("show"),2000);};

/* ====== LOGIN ====== */
$("btnLogin").onclick = ()=>{
  const t = $("adminToken").value.trim();
  if(t===ADMIN_TOKEN){ $("cardLogin").classList.add("hidden"); $("app").classList.remove("hidden"); init(); toast("Bienvenido, Admin"); }
  else toast("Token incorrecto");
};

/* ====== ESTADO ====== */
let users = [];
let selected = null;

/* ====== INIT ====== */
async function init(){
  await cargarUsuarios();
  await cargarChat();
  await cargarRecaudacion();
  suscribirChat();
  setInterval(cargarRecaudacion, 5000);
}

/* ====== USUARIOS ====== */
$("btnReload").onclick = cargarUsuarios;
$("buscar").addEventListener("input", pintarUsuarios);

async function cargarUsuarios(){
  const { data, error } = await supabase.from("users").select("*").order("created_at",{ascending:false});
  if(error){ toast("Error cargando usuarios"); return; }
  users = data || [];
  pintarUsuarios();
}
function pintarUsuarios(){
  const q = $("buscar").value?.toLowerCase()||"";
  const cont = $("listaUsuarios"); cont.innerHTML="";
  users.filter(u=>u.alias.toLowerCase().includes(q)).forEach(u=>{
    const div=document.createElement("div");
    div.className="item";
    div.innerHTML = `<strong>${u.alias}</strong> <span class="pill">$${u.coins||0}</span> ${u.blocked?'<span class="pill warn">bloqueado</span>':''}<br><span style="opacity:.7;font-size:.9rem">${u.id}</span>`;
    div.onclick=()=>selectUser(u);
    cont.appendChild(div);
  });
}
function selectUser(u){
  selected = u;
  $("uid").value = u.id;
  $("ualias").value = u.alias;
  $("detalle").innerHTML = `Alias: <strong>${u.alias}</strong><br>Coins: <strong>$${u.coins||0}</strong><br>Bloqueado: <strong>${u.blocked?'S√≠':'No'}</strong>`;
}

$("btnCargar").onclick = async ()=>{
  if(!selected) return toast("Seleccion√° usuario");
  const cant = parseInt($("cant").value,10);
  if(isNaN(cant)||cant<=0) return toast("Cantidad inv√°lida");
  const { error } = await supabase.rpc("admin_cargar_monedas",{ uid: selected.id, cantidad: cant });
  if(error) return toast("Error al cargar");
  // refrescar saldo
  await cargarUsuarios();
  selected = users.find(u=>u.id===selected.id);
  selectUser(selected);
  toast("Monedas cargadas");
};
$("btnRestar").onclick = async ()=>{
  if(!selected) return toast("Seleccion√° usuario");
  const cant = parseInt($("cant").value,10);
  if(isNaN(cant)||cant<=0) return toast("Cantidad inv√°lida");
  const { error } = await supabase.rpc("admin_restar_monedas",{ uid: selected.id, cantidad: cant });
  if(error) return toast("Error al restar");
  await cargarUsuarios();
  selected = users.find(u=>u.id===selected.id);
  selectUser(selected);
  toast("Monedas restadas");
};
$("btnBloquear").onclick = async ()=>{
  if(!selected) return toast("Seleccion√° usuario");
  const { error } = await supabase.rpc("admin_bloquear_usuario",{ uid: selected.id });
  if(error) return toast("Error al bloquear");
  await cargarUsuarios();
  selected = users.find(u=>u.id===selected.id);
  selectUser(selected);
  toast("Usuario bloqueado");
};
$("btnEliminar").onclick = async ()=>{
  if(!selected) return toast("Seleccion√° usuario");
  if(!confirm(`Eliminar usuario ${selected.alias}?`)) return;
  const { error } = await supabase.rpc("admin_eliminar_usuario",{ uid: selected.id });
  if(error) return toast("Error al eliminar");
  await cargarUsuarios();
  selected=null; $("uid").value=""; $("ualias").value=""; $("detalle").innerHTML="Usuario eliminado.";
  toast("Usuario eliminado");
};

/* ====== CHAT ====== */
async function cargarChat(){
  const { data, error } = await supabase.from("messages").select("id,alias,message,created_at").order("created_at",{ascending:false}).limit(100);
  if(error){ toast("Error cargando chat"); return; }
  pintarChat((data||[]));
}
function pintarChat(rows){
  const cont=$("listaChat"); cont.innerHTML="";
  rows.forEach(r=>{
    const d=document.createElement("div");
    d.className="msg";
    d.innerHTML = `<strong>${r.alias}</strong> <span style="opacity:.7;font-size:.85rem">${new Date(r.created_at).toLocaleString()}</span>
                   <div style="margin-top:6px">${r.message}</div>
                   <div class="row" style="margin-top:8px"><button data-id="${r.id}" class="btnDel">Eliminar</button></div>`;
    cont.appendChild(d);
  });
  // bind deletes
  cont.querySelectorAll(".btnDel").forEach(b=>{
    b.onclick = async ()=>{
      const id = b.getAttribute("data-id");
      await supabase.from("messages").delete().eq("id", id);
      toast("Mensaje eliminado");
      cargarChat();
    };
  });
}
function suscribirChat(){
  supabase.channel("admin:chat")
    .on('postgres_changes',{event:'INSERT',schema:'public',table:'messages'}, payload=>{
      cargarChat();
    })
    .on('postgres_changes',{event:'DELETE',schema:'public',table:'messages'}, payload=>{
      cargarChat();
    })
    .subscribe();
}
$("btnAdminEnviar").onclick = async ()=>{
  const alias = $("aliasAdminChat").value.trim() || "Staff Estadio";
  const msg = $("txtAdminMsg").value.trim();
  if(!msg) return;
  $("txtAdminMsg").value="";
  await supabase.from("messages").insert([{ user_id: null, alias, message: msg }]);
  toast("Mensaje enviado");
};
$("btnBorrarChat").onclick = async ()=>{
  if(!confirm("¬øEliminar TODO el chat?")) return;
  await supabase.from("messages").delete().neq("id","00000000-0000-0000-0000-000000000000");
  toast("Chat borrado");
  cargarChat();
};

/* ====== RECAUDACI√ìN ====== */
$("btnRefrescarRecauda").onclick = cargarRecaudacion;
async function cargarRecaudacion(){
  const { data, error } = await supabase.from("admin_recaudacion").select("*").single();
  if(error){ $("recaudacion").textContent="Error al cargar recaudaci√≥n"; return; }
  const total = (data?.total_recaudado)||0;
  $("recaudacion").textContent = `Total recaudado: $${total}`;
}
</script>
</body>
</html>
