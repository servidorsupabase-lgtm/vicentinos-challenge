<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Vicentinos Challenge - Trivia Rugby</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f4; }
    h1 { color: #333; text-align:center; }
    .game, .chat { margin: 20px auto; padding: 15px; background: #fff; border-radius: 5px; max-width: 600px; }
    .messages { max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background: #fafafa; }
    .message { margin: 5px 0; }
    .question { font-size: 18px; margin: 15px 0; }
    .options button { display:block; width:100%; margin:5px 0; padding:10px; font-size:16px; }
    #timerBar { height: 20px; background: #4caf50; width: 100%; transition: width 1s linear; border-radius: 5px; }
    #rugbyBall { width:20px; height:20px; background:url('https://cdn-icons-png.flaticon.com/512/146/146701.png') no-repeat center/contain; float:right; }
    .confetti { position: fixed; width: 10px; height: 10px; background: gold; animation: fall 3s linear forwards; }
    @keyframes fall { to { transform: translateY(100vh) rotate(360deg); opacity:0; } }
    .shake { animation: shake 0.5s; }
    @keyframes shake {
      0% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      50% { transform: translateX(5px); }
      75% { transform: translateX(-5px); }
      100% { transform: translateX(0); }
    }
  </style>
</head>
<body>
  <h1>Vicentinos Challenge üèâ</h1>

  <!-- Juego -->
  <div class="game">
    <h2>Trivia de Rugby</h2>
    <p><b>Nivel:</b> <span id="level">1</span> / 15</p>
    <p><b>Monedas:</b> <span id="coins">1500</span></p>
    <p><b>Apuesta:</b> <input type="number" id="bet" min="500" step="100" value="500"> </p>
    <button onclick="startQuestion()">Apostar y jugar</button>
    <div id="questionBox" style="display:none;">
      <p id="question" class="question"></p>
      <div class="options" id="options"></div>
      <div id="timerContainer"><div id="timerBar"><div id="rugbyBall"></div></div></div>
    </div>
  </div>

  <!-- Chat -->
  <div class="chat">
    <h2>Chat en vivo üí¨</h2>
    <div class="messages" id="messages"></div>
    <input type="text" id="chatInput" placeholder="Escribe un mensaje..." />
    <button onclick="sendMessage()">Enviar</button>
  </div>

  <!-- Audios -->
  <audio id="soundCorrect" src="https://www.fesliyanstudios.com/play-mp3/387"></audio>
  <audio id="soundWrong" src="https://www.fesliyanstudios.com/play-mp3/438"></audio>
  <audio id="soundCrowd" src="https://www.fesliyanstudios.com/play-mp3/6486"></audio>

  <script>
    // üîë Claves Supabase
    const SUPABASE_URL = "https://aqkqbtunbyifbfrvkpxv.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFxa3FidHVuYnlpZmJmcnZrcHh2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyOTg5NDgsImV4cCI6MjA3MDg3NDk0OH0.Xqtii5yiIO6tFOzzqza70ZA7N1KmbcTIkoNtV5YCVDY";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let coins = 1500;
    let level = 1;
    let usedQuestions = [];
    let timer, timeLeft;
    let trainingQuestions = 3;

    // Preguntas
    const questions = [
      // ‚úÖ F√°ciles (niveles 1-5)
      {q:"¬øCu√°ntos jugadores hay en un equipo de rugby union?", options:["11","13","15"], a:2, lvl:1},
      {q:"¬øCu√°ntos puntos vale un try?", options:["3","5","7"], a:1, lvl:1},
      {q:"¬øC√≥mo se llama el m√°ximo torneo entre selecciones del hemisferio sur?", options:["Rugby Championship","6 Naciones","Tri Nations"], a:0, lvl:2},
      {q:"¬øCu√°nto dura cada tiempo en un partido oficial?", options:["30 min","40 min","45 min"], a:1, lvl:2},
      {q:"¬øQu√© pa√≠s gan√≥ la primera Copa del Mundo en 1987?", options:["Nueva Zelanda","Inglaterra","Sud√°frica"], a:0, lvl:3},
      // ‚úÖ Medias (niveles 6-10)
      {q:"¬øQu√© jugador es conocido como 'La Bestia'?", options:["Tendai Mtawarira","Richie McCaw","Sergio Parisse"], a:0, lvl:6},
      {q:"¬øCu√°l es la regla del 'knock-on'?", options:["Patear hacia delante","Pasar hacia delante","Dejar caer el bal√≥n hacia adelante"], a:2, lvl:6},
      {q:"¬øCu√°ntos puntos vale un drop goal?", options:["2","3","4"], a:1, lvl:7},
      {q:"¬øQu√© selecci√≥n es llamada 'Los Pumas'?", options:["Argentina","Uruguay","Chile"], a:0, lvl:7},
      {q:"¬øQu√© capit√°n levant√≥ la copa para Sud√°frica en 1995?", options:["Francois Pienaar","John Smit","Siya Kolisi"], a:0, lvl:8},
      // ‚úÖ Dif√≠ciles (niveles 11-13)
      {q:"¬øEn qu√© a√±o se introdujo la tarjeta amarilla en el rugby?", options:["1995","2000","2003"], a:2, lvl:11},
      {q:"¬øCu√°l es la distancia m√≠nima de un line-out?", options:["2 metros","5 metros","10 metros"], a:1, lvl:12},
      {q:"¬øQu√© jugador ostenta el r√©cord de m√°s tries en Copas del Mundo?", options:["Jonah Lomu","Bryan Habana","Daisuke Ohata"], a:1, lvl:13},
      // ‚úÖ Casi imposibles (niveles 14-15)
      {q:"¬øQui√©n fue el √°rbitro de la final del Mundial 1991?", options:["Derek Bevan","Ed Morrison","Paddy O'Brien"], a:0, lvl:14},
      {q:"¬øCu√°ntos espectadores asistieron a la final del Mundial 2015 en Twickenham?", options:["80,125","82,245","83,312"], a:1, lvl:15}
    ];

    // Funci√≥n para elegir pregunta aleatoria por nivel
    function getQuestion(lvl){
      let pool = questions.filter(q => q.lvl <= lvl && !usedQuestions.includes(q.q));
      if(pool.length === 0) return null;
      let q = pool[Math.floor(Math.random()*pool.length)];
      usedQuestions.push(q.q);
      return q;
    }

    function startQuestion(){
      const bet = parseInt(document.getElementById("bet").value);
      if(bet < 500){ alert("La apuesta m√≠nima es 500 monedas."); return; }
      if(bet > coins){ alert("No tienes suficientes monedas."); return; }

      if(level > 15){ alert("Juego completado üéâ"); return; }

      if(trainingQuestions <= 0 && coins < 500){
        alert("‚ö†Ô∏è Te quedaste sin monedas. Compra m√°s para seguir jugando.");
        return;
      }

      currentQ = getQuestion(level);
      if(!currentQ){ alert("No hay m√°s preguntas disponibles."); return; }

      document.getElementById("questionBox").style.display="block";
      document.getElementById("question").textContent=currentQ.q;
      let optDiv=document.getElementById("options");
      optDiv.innerHTML="";
      currentQ.options.forEach((opt,i)=>{
        let btn=document.createElement("button");
        btn.textContent=opt;
        btn.onclick=()=>answer(i,bet);
        optDiv.appendChild(btn);
      });

      startTimer();
    }

    function startTimer(){
      clearInterval(timer);
      timeLeft=20;
      let bar=document.getElementById("timerBar");
      bar.style.width="100%";
      timer=setInterval(()=>{
        timeLeft--;
        bar.style.width=(timeLeft/20*100)+"%";
        if(timeLeft<=0){
          clearInterval(timer);
          answer(-1,parseInt(document.getElementById("bet").value)); // tiempo agotado
        }
      },1000);
    }

    function answer(choice,bet){
      clearInterval(timer);
      if(choice===currentQ.a){
        coins+=bet;
        level++;
        document.getElementById("coins").textContent=coins;
        document.getElementById("level").textContent=level;
        document.getElementById("soundCorrect").play();
        document.getElementById("soundCrowd").play();
        launchConfetti();
        alert("‚úÖ Correcto! Ganaste "+bet+" monedas.");
      } else {
        coins-=bet;
        if(trainingQuestions>0) trainingQuestions--;
        document.getElementById("coins").textContent=coins;
        document.getElementById("soundWrong").play();
        document.querySelector(".game").classList.add("shake");
        setTimeout(()=>document.querySelector(".game").classList.remove("shake"),500);
        alert("‚ùå Incorrecto. Perdiste "+bet+" monedas.");
      }
      document.getElementById("questionBox").style.display="none";
    }

    function launchConfetti(){
      for(let i=0;i<30;i++){
        let conf=document.createElement("div");
        conf.className="confetti";
        conf.style.left=Math.random()*100+"vw";
        conf.style.background=["gold","red","green","blue"][Math.floor(Math.random()*4)];
        conf.style.animationDuration=(2+Math.random()*3)+"s";
        document.body.appendChild(conf);
        setTimeout(()=>conf.remove(),3000);
      }
    }

    // Chat
    async function loadMessages() {
      let { data } = await supabase.from("messages").select("*").order("created_at", { ascending: true });
      const msgDiv = document.getElementById("messages");
      msgDiv.innerHTML = "";
      data.forEach(m => {
        msgDiv.innerHTML += `<div class="message"><b>${m.username}:</b> ${m.content}</div>`;
      });
      msgDiv.scrollTop = msgDiv.scrollHeight;
    }

    async function sendMessage() {
      const input = document.getElementById("chatInput");
      if (input.value.trim() === "") return;
      await supabase.from("messages").insert([{ username: "Jugador", content: input.value }]);
      input.value = "";
    }

    // Realtime para chat
    supabase.channel('chat-room')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'messages' }, payload => {
        loadMessages();
      })
      .subscribe();

    // Inicializaci√≥n
    loadMessages();
  </script>
</body>
</html>
