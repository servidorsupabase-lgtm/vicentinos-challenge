<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Vicentinos Challenge</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Fuente y estilo -->
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Fredoka One', cursive;
      margin: 0;
      background: linear-gradient(135deg, #001f54, #004aad, #00c6ff);
      color: white;
      text-align: center;
    }
    h1 {
      font-size: 2.5rem;
      margin: 20px 0;
      text-shadow: 2px 2px 5px black;
    }
    .container {
      display: none;
      padding: 20px;
    }
    input, button {
      padding: 10px;
      margin: 5px;
      border: none;
      border-radius: 5px;
      font-size: 1rem;
    }
    input {
      width: 200px;
    }
    button {
      background: gold;
      color: black;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    button:hover {
      transform: scale(1.1);
      box-shadow: 0 0 20px rgba(255, 215, 0, 1);
    }
    .login, .admin, .game, .chat, .ranking {
      background: rgba(0,0,0,0.6);
      padding: 20px;
      border-radius: 10px;
      margin: 15px auto;
      max-width: 500px;
    }
    #messages {
      height: 200px;
      overflow-y: auto;
      border: 2px solid gold;
      padding: 10px;
      text-align: left;
      background: rgba(0,0,0,0.3);
    }
    .msg { margin: 5px 0; padding: 5px; border-radius: 8px; }
    .msg.user { background: #004aad; }
    .msg.other { background: #0066cc; }
    #rankingList {
      list-style: none;
      padding: 0;
    }
    #rankingList li {
      background: rgba(255,255,255,0.1);
      margin: 5px;
      padding: 10px;
      border-radius: 5px;
    }
    .notification {
      position: fixed;
      top: 10px;
      right: 10px;
      background: gold;
      color: black;
      padding: 10px 20px;
      border-radius: 5px;
      font-weight: bold;
      animation: fadeout 3s forwards;
    }
    @keyframes fadeout {
      0% { opacity: 1; }
      80% { opacity: 1; }
      100% { opacity: 0; }
    }
  </style>
</head>
<body>
  <h1>üèâ Vicentinos Challenge üèâ</h1>

  <!-- Login -->
  <div class="container login" id="loginContainer" style="display:block;">
    <h2>Iniciar Sesi√≥n</h2>
    <input type="text" id="username" placeholder="Nombre de usuario">
    <button onclick="loginUser()">Entrar</button>
    <h3>Admin</h3>
    <input type="password" id="adminToken" placeholder="Token admin">
    <button onclick="loginAdmin()">Entrar Admin</button>
  </div>

  <!-- Juego -->
  <div class="container game" id="gameContainer">
    <h2 id="questionTitle">Pregunta</h2>
    <p id="questionText"></p>
    <button id="optionA" onclick="answer('A')"></button>
    <button id="optionB" onclick="answer('B')"></button>
    <button id="optionC" onclick="answer('C')"></button>
    <p id="levelInfo"></p>
  </div>

  <!-- Chat -->
  <div class="container chat" id="chatContainer">
    <h2>Chat en Vivo</h2>
    <div id="messages"></div>
    <input type="text" id="chatInput" placeholder="Escribe un mensaje">
    <button onclick="sendMessage()">Enviar</button>
  </div>

  <!-- Ranking -->
  <div class="container ranking" id="rankingContainer">
    <h2>üèÜ Ranking</h2>
    <ul id="rankingList"></ul>
    <button onclick="buyCoins()">üí∞ Comprar Pack de Monedas</button>
  </div>

  <!-- Panel Admin -->
  <div class="container admin" id="adminContainer">
    <h2>Panel Admin</h2>
    <input type="text" id="targetUser" placeholder="Usuario">
    <input type="number" id="coinAmount" placeholder="Cantidad monedas">
    <button onclick="addCoins()">Cargar</button>
    <button onclick="removeCoins()">Restar</button>
    <button onclick="blockUser()">Bloquear Usuario</button>
    <button onclick="deleteMessages()">Eliminar Mensajes</button>
    <button onclick="logout()">Cerrar Sesi√≥n</button>
  </div>

  <!-- Sonidos -->
  <audio id="soundCorrect" src="https://www.myinstants.com/media/sounds/correct-answer.mp3"></audio>
  <audio id="soundWrong" src="https://www.myinstants.com/media/sounds/wrong-answer-sound-effect.mp3"></audio>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const { createClient } = supabase;
    const supa = createClient(
      "https://aqkqbtunbyifbfrvkpxv.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFxa3FidHVuYnlpZmJmcnZrcHh2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyOTg5NDgsImV4cCI6MjA3MDg3NDk0OH0.Xqtii5yiIO6tFOzzqza70ZA7N1KmbcTIkoNtV5YCVDY"
    );

    let currentUser = null;
    let currentLevel = 1;
    let currentQuestion = null;

    function notify(msg) {
      const n = document.createElement("div");
      n.className = "notification";
      n.innerText = msg;
      document.body.appendChild(n);
      setTimeout(()=>n.remove(), 3000);
    }

    async function loginUser() {
      const username = document.getElementById("username").value.trim();
      if (!username) return notify("Ingresa un nombre");

      let { data, error } = await supa.from("users").select("*").eq("username", username).single();
      if (!data) {
        let { data: newUser } = await supa.from("users").insert({ username }).select().single();
        data = newUser;
      }
      if (data.blocked) return notify("Usuario bloqueado");

      currentUser = data;
      document.getElementById("loginContainer").style.display = "none";
      document.getElementById("gameContainer").style.display = "block";
      document.getElementById("chatContainer").style.display = "block";
      document.getElementById("rankingContainer").style.display = "block";
      loadQuestion();
      loadChat();
      loadRanking();
      notify("Bienvenido " + username);
    }

    async function loginAdmin() {
      const token = document.getElementById("adminToken").value.trim();
      if (token !== "20250819802006") return notify("Token inv√°lido");

      document.getElementById("loginContainer").style.display = "none";
      document.getElementById("adminContainer").style.display = "block";
      loadRanking();
    }

    async function loadQuestion() {
      let { data } = await supa.from("questions").select("*").eq("level", currentLevel);
      if (!data || !data.length) {
        notify("Ganaste! No hay m√°s preguntas");
        return;
      }
      currentQuestion = data[Math.floor(Math.random()*data.length)];
      document.getElementById("questionTitle").innerText = "Nivel " + currentQuestion.level;
      document.getElementById("questionText").innerText = currentQuestion.question;
      document.getElementById("optionA").innerText = currentQuestion.option_a;
      document.getElementById("optionB").innerText = currentQuestion.option_b;
      document.getElementById("optionC").innerText = currentQuestion.option_c;
      document.getElementById("levelInfo").innerText = "Pregunta de nivel " + currentQuestion.level;
    }

    async function answer(choice) {
      if (!currentQuestion) return;
      if (choice === currentQuestion.correct_option) {
        document.getElementById("soundCorrect").play();
        notify("¬°Correcto!");
        currentLevel++;
        await supa.from("users").update({ coins: currentUser.coins+5 }).eq("id", currentUser.id);
        currentUser.coins += 5;
        loadRanking();
      } else {
        document.getElementById("soundWrong").play();
        notify("Respuesta incorrecta");
      }
      loadQuestion();
    }

    async function loadChat() {
      let { data } = await supa.from("chat").select("*, users(username)").order("created_at",{ascending:true});
      const msgBox = document.getElementById("messages");
      msgBox.innerHTML = "";
      data.forEach(m=>{
        const div = document.createElement("div");
        div.className = "msg " + (m.user_id===currentUser.id?"user":"other");
        div.innerText = m.users.username + ": " + m.message;
        msgBox.appendChild(div);
      });
      msgBox.scrollTop = msgBox.scrollHeight;
    }

    async function sendMessage() {
      const txt = document.getElementById("chatInput").value.trim();
      if (!txt) return;
      await supa.from("chat").insert({ user_id: currentUser.id, message: txt });
      document.getElementById("chatInput").value = "";
      loadChat();
    }

    async function loadRanking() {
      let { data } = await supa.from("users").select("*").order("coins",{ascending:false}).limit(10);
      const ul = document.getElementById("rankingList");
      ul.innerHTML="";
      data.forEach(u=>{
        const li = document.createElement("li");
        li.innerText = u.username+" - "+u.coins+" monedas";
        ul.appendChild(li);
      });
    }

    async function buyCoins() {
      if (!currentUser) return;
      await supa.from("users").update({ coins: currentUser.coins+20 }).eq("id", currentUser.id);
      currentUser.coins += 20;
      notify("Pack comprado! +20 monedas");
      loadRanking();
    }

    // Panel Admin
    async function addCoins() {
      const user = document.getElementById("targetUser").value.trim();
      const amount = parseInt(document.getElementById("coinAmount").value);
      if (!user || isNaN(amount)) return notify("Completa los datos");
      await supa.rpc("exec",`update users set coins = coins + ${amount} where username='${user}'`);
      await supa.from("users").update({ coins: supa.sql`coins + ${amount}` }).eq("username", user);
      notify("Monedas agregadas");
      loadRanking();
    }
    async function removeCoins() {
      const user = document.getElementById("targetUser").value.trim();
      const amount = parseInt(document.getElementById("coinAmount").value);
      if (!user || isNaN(amount)) return notify("Completa los datos");
      await supa.rpc("exec",`update users set coins = coins - ${amount} where username='${user}'`);
      await supa.from("users").update({ coins: supa.sql`coins - ${amount}` }).eq("username", user);
      notify("Monedas restadas");
      loadRanking();
    }
    async function blockUser() {
      const user = document.getElementById("targetUser").value.trim();
      await supa.from("users").update({ blocked:true }).eq("username",user);
      notify("Usuario bloqueado");
    }
    async function deleteMessages() {
      await supa.from("chat").delete().neq("id",0);
      notify("Mensajes borrados");
      loadChat();
    }
    function logout() {
      location.reload();
    }
  </script>
</body>
</html>
