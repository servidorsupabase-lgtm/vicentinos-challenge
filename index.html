<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Vicentinos Challenge 🏉</title>

<!-- Supabase -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<!-- Fuentes e íconos -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#031d3b;      --panel:#08162a;   --accent:#00ff7b;
    --accent2:#00d1ff; --text:#e7ffe7;   --warn:#ff4d4d;
    --gold:#ffdf00;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{
    background: radial-gradient(1200px 600px at 50% -200px, #0b3b75 0%, var(--bg) 60%, #00132a 100%);
    color:var(--text); font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;
    min-height:100vh; display:flex; flex-direction:column; align-items:center; overflow-x:hidden;
  }

  /* Banner */
  .banner{width:100%; height:180px; position:relative; border-bottom:3px solid var(--accent)}
  .banner::before{
    content:""; position:absolute; inset:0;
    background:url("https://i.postimg.cc/nVvFmXQR/wp2896798.jpg") center/cover no-repeat;
    filter:brightness(.6);
  }
  .banner .title{
    position:relative; z-index:2; height:100%;
    display:flex; align-items:center; justify-content:center; text-align:center;
    font-weight:800; letter-spacing:.5px; text-shadow:0 0 18px rgba(0,255,140,.5);
    font-size:clamp(24px,4vw,38px);
  }

  /* Contenedores */
  .wrap{width:min(100%,980px); padding:18px}
  .card{
    background:linear-gradient(180deg, rgba(5,22,40,.9), rgba(5,22,40,.75));
    border:1px solid rgba(0,255,123,.28);
    border-radius:14px; padding:16px; box-shadow:0 12px 30px rgba(0,0,0,.35);
    backdrop-filter:blur(6px); margin:12px 0;
  }
  h2{font-weight:800; font-size:1.15rem; margin-bottom:10px; color:var(--accent)}
  p.small{opacity:.9; font-size:.95rem}

  /* Inputs / Buttons */
  input,button{
    border-radius:10px; border:none; outline:0; padding:12px 14px; font-size:1rem; font-weight:600;
  }
  input{
    background:#0a1b31; color:var(--text); border:1px solid rgba(255,255,255,.12); width:100%;
  }
  .btn{
    background:linear-gradient(90deg, var(--accent) 0%, #00ffa0 100%); color:#001a11;
    cursor:pointer; transition:.2s; box-shadow:0 8px 16px rgba(0,255,140,.25); width:100%;
  }
  .btn:hover{transform:translateY(-1px); box-shadow:0 10px 18px rgba(0,255,140,.32)}
  .btn.sec{background:#113257; color:#e9feff; border:1px solid rgba(0,209,255,.4)}
  .btn.warn{background:var(--warn); color:#150202}
  .btn.gold{background:linear-gradient(90deg,#ffd400,#ffdf00,#ffe766); color:#2a1d00}

  .row{display:flex; gap:10px; flex-wrap:wrap}
  .row > *{flex:1}

  /* Toast */
  .toast{position:fixed; top:16px; right:16px; padding:12px 14px; border-radius:10px;
    background:#0b1424; border:1px solid rgba(0,255,123,.35); color:var(--text);
    box-shadow:0 10px 24px rgba(0,0,0,.35); transform:translateY(-16px); opacity:0;
    transition:.25s; z-index:9999; font-weight:700
  }
  .toast.show{transform:none; opacity:1}

  /* Juego */
  .game-top{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px}
  .badge{background:#0b203e; border:1px solid rgba(0,255,123,.25); border-radius:10px; padding:8px 10px; text-align:center}
  .badge strong{color:var(--gold)}
  .timer{height:18px; background:#0a1b31; border:1px solid rgba(0,255,123,.3); border-radius:12px; overflow:hidden; position:relative}
  .timebar{height:100%; width:100%; background:linear-gradient(90deg,#00ffa0,#00d1ff)}
  .ball{position:absolute; top:-8px; left:0; width:30px; height:30px; background:url('https://cdn-icons-png.flaticon.com/512/2243/2243887.png') center/contain no-repeat; filter:drop-shadow(0 0 6px rgba(0,255,140,.7))}
  .question{margin:12px 0; font-size:1.05rem}
  .opts{display:grid; grid-template-columns:1fr; gap:10px}
  .opt{background:#0b203e; color:#eaffff; border:1px solid rgba(0,255,123,.25); text-align:left}
  .opt:hover{outline:2px solid rgba(0,255,123,.45)}
  @media(min-width:740px){ .opts{grid-template-columns:1fr 1fr} }

  /* Chat / Ranking */
  .panel{max-height:340px; overflow:auto; border-radius:10px; border:1px dashed rgba(0,255,123,.25); padding:10px; background:#061327}
  .msg{display:flex; gap:8px; padding:8px; margin:6px 0; background:rgba(0,255,123,.06); border-left:3px solid var(--accent); border-radius:6px}
  .msg .who{font-weight:800; color:#8bffda}
  .rank .item{padding:8px; border-bottom:1px dashed rgba(255,255,255,.12)}
  .rank .item:first-child{background:rgba(255,223,0,.1); border-left:3px solid var(--gold)}

  /* Grid inferior */
  .grid{display:grid; gap:12px}
  @media(min-width:900px){ .grid{grid-template-columns:1.15fr .85fr} }

  /* Admin */
  .admin-top{display:flex; justify-content:space-between; align-items:center; gap:8px}
  .admin-panel{display:none; margin-top:10px}
  .admin-panel.show{display:block}
  .kpi{display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-top:8px}
  .kpi .badge{background:#101f39}

  /* Animaciones feedback */
  .confetti{pointer-events:none; position:fixed; inset:0; overflow:hidden; z-index:9998}
  .confetti i{position:absolute; width:8px; height:14px; will-change:transform}
  .shake{animation:shake .4s linear}
  @keyframes shake{ 0%{transform:translateX(0)} 25%{transform:translateX(-6px)} 50%{transform:translateX(6px)} 75%{transform:translateX(-6px)} 100%{transform:translateX(0)} }
</style>
</head>
<body>
  <div class="banner"><div class="title">Vicentinos Challenge 🏉🔥</div></div>
  <div class="wrap">

    <!-- LOGIN -->
    <div class="card" id="loginCard">
      <h2>🎮 Tu nombre de guerra</h2>
      <p class="small">Preparate para ir por los puntos. Si el alias existe retomás tu progreso.</p>
      <div class="row">
        <input id="alias" maxlength="22" placeholder="Ej: Pumita10" />
        <button class="btn" id="btnLogin">¡JUGAR!</button>
      </div>

      <div class="admin-top" style="margin-top:10px;">
        <button class="btn sec" id="btnAdminLogin">🔒 Admin Login</button>
        <div style="flex:1; display:none" id="adminKeyBox">
          <div class="row">
            <input id="adminKey" placeholder="Clave especial" />
            <button class="btn gold" id="btnAdminGo">Entrar</button>
          </div>
          <p class="small" style="opacity:.7">* Si la clave es correcta, verás el panel de admin dentro del juego.</p>
        </div>
      </div>
    </div>

    <!-- JUEGO -->
    <div class="card" id="gameCard" style="display:none;">
      <h2>🎯 Trivia Rugby — <span id="levelTxt">Nivel 1</span></h2>

      <div class="game-top">
        <div class="badge">Jugador: <strong id="who"></strong></div>
        <div class="badge">Monedas: <strong id="coins">0</strong></div>
        <div class="badge">Progreso: <strong id="progress">0/5</strong></div>
      </div>

      <!-- Timer -->
      <div class="timer" style="margin:12px 0;">
        <div class="timebar" id="timebar"></div>
        <div class="ball" id="ball"></div>
      </div>

      <!-- Apuesta -->
      <div id="betStage" class="card" style="padding:12px; margin:10px 0;">
        <h2>💸 Apuesta antes de ver la pregunta</h2>
        <p class="small">Mínimo $500. Si acertás, ganás lo apostado. Si fallás o se acaba el tiempo, lo perdés.</p>
        <div class="row" style="margin-top:6px;">
          <input type="number" id="bet" min="500" step="100" value="500" />
          <button class="btn" id="btnStartQ">Jugar pregunta</button>
        </div>
      </div>

      <!-- Pregunta -->
      <div id="qStage" style="display:none;">
        <div class="question" id="qText">...</div>
        <div class="opts" id="qOpts"></div>
      </div>

      <!-- Entrenamiento aviso -->
      <div class="card" id="trainInfo" style="display:none; margin-top:10px;">
        <h2>🎓 Entrenamiento completado</h2>
        <p class="small">Para seguir jugando necesitás monedas. Comprá un pack abajo o pedile al admin que te acredite.</p>
      </div>
    </div>

    <!-- GRID: Chat / Ranking / Tienda -->
    <div class="grid">
      <!-- Chat -->
      <div class="card">
        <div class="admin-top">
          <h2>💬 Chat del Estadio</h2>
          <div id="adminInlineTools" style="display:none;">
            <button class="btn warn" id="btnClearChat" title="Borrar todos los mensajes">🧹 Borrar chat</button>
          </div>
        </div>
        <div class="panel" id="chatBox"></div>
        <div class="row" style="margin-top:8px;">
          <input id="chatInput" placeholder="Escribí algo..." />
          <button class="btn sec" id="btnSendMsg">Enviar</button>
        </div>
      </div>

      <!-- Ranking + Tienda -->
      <div class="card">
        <h2>🏆 Ranking</h2>
        <div class="panel rank" id="rankBox"></div>
        <div class="card" style="margin-top:12px;">
          <h2>🛒 Tienda de Monedas</h2>
          <p class="small">Serás redirigido a Mercado Pago. Luego compartí el comprobante por chat y el admin acreditará a tu alias.</p>
          <button class="btn gold" data-url="https://mpago.la/16CyPeY" data-amount="2000">Comprar $2.000 → 2.000 monedas</button>
          <button class="btn gold" data-url="https://mpago.la/1TTVVcV" data-amount="5000" style="margin-top:8px;">Comprar $5.000 → 5.000 monedas</button>
          <button class="btn gold" data-url="https://mpago.la/2HR6fjA" data-amount="10000" style="margin-top:8px;">Comprar $10.000 → 10.000 monedas</button>
        </div>
      </div>
    </div>

    <!-- Panel Admin (inline) -->
    <div class="card admin-panel" id="adminPanel">
      <div class="admin-top">
        <h2>🛠️ Panel Admin</h2>
        <div class="kpi" style="flex:1;">
          <div class="badge">Usuarios: <strong id="kUsers">—</strong></div>
          <div class="badge">Mensajes: <strong id="kMsgs">—</strong></div>
          <div class="badge">Top Monedas: <strong id="kTop">—</strong></div>
        </div>
      </div>
      <div class="row" style="margin-top:8px;">
        <input id="admUser" placeholder="username del jugador" />
        <input id="admAmount" type="number" step="100" value="1000" />
      </div>
      <div class="row" style="margin-top:8px;">
        <button class="btn" id="btnAddCoins">Agregar monedas</button>
        <button class="btn warn" id="btnDelUser">Eliminar usuario</button>
      </div>
      <p class="small" style="opacity:.75; margin-top:8px;">* Los cambios impactan en tiempo real (ranking/chat).</p>
    </div>

  </div>

  <!-- Toast + Confetti -->
  <div id="toast" class="toast"></div>
  <div id="confetti" class="confetti"></div>

  <!-- Sonidos -->
  <audio id="sStart" src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-opening-2034.mp3"></audio>
  <audio id="sBet"   src="https://assets.mixkit.co/sfx/preview/mixkit-coin-drop-384.mp3"></audio>
  <audio id="sGood"  src="https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3"></audio>
  <audio id="sBad"   src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-946.mp3"></audio>
  <audio id="sChat"  src="https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-2574.mp3"></audio>
  <audio id="sCrowd" src="https://cdn.pixabay.com/download/audio/2021/09/16/audio_2f1fb0e6b6.mp3?filename=applause-1-199996.mp3"></audio>

<script>
/* ===========================
   CONFIG SUPABASE
=========================== */
const SUPABASE_URL = "https://aqkqbtunbyifbfrvkpxv.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFxa3FidHVuYnlpZmJmcnZrcHh2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyOTg5NDgsImV4cCI6MjA3MDg3NDk0OH0.Xqtii5yiIO6tFOzzqza70ZA7N1KmbcTIkoNtV5YCVDY";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ===========================
   UTIL / UI
=========================== */
const $ = (id)=>document.getElementById(id);
const toast=(t)=>{const el=$("toast"); el.textContent=t; el.classList.add("show"); setTimeout(()=>el.classList.remove("show"),2100);};
const play=(id)=>{const a=$(id); if(!a) return; a.currentTime=0; a.play().catch(()=>{});};
const confetti=()=>{
  const c=$("confetti"); c.innerHTML="";
  for(let i=0;i<80;i++){
    const e=document.createElement("i");
    e.style.left=Math.random()*100+"vw";
    e.style.top="-10px";
    e.style.opacity="0.9";
    e.style.background=`hsl(${Math.random()*360},100%,60%)`;
    e.style.transform=`rotate(${Math.random()*360}deg)`;
    e.animate([
      { transform:`translateY(0) rotate(0deg)`, opacity:1 },
      { transform:`translateY(${window.innerHeight+50}px) rotate(${360+Math.random()*360}deg)`, opacity:.9 }
    ],{duration:1200+Math.random()*1200, easing:"ease-in"});
    c.appendChild(e);
    setTimeout(()=>e.remove(),2400);
  }
};

/* ===========================
   ESTADO
=========================== */
let me=null;            // {id, username, coins}
let level=1;            // 1..15
let asked=new Set();    // ids de preguntas ya usadas
let round=[], answered=0;
let isAdmin=false;
let trainingLeft=3;     // 3 preguntas gratis
let timer=null, tLeft=20;

/* ===========================
   PREGUNTAS (70)
   Cada item: {id, q, opts:[...], c:indexCorrecto, hard:Boolean (niveles 14-15)}
=========================== */
const QUESTIONS = (()=> {
  const arr = [
    // Reglamentos / Básico
    {q:"¿Cuántos jugadores por equipo en rugby XV?",o:["13","15","7"],c:1},
    {q:"¿Cuántos puntos vale un try?",o:["3","5","7"],c:1},
    {q:"¿Cuántos puntos vale un penal convertido?",o:["3","2","5"],c:0},
    {q:"¿El pase debe ser…?",o:["Hacia atrás o lateral","Siempre hacia adelante","En globo hacia adelante"],c:0},
    {q:"¿Duración reglamentaria de un partido (sin alargue)?",o:["70 min","80 min","90 min"],c:1},
    {q:"¿Qué se marca por un tackle alto peligroso?",o:["Scrum","Penal y posible tarjeta","Line"],c:1},
    {q:"¿Un drop vale…?",o:["3 puntos","2 puntos","4 puntos"],c:0},
    {q:"¿Quién puede disputar el balón en un ruck?",o:["Solo backs","Cualquier jugador onside","Solo forwards"],c:1},
    {q:"¿Qué formación reanuda tras pase adelantado accidental?",o:["Scrum","Line","Reinicio de mitad"],c:0},
    {q:"¿Qué ocurre si la pelota sale por el lateral?",o:["Scrum","Line-out","Drop-out"],c:1},

    // Situaciones
    {q:"Tras un knock-on, ¿qué se otorga?",o:["Scrum al rival","Penal","Line"],c:0},
    {q:"¿Se puede patear directo al touch desde el campo propio dentro de 22?",o:["Sí","No","Solo si el árbitro autoriza"],c:0},
    {q:"¿Qué es un maul?",o:["Formación sobre el suelo","Portador de pie más compañeros empujando","Reanudación con golpe"],c:1},
    {q:"¿Qué jugador introduce la pelota en el scrum?",o:["Hooker","Medio scrum","Apertura"],c:1},
    {q:"Si el pateador convierte el try, ¿cuántos puntos suma en total?",o:["5","7","8"],c:1},
    {q:"¿Qué sanción por fuera de juego repetido?",o:["Scrum","Penal y posible tarjeta","Free kick"],c:1},
    {q:"¿Qué es un mark?",o:["Pedir recepción limpia en 22 propia","Pedir tiempo","Señalar al pateador"],c:0},
    {q:"¿Cuándo se pita fin del partido?",o:["Al llegar a 80 y con pelota muerta","Exactamente a los 80","Tras un penal"],c:0},
    {q:"En line-out, ¿quién lanza?",o:["Hooker","Medio scrum","Wing"],c:0},
    {q:"¿Se puede jugar rápido un line-out?",o:["Sí, con misma pelota y condiciones","No, nunca","Solo si rival no está formado"],c:0},

    // Historia / Jugadores
    {q:"¿Qué selección ganó el Mundial 2023?",o:["Francia","Sudáfrica","Nueva Zelanda"],c:1},
    {q:"¿País creador del rugby moderno?",o:["Inglaterra","Gales","Irlanda"],c:0},
    {q:"¿Quién fue ‘El Mago’ argentino?",o:["Hugo Porta","Felipe Contepomi","Juan Martín Hernández"],c:2},
    {q:"¿Apodo de Sudáfrica?",o:["Wallabies","Springboks","All Blacks"],c:1},
    {q:"¿Primer Mundial de Rugby?",o:["1987","1991","1979"],c:0},
    {q:"¿Qué selección hace el haka?",o:["Australia","Nueva Zelanda","Fiji"],c:1},
    {q:"¿Capitán de Los Pumas en 2007?",o:["Agustín Pichot","Nicolás Sánchez","Juan Leguizamón"],c:0},
    {q:"¿Mejor resultado de Pumas en un Mundial?",o:["3º puesto","Subcampeón","Campeón"],c:0},
    {q:"¿Qué selección se conoce como ‘Le Bleus’?",o:["Francia","Italia","Escocia"],c:0},
    {q:"¿Jonah Lomu era…?",o:["Pilar","Wing","Hooker"],c:1},

    // Reglas intermedias
    {q:"¿Cuántos cambios tácticos se permiten en test rugby?",o:["8","6","10"],c:0},
    {q:"En scrum, ¿quién talona?",o:["Hooker","Pilar izquierdo","Octavo"],c:0},
    {q:"¿Qué es offside en juego abierto?",o:["Estar delante del pateador/último pie","Pisar la línea lateral","Hablar al árbitro"],c:0},
    {q:"¿Se puede cargar al pateador?",o:["Sí, si fue legal y a tiempo","No, es tarjeta","Solo si árbitro avisa"],c:0},
    {q:"En 7s, el tiempo por tiempo es…",o:["10 minutos","7 minutos","14 minutos"],c:2},
    {q:"¿Qué tarjeta implica 10 minutos afuera?",o:["Amarilla","Roja","Azul"],c:0},
    {q:"¿Un try penal vale…?",o:["5 + conversión obligatoria","7 puntos automáticos","6 con drop"],c:1},
    {q:"Si hay ventaja por knock-on y no progresa…",o:["Se vuelve al scrum","Se sigue siempre","Se da line"],c:0},
    {q:"¿Quién decide el fin de la ventaja?",o:["Capitán","Árbitro","Equipo con la pelota"],c:1},
    {q:"¿Un pase que rebota en el árbitro?",o:["Se repite jugada","Scrum al equipo atacante","Pelota viva, según reglas actuales"],c:2},

    // Situaciones de partido
    {q:"¿Se puede disputar en el aire al receptor?",o:["Sí, si es limpio y no peligroso","Nunca","Solo dentro de 22"],c:0},
    {q:"¿Qué pasa si el portador apoya en touch-in-goal?",o:["Try","22 drop-out o scrum 5","In goal: salida 22 si atacante tocó fuera"],c:2},
    {q:"¿Qué pasa si un jugador patea desde afuera y vuelve al campo?",o:["Sigue juego","Line donde salió","Scrum"],c:1},
    {q:"¿El TMO puede intervenir…?",o:["Solo a pedido del árbitro","Siempre que quiera","Nunca"],c:0},
    {q:"¿Cuántos puntos vale la conversión?",o:["2","3","1"],c:0},
    {q:"¿Se permite pase hacia adelante si es knock-back por viento?",o:["No","Sí","Depende del árbitro"],c:0},
    {q:"En un ruck, ¿se puede usar las manos?",o:["No, salvo al inicio si no formado","Sí, siempre","Solo el 9"],c:0},
    {q:"¿Quién forma última fila del scrum?",o:["Ala y octavo","Centros","Pilares"],c:0},
    {q:"¿Se puede levantar al saltador en line-out?",o:["Sí, con seguridad","No","Solo si rival también"],c:0},
    {q:"¿Qué pasa si hay doble movimiento en try?",o:["Try válido","Penal en contra","Scrum"],c:1},

    // Más historia/jugadores
    {q:"¿Máximo anotador histórico de Pumas (test)?",o:["Nicolás Sánchez","Hugo Porta","Felipe Contepomi"],c:0},
    {q:"¿Primer equipo en ganar 3 mundiales?",o:["Nueva Zelanda","Sudáfrica","Australia"],c:0},
    {q:"¿Quién popularizó el ‘up and under’?",o:["Jonny Wilkinson","Garryowen FC","Dan Carter"],c:1},
    {q:"¿Qué país ganó el 6 Naciones 2022 (Grand Slam)?",o:["Francia","Irlanda","Gales"],c:0},
    {q:"¿En qué ciudad se originó la leyenda de William Webb Ellis?",o:["Rugby","Oxford","Cambridge"],c:0},
    {q:"¿Qué selección es ‘La Rosa’?",o:["Inglaterra","Escocia","Gales"],c:0},
    {q:"¿Quién es ‘Beauden’ famoso apertura?",o:["Barrett","Carter","O’Gara"],c:0},
    {q:"¿Entrenador de Pumas 2023?",o:["Michael Cheika","Ledesma","Pocock"],c:0},
    {q:"¿Qué significa ‘knock-on’?",o:["Golpe adelantado con mano/brazo","Pase largo","Tackle sin brazos"],c:0},
    {q:"¿Cuántos árbitros asisten al principal en test?",o:["2 jueces de touch + TMO","Solo TMO","Ninguno"],c:0},

    // Intermedio alto
    {q:"¿Qué define onside tras un kick?",o:["Estar detrás del pateador","Estar en campo propio","Estar dentro de 22"],c:0},
    {q:"¿Free kick se puede patear directo a palos?",o:["No","Sí","Solo en sevens"],c:0},
    {q:"¿Scrum 5 defensivo surge por…?",o:["Knock-on atacante en in-goal","Penal en 5","Line perdido"],c:0},
    {q:"¿Pelota apoyada simultánea por atacante y defensor?",o:["Try","Scrum 5 atacante","Bola muerta: scrum 5"],c:2},
    {q:"¿Puede el 9 disputar en ruck si está onside?",o:["Sí","No","Solo si el 8 lo permite"],c:0},
    {q:"¿Qué pasa si un tackleador no libera al jugador?",o:["Penal","Scrum","Nada"],c:0},
    {q:"¿Obstrucción (blocking) se sanciona con…?",o:["Scrum","Penal","Free kick"],c:1},
    {q:"¿En line desordenado (número desigual) sin ventaja…?",o:["Repetir line","Free kick","Scrum"],c:1},
    {q:"¿Patear la pelota en ruck una vez formada…?",o:["Permitido","Penal","Tarjeta"],c:1},
    {q:"¿Se puede pedir scrum en lugar de penal?",o:["Sí","No","Solo dentro de 22"],c:0},

    // Dificultad 14-15 (hard=true)
    {q:"Hard: ¿Límite de jugadores en line?",o:["Hasta 13","Hasta 8","Sin límite (pero ordenados)"],c:2,h:1},
    {q:"Hard: ¿Offside tras kick y ‘10 metros’?",o:["Debe retirarse o ser habilitado","No aplica en test","Solo para forwards"],c:0,h:1},
    {q:"Hard: ¿Reinicio tras marca en 22 propia?",o:["Free kick desde el lugar","Scrum en 5","Gol a palos directo"],c:0,h:1},
    {q:"Hard: ¿Qué determina ‘último pie’ en ruck?",o:["Pies del último participante legal","Línea imaginaria del referee","La posición del 9"],c:0,h:1},
    {q:"Hard: ¿Conversión fuera de tiempo reglamentario?",o:["Se puede patear si try fue antes de 80","Nunca","Solo si ambos capitanes aceptan"],c:0,h:1},
    {q:"Hard: ¿Kick directo al touch desde fuera de 22?",o:["Line a donde salió","Line donde pateó","Scrum rival"],c:0,h:1},
    {q:"Hard: ¿Reanudación si el atacante comete knock-on en in-goal rival?",o:["Scrum 5 para defensor","Drop 22","Scrum 5 para atacante"],c:0,h:1},
    {q:"Hard: ¿Se puede tomar un quick-tap con el balón en movimiento?",o:["Debe estar quieta","Sí","Solo con permiso del árbitro"],c:0,h:1},
    {q:"Hard: ¿Penal repetido cerca del in-goal?",o:["Tarjeta amarilla posible","Solo charla","Scrum obligatorio"],c:0,h:1},
    {q:"Hard: ¿Cargar al pateador tarde pero sin contacto a la cabeza?",o:["Penal y posible amarilla","Nada","Solo free-kick"],c:0,h:1}
  ];
  // asignar ids
  return arr.map((x,i)=>({id:i+1, q:x.q, opts:x.o, c:x.c, h:!!x.h}));
})();

/* ===========================
   HELPERS
=========================== */
const rnd = (arr)=>arr[Math.floor(Math.random()*arr.length)];
const shuffle = (arr)=>arr.sort(()=>Math.random()-0.5);

/* ===========================
   LOGIN + ADMIN
=========================== */
$("btnAdminLogin").onclick = ()=>{ $("adminKeyBox").style.display="block"; };
$("btnAdminGo").onclick = ()=>{
  if($("adminKey").value.trim()==="20250819802006"){
    isAdmin=true;
    $("adminPanel").classList.add("show");
    $("adminInlineTools").style.display="block";
    toast("Admin habilitado");
  }else{
    toast("Clave incorrecta");
  }
};

$("btnLogin").onclick = async ()=>{
  const username = $("alias").value.trim();
  if(!username){ toast("Ingresá un alias"); return; }

  // buscar/crear
  let { data:user, error } = await supabase.from("users").select("*").eq("username",username).maybeSingle();
  if(error){ toast("Error de conexión"); return; }
  if(!user){
    const ins = await supabase.from("users").insert([{ username, coins:0 }]).select().single();
    if(ins.error){ toast("No se pudo crear el usuario"); return; }
    user = ins.data;
  }
  me = user;
  $("who").textContent = me.username;
  $("coins").textContent = me.coins || 0;
  $("loginCard").style.display="none";
  $("gameCard").style.display="block";
  play("sStart");
  loadRanking();
  startTrainingOrRound();
  subscribeChat();
  loadChat();
  refreshKPIs(); // admin
};

/* ===========================
   ENTRENAMIENTO + RONDAS
=========================== */
function startTrainingOrRound(){
  if(trainingLeft>0){
    toast(`Entrenamiento: te quedan ${trainingLeft} pregunta(s) gratis`);
  }
  newRound();
}
function newRound(){
  // elegir 5 preguntas sin repetir globalmente
  const pool = QUESTIONS.filter(q=>!asked.has(q.id) && ((level<14) || q.h===true)); // en 14-15 prioriza hard
  // si en 14-15 no hay suficientes hard, completa con cualquiera restante
  let candidates = [...pool];
  if(level<14){
    // normal
  }else{
    const hard = QUESTIONS.filter(q=>q.h && !asked.has(q.id));
    const rest = QUESTIONS.filter(q=>!q.h && !asked.has(q.id));
    candidates = [...hard, ...rest];
  }
  shuffle(candidates);
  round = candidates.slice(0,5);
  answered = 0;
  updateTop();
  showBet();
}
function updateTop(){
  $("levelTxt").textContent = `Nivel ${level}`;
  $("coins").textContent = me?.coins ?? 0;
  $("progress").textContent = `${answered}/5`;
}

/* ===========================
   APUESTAS + PREGUNTAS + TIMER
=========================== */
$("btnStartQ").onclick = ()=>{
  const bet = parseInt($("bet").value,10);
  if(isNaN(bet) || bet<500){ toast("Apuesta mínima $500"); return; }
  if(trainingLeft<=0 && (me.coins||0) < bet){ toast("No tenés monedas suficientes"); return; }

  play("sBet");
  // Mostrar pregunta
  const q = round[answered];
  $("qText").textContent = q.q;
  const box=$("qOpts"); box.innerHTML="";
  q.opts.forEach((t,idx)=>{
    const b=document.createElement("button");
    b.className="btn opt";
    b.textContent=t;
    b.onclick = ()=>checkAnswer(idx, q.c, bet, q.id);
    box.appendChild(b);
  });
  $("betStage").style.display="none";
  $("qStage").style.display="block";

  // Timer 20s
  startTimer(bet, q.c, q.id);
};

function startTimer(bet, correctIndex, qid){
  clearInterval(timer);
  tLeft=20;
  const bar=$("timebar"), ball=$("ball");
  bar.style.width="100%"; ball.style.left="0";
  timer = setInterval(()=>{
    tLeft--;
    const p = Math.max(0,(tLeft/20)*100);
    bar.style.width = p+"%";
    ball.style.left = (100-p)+"%";
    if(tLeft<=0){
      clearInterval(timer);
      // tiempo agotado = incorrecto
      fail(bet);
      finalizeQuestion(qid);
    }
  },1000);
}

async function checkAnswer(sel, correct, bet, qid){
  clearInterval(timer);
  if(trainingLeft>0){
    // entrenamiento: solo feedback visual
    if(sel===correct){ play("sGood"); confetti(); toast("✅ ¡Correcto! (entrenamiento)"); }
    else{ play("sBad"); $("gameCard").classList.add("shake"); setTimeout(()=>$("gameCard").classList.remove("shake"),400); toast("❌ Incorrecto (entrenamiento)"); }
    finalizeQuestion(qid, true);
    return;
  }

  if(sel===correct){
    // gana
    play("sGood"); confetti();
    const newCoins = (me.coins||0) + bet;
    await supabase.from("users").update({ coins:newCoins }).eq("id", me.id);
    me.coins=newCoins; updateTop();
    toast(`✅ ¡Correcto! +$${bet}`);
    play("sCrowd");
  }else{
    fail(bet);
  }
  finalizeQuestion(qid);
}

async function fail(bet){
  play("sBad"); $("gameCard").classList.add("shake"); setTimeout(()=>$("gameCard").classList.remove("shake"),400);
  if(trainingLeft<=0){
    const newCoins = Math.max(0,(me.coins||0) - bet);
    await supabase.from("users").update({ coins:newCoins }).eq("id", me.id);
    me.coins=newCoins; updateTop();
    toast(`❌ Incorrecto / tiempo. -$${bet}`);
  }else{
    toast("⏰ Se acabó el tiempo (entrenamiento)");
  }
}

function finalizeQuestion(qid, wasTraining=false){
  asked.add(qid);
  answered++;
  updateTop();

  if(trainingLeft>0){
    trainingLeft--;
    if(trainingLeft===0){
      $("trainInfo").style.display="block";
      toast("🎓 ¡Entrenamiento completo! Comprá monedas para seguir.");
    }
  }

  if(answered>=5){
    // subir nivel
    level = Math.min(15, level+1);
    toast(`⬆️ Nivel ${level}`);
    newRound();
  }else{
    showBet();
  }
}

function showBet(){
  clearInterval(timer);
  $("qStage").style.display="none";
  $("betStage").style.display="block";
  // reset timer visuals
  $("timebar").style.width="100%"; $("ball").style.left="0";
}

/* ===========================
   CHAT
=========================== */
async function loadChat(){
  const { data } = await supabase.from("messages").select("*").order("created_at",{ascending:true}).limit(80);
  paintChat(data||[]);
}
function paintChat(list){
  const box=$("chatBox"); box.innerHTML="";
  list.forEach(m=>{
    const d=document.createElement("div");
    d.className="msg";
    d.innerHTML=`<span class="who">${m.username}:</span> <span>${m.content}</span>`;
    box.appendChild(d);
  });
  box.scrollTop=box.scrollHeight;
}
$("btnSendMsg").onclick = async ()=>{
  if(!me){ toast("Primero logueate"); return; }
  const txt = $("chatInput").value.trim();
  if(!txt) return;
  $("chatInput").value="";
  play("sChat");
  await supabase.from("messages").insert([{ username: me.username, content: txt }]);
};
function subscribeChat(){
  supabase.channel('realtime:messages')
    .on('postgres_changes',{event:'INSERT',schema:'public',table:'messages'}, (p)=>{
      // agregar a la vista
      const m=p.new;
      const box=$("chatBox");
      const d=document.createElement("div");
      d.className="msg";
      d.innerHTML=`<span class="who">${m.username}:</span> <span>${m.content}</span>`;
      box.appendChild(d);
      box.scrollTop=box.scrollHeight;
    })
    .on('postgres_changes',{event:'DELETE',schema:'public',table:'messages'}, ()=>{
      loadChat();
    })
    .subscribe();
}

/* ===========================
   RANKING
=========================== */
async function loadRanking(){
  const { data } = await supabase.from("users").select("username,coins").order("coins",{ascending:false}).limit(30);
  const box=$("rankBox"); box.innerHTML="";
  (data||[]).forEach((r,i)=>{
    const d=document.createElement("div"); d.className="item";
    d.innerHTML = `#${i+1} <strong>${r.username}</strong> — $${r.coins||0}`;
    box.appendChild(d);
  });
}
setInterval(()=>{ if(me) loadRanking(); }, 10000);

/* ===========================
   TIENDA
=========================== */
document.querySelectorAll('[data-url]').forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const url = btn.getAttribute("data-url");
    const amount = btn.getAttribute("data-amount");
    toast(`Vas a Mercado Pago por ${amount} monedas. Compartí el comprobante por chat y el admin te acredita.`);
    window.open(url,"_blank");
  });
});

/* ===========================
   ADMIN PANEL (inline)
=========================== */
$("btnClearChat").onclick = async ()=>{
  if(!isAdmin){ toast("Solo admin"); return; }
  await supabase.from("messages").delete().neq("id",-1);
  toast("🧹 Chat borrado");
};
$("btnAddCoins").onclick = async ()=>{
  if(!isAdmin){ toast("Solo admin"); return; }
  const u = $("admUser").value.trim();
  const amt = parseInt($("admAmount").value,10) || 0;
  if(!u || !amt){ toast("Completá usuario y monto"); return; }
  // buscar usuario
  const { data:user } = await supabase.from("users").select("*").eq("username",u).maybeSingle();
  if(!user){ toast("Usuario no existe"); return; }
  const newCoins = (user.coins||0) + amt;
  const { error } = await supabase.from("users").update({ coins:newCoins }).eq("id", user.id);
  if(error){ toast("Error al acreditar"); return; }
  if(me && me.id===user.id){ me.coins=newCoins; updateTop(); }
  toast(`✅ Acreditadas $${amt} a ${u}`);
  loadRanking(); refreshKPIs();
};
$("btnDelUser").onclick = async ()=>{
  if(!isAdmin){ toast("Solo admin"); return; }
  const u=$("admUser").value.trim();
  if(!u){ toast("Indicá username"); return; }
  const { data:user } = await supabase.from("users").select("id").eq("username",u).maybeSingle();
  if(!user){ toast("Usuario no existe"); return; }
  await supabase.from("users").delete().eq("id",user.id);
  toast(`🗑️ ${u} eliminado`);
  if(me && me.username===u){ location.reload(); }
  loadRanking(); refreshKPIs();
};
async function refreshKPIs(){
  if(!isAdmin) return;
  const u = await supabase.from("users").select("id,coins").order("coins",{ascending:false}).limit(1);
  const m = await supabase.from("messages").select("id",{count:"exact", head:true});
  const c = await supabase.from("users").select("id",{count:"exact", head:true});
  $("kUsers").textContent = c.count ?? "—";
  $("kMsgs").textContent = m.count ?? "—";
  $("kTop").textContent = (u.data && u.data[0]) ? (u.data[0].coins||0) : "—";
}
</script>
</body>
</html>
