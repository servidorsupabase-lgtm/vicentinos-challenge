<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no"/>
<title>Vicentinos Challenge üèâ</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{
    --bg:#042b4e; --card:#0b1220; --neon:#39ff14; --neon2:#97ff7a; --txt:#eaffef; --muted:#a7c7b7;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--txt);font-family:'Inter',system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .banner{
    height:180px;background:url('https://i.postimg.cc/nVvFmXQR/wp2896798.jpg') center/cover no-repeat;
    border-bottom:4px solid var(--neon); position:relative;
  }
  .banner:after{
    content:"Vicentinos Challenge üèâüî•"; position:absolute; inset:auto 0 16px 0; text-align:center;
    font-weight:800; font-size:clamp(24px,5vw,40px); color:white; text-shadow:0 0 12px var(--neon), 0 0 24px var(--neon);
  }
  .wrap{max-width:1000px;margin:16px auto;padding:0 12px;display:grid;gap:16px}
  .card{background:linear-gradient(180deg,#0b1220,#070c17);border:1px solid #1c2c3f;border-radius:14px;box-shadow:0 0 22px #0007;padding:16px}
  .neon{box-shadow:0 0 12px var(--neon); border:1px solid var(--neon)}
  h2{margin:0 0 10px 0;font-size:1.25rem;color:var(--neon2);text-shadow:0 0 8px var(--neon)}
  .row{display:flex;gap:10px;align-items:center}
  input,button{border-radius:10px;border:none;font:600 15px/1 'Inter';}
  input{background:#0d1626;color:var(--txt);padding:12px 14px;border:1px solid #27435b;width:100%}
  button{background:var(--neon);color:#001b06;padding:12px 16px;cursor:pointer;transition:transform .12s}
  button:hover{transform:translateY(-1px)}
  .sub{color:var(--muted);font-size:.95rem}
  .grid{display:grid;gap:16px}
  @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
  .panel{background:#0b1424;border:1px solid #1e3248;border-radius:12px;max-height:340px;overflow:auto;padding:10px}
  .msg{padding:6px 8px;border-left:3px solid var(--neon);background:#0a1a2c;margin:6px 0;word-break:break-word}
  .alias{font-weight:800;color:var(--neon2)}
  .rank .r{padding:6px;border-bottom:1px dashed #224}
  .center{text-align:center}
  .small{font-size:.9rem;opacity:.9}
  .hidden{display:none}

  /* Juego */
  .topbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
  .stat{background:#0c1a2b;border:1px solid #20405a;border-radius:10px;padding:8px 10px;min-width:120px;text-align:center}
  .label{color:#9cc; font-size:.85rem}
  .val{font-weight:800;color:var(--neon)}
  .timer{height:18px;background:#061324;border:1px solid #26435a;border-radius:999px;overflow:hidden;position:relative;margin:10px 0}
  .bar{height:100%;width:100%;background:linear-gradient(90deg,var(--neon),#b0ffb9)}
  .ball{position:absolute;top:-12px;left:0;width:36px;height:36px;background:url('https://cdn-icons-png.flaticon.com/512/300/300845.png') center/contain no-repeat;filter:drop-shadow(0 0 8px #0f0)}
  .q{font-size:1.05rem;margin:8px 0 6px}
  .opts{display:flex;gap:8px;flex-wrap:wrap}
  .opts button{background:#07162a;color:#eaffef;border:1px solid #235; padding:10px 12px}
  .opts button:hover{border-color:var(--neon)}
  .ok{outline:2px solid #00ff90}
  .bad{outline:2px solid #ff4b4b}

  /* Toast */
  .toast{position:fixed;top:14px;right:14px;background:#09121f;border:1px solid var(--neon);color:var(--txt);
    padding:10px 14px;border-radius:10px;opacity:0;transform:translateY(-8px);transition:.25s;z-index:9999}
  .toast.show{opacity:1;transform:none}

  /* Confeti */
  .confeti{position:fixed;inset:0;pointer-events:none;overflow:hidden;z-index:9998}
  .piece{position:absolute;width:10px;height:14px;background:var(--neon);animation:fall 1.2s linear forwards}
  @keyframes fall{to{transform:translateY(110vh) rotate(1turn);opacity:.1}}

  /* Tienda */
  .shop button{width:100%; margin-top:8px;background:var(--neon); color:#001b06}

  /* Volver */
  .back{background:#18283b;color:#cde;border:1px solid #35566f}
</style>
</head>
<body>
  <div class="banner"></div>
  <div id="toast" class="toast"></div>
  <div id="confeti" class="confeti"></div>

  <!-- Sonidos -->
  <audio id="snd-start" src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-opening-2034.mp3"></audio>
  <audio id="snd-right" src="https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3"></audio>
  <audio id="snd-wrong" src="https://assets.mixkit.co/sfx/preview/mixkit-failure-arcade-alert-notification-240.wav"></audio>
  <audio id="snd-chat" src="https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-2574.mp3"></audio>
  <audio id="snd-roar" src="https://cdn.pixabay.com/download/audio/2022/10/25/audio_0c4588f1b2.mp3?filename=crowd-114106.mp3"></audio>

  <div class="wrap">

    <!-- INICIO / LOBBY -->
    <div id="lobby" class="card neon">
      <h2>üéÆ Tu nombre de guerra</h2>
      <p class="sub">Ingres√° tu alias y preparate para el siete m√°s picante. Los nuevos reciben <b>3 preguntas de entrenamiento</b>.</p>
      <div class="row">
        <input id="alias" maxlength="24" placeholder="Tu alias (ej: Pumita10)" />
        <button id="btnPlay">¬°JUGAR AHORA!</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>üõí Compr√° Monedas</h2>
        <p class="small">Ser√°s redirigido a Mercado Pago. Luego <b>compart√≠ el comprobante</b> en el chat y el admin acreditar√° las monedas a tu alias.</p>
        <div class="shop">
          <button data-url="https://mpago.la/16CyPeY" data-amount="2000">Pack $2.000 ‚Üí 2.000 monedas</button>
          <button data-url="https://mpago.la/1TTVVcV" data-amount="5000">Pack $5.000 ‚Üí 5.000 monedas</button>
          <button data-url="https://mpago.la/2HR6fjA" data-amount="10000">Pack $10.000 ‚Üí 10.000 monedas</button>
        </div>
      </div>

      <div class="card">
        <h2>üèÜ Ranking Top</h2>
        <div id="ranking" class="panel rank"></div>
      </div>

      <div class="card">
        <h2>üí¨ Chat del Estadio</h2>
        <div class="row">
          <input id="chatText" placeholder="Escrib√≠ y apret√° Enviar‚Ä¶" />
          <button id="btnSend">Enviar</button>
        </div>
        <div id="chat" class="panel"></div>
      </div>
    </div>

    <!-- JUEGO -->
    <div id="game" class="card hidden">
      <div class="topbar">
        <div class="stat"><div class="label">Jugador</div><div class="val" id="uName">-</div></div>
        <div class="stat"><div class="label">Nivel</div><div class="val" id="uLevel">1 / 15</div></div>
        <div class="stat"><div class="label">Monedas</div><div class="val" id="uCoins">0</div></div>
        <div class="stat"><div class="label">Preguntas</div><div class="val" id="uQCount">0/5</div></div>
      </div>

      <div id="trainingBox" class="small" style="margin:8px 0 0 2px;color:#fffa96">
        üéì Modo entrenamiento activo. Te quedan <b id="trainLeft">3</b> preguntas gratis.
      </div>

      <div id="betBox" class="row" style="margin:10px 0">
        <input id="bet" type="number" min="500" step="100" value="500" />
        <button id="btnStartQ">Apostar y jugar</button>
        <button id="btnBack" class="back">Volver al men√∫</button>
      </div>

      <div class="timer">
        <div id="bar" class="bar"></div>
        <div id="ball" class="ball"></div>
      </div>

      <div id="qBox" class="hidden">
        <div id="qText" class="q"></div>
        <div id="opts" class="opts"></div>
      </div>
    </div>
  </div>

<script>
/* ===================  SUPABASE  =================== */
const SUPABASE_URL = "https://aqkqbtunbyifbfrvkpxv.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFxa3FidHVuYnlpZmJmcnZrcHh2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyOTg5NDgsImV4cCI6MjA3MDg3NDk0OH0.Xqtii5yiIO6tFOzzqza70ZA7N1KmbcTIkoNtV5YCVDY";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ===================  UTIL / UI  =================== */
const $ = id => document.getElementById(id);
const toast = (t)=>{const el=$("toast"); el.textContent=t; el.classList.add("show"); setTimeout(()=>el.classList.remove("show"),1800);};
const play = id => {const a=$(id); if(!a) return; a.currentTime=0; a.play().catch(()=>{});};
function confeti(){const box=$("confeti"); for(let i=0;i<80;i++){const d=document.createElement("div"); d.className="piece"; d.style.left=(Math.random()*100)+"%"; d.style.background=`hsl(${Math.random()*120+80}deg 100% 60%)`; d.style.animationDuration=(.8+Math.random()*1.2)+"s"; box.appendChild(d); setTimeout(()=>d.remove(),1400);}}

/* ===================  ESTADO  =================== */
let me=null;             // {id, username, coins}
let level=1;             // 1..15
let qInLevel=0;          // 0..5
let trainingLeft=0;      // 3 al crear jugador
let inTraining=false;    // true si trainingLeft>0
let roundQ=null;         // pregunta actual
let usedIds=new Set();   // ids usadas para no repetir
let timer=null, timeLeft=20;

/* ===================  PREGUNTAS  ===================
  d = dificultad de 1..15 (14-15 = casi imposible)
*/
const Q = [
  /* --- Reglamento b√°sico (1-5) --- */
  {id:1,d:1,q:"¬øCu√°ntos jugadores por equipo hay en rugby XV?",o:["13","15","11","14"],c:1},
  {id:2,d:1,q:"¬øCu√°ntos puntos vale un try?",o:["3","5","6","7"],c:1},
  {id:3,d:1,q:"¬øCu√°nto dura un partido de rugby XV (tiempo total)?",o:["80 min","70 min","60 min","90 min"],c:0},
  {id:4,d:2,q:"¬øQu√© se hace despu√©s de anotar un try?",o:["Reanudaci√≥n con scrum","Conversi√≥n a palos","Line-out","Free kick"],c:1},
  {id:5,d:2,q:"¬øCu√°ntos puntos vale un drop goal?",o:["2","3","4","1"],c:1},
  {id:6,d:2,q:"¬øCu√°ntos puntos vale la conversi√≥n?",o:["3","2","1","4"],c:1},
  {id:7,d:2,q:"¬øCu√°l es la direcci√≥n legal de pase?",o:["Adelante","Atr√°s/lateral","Cualquiera","Solo lateral"],c:1},
  {id:8,d:2,q:"¬øC√≥mo se llama la reanudaci√≥n tras un pase hacia adelante accidental?",o:["Line-out","Scrum","Free kick","Drop"],c:1},
  {id:9,d:3,q:"¬øQu√© es un ruck?",o:["Formaci√≥n en el suelo tras un placaje","Alzada en line-out","Empuje de scrum","Salida r√°pida"],c:0},
  {id:10,d:3,q:"¬øQu√© es un maul?",o:["Lucha por bal√≥n en el suelo","Formaci√≥n de pie empujando","Tiro a palos","Saque r√°pido"],c:1},
  {id:11,d:3,q:"¬øQu√© infracci√≥n suele sancionar un knock-on?",o:["Free kick","Scrum","Penal y tarjeta","Line-out"],c:1},
  {id:12,d:3,q:"¬øD√≥nde se realiza la conversi√≥n?",o:["En el centro","En l√≠nea con el lugar del try","Desde la esquina","Desde 22"],c:1},
  {id:13,d:4,q:"¬øQu√© es fuera de juego (offside)?",o:["Estar delante del compa√±ero que jug√≥ el bal√≥n","Pisar la l√≠nea de touch","No retroceder 10m en penal","Salir antes del scrum"],c:0},
  {id:14,d:4,q:"¬øCu√°ntos jugadores forman el pack de forwards en XV?",o:["6","7","8","9"],c:2},
  {id:15,d:4,q:"El primer jugador que llega a un ruck debe:",o:["Pisar el bal√≥n","Apoyar manos delante del bal√≥n","Ingresar por la puerta","Derribar rivales"],c:2},
  {id:16,d:4,q:"¬øCu√°ndo hay line-out?",o:["Bal√≥n a touch","Knock-on","Tackle alto","Obstrucci√≥n"],c:0},
  {id:17,d:5,q:"¬øQu√© hace el medio scrum (9) en un scrum?",o:["Introduce el bal√≥n","Salta","Patea a palos","Levanta el bal√≥n del ruck"],c:0},
  {id:18,d:5,q:"¬øQu√© posici√≥n suele patear las conversiones?",o:["Hooker","Apertura (10)","Wing","Pilar"],c:1},
  {id:19,d:5,q:"¬øCu√°ndo se concede penal?",o:["Offside/tackle alto/ingreso ilegal","Knock-on","Try","Pelota a touch"],c:0},
  {id:20,d:5,q:"¬øQu√© distancia deben retroceder los defensores en un penal?",o:["5 m","8 m","10 m","15 m"],c:2},

  /* --- Situaciones de partido (6-10) --- */
  {id:21,d:6,q:"Si un defensor comete try-saver con tackle alto en in-goal rival:",o:["Try de penal","Solo penal","Scrum atacante","Nada"],c:0},
  {id:22,d:6,q:"Pate√°s a touch desde un penal y la pelota sale: ¬øqui√©n lanza?",o:["Defensor","Atacante","√Årbitro decide","Scrum"],c:1},
  {id:23,d:6,q:"Tu compa√±ero patea un up&under; corr√©s delante de √©l y particip√°s:",o:["Legal","Offside penal","Solo scrum","Tarjeta autom√°tica"],c:1},
  {id:24,d:6,q:"En 22 propia, atrap√°s y hac√©s mark (se√±al):",o:["Free kick","Scrum","Line-out","Penal"],c:0},
  {id:25,d:7,q:"Scrum a 5 m, el 8 controla y es derrumbado ilegalmente cerca del try:",o:["Scrum repetido","Penal y amarilla posible","Solo free kick","Nada"],c:1},
  {id:26,d:7,q:"En un ruck toc√°s el bal√≥n con las manos estando de pie y habilitado:",o:["Penal","Legal","Tarjeta","Scrum"],c:1},
  {id:27,d:7,q:"Pate√°s a palos y la pelota pega en el palo y vuelve, un compa√±ero la toma:",o:["Offside autom√°tico","Juego contin√∫a","Line-out","Scrum"],c:1},
  {id:28,d:8,q:"Conversi√≥n r√°pida: rivales a menos de 10 m interfieren visualmente:",o:["Repetir kick o penal","Nada","Scrum","Tarjeta solo"],c:0},
  {id:29,d:8,q:"Pick&go: compa√±ero cae y vos entr√°s por costado al ruck:",o:["Penal por ingreso lateral","Legal","Free kick","Scrum"],c:0},
  {id:30,d:8,q:"Puntap√≠e de mitad y rival lo devuelve directo a touch sin botar desde fuera de 22:",o:["Line-out en mitad","Line-out donde sali√≥","Line-out donde bot√≥","Scrum"],c:1},

  /* --- Historia / Mundial / Pumas (9-12) --- */
  {id:31,d:9,q:"¬øQui√©n gan√≥ el Mundial de Rugby 2023?",o:["Nueva Zelanda","Sud√°frica","Inglaterra","Francia"],c:1},
  {id:32,d:9,q:"¬øEn qu√© a√±o Los Pumas fueron bronce mundial?",o:["2007","2011","1999","2003"],c:0},
  {id:33,d:9,q:"Leyenda argentina apodada 'El Mago':",o:["Hugo Porta","Nicol√°s S√°nchez","Felipe Contepomi","Agust√≠n Pichot"],c:0},
  {id:34,d:9,q:"¬øEn qu√© a√±o Argentina ingres√≥ al Rugby Championship?",o:["2010","2012","2014","2016"],c:1},
  {id:35,d:10,q:"Sede del primer Mundial de Rugby (1987):",o:["Inglaterra","Nueva Zelanda y Australia","Sud√°frica","Francia"],c:1},
  {id:36,d:10,q:"M√°ximo ganador hist√≥rico de Mundiales:",o:["Sud√°frica","Nueva Zelanda","Inglaterra","Australia"],c:0},
  {id:37,d:10,q:"¬øQu√© selecci√≥n es conocida como 'Los Teros'?",o:["Chile","Uruguay","Portugal","Georgia"],c:1},
  {id:38,d:10,q:"¬øQu√© hizo famoso a Jonah Lomu?",o:["Hooker dominante","Wing poderoso y veloz","Apertura puntilloso","Fullback de kicks"],c:1},
  {id:39,d:11,q:"Capit√°n de Los Pumas en 2007:",o:["Felipe Contepomi","Agust√≠n Pichot","Juan Fern√°ndez Lobbe","Mario Ledesma"],c:1},
  {id:40,d:11,q:"¬øCu√°ntos equipos participan en un Mundial moderno?",o:["12","16","20","24"],c:2},
  {id:41,d:11,q:"Apodo de Nueva Zelanda:",o:["Wallabies","All Blacks","Springboks","Les Bleus"],c:1},
  {id:42,d:11,q:"Estadio m√≠tico de Twickenham se ubica en:",o:["Cardiff","Dubl√≠n","Londres","Par√≠s"],c:2},
  {id:43,d:12,q:"M√°ximo goleador hist√≥rico de Los Pumas (puntos):",o:["Nicol√°s S√°nchez","Hugo Porta","Felipe Contepomi","Juan M. Hern√°ndez"],c:0},
  {id:44,d:12,q:"¬øQu√© pa√≠s gan√≥ el Mundial 1995 con Mandela presente?",o:["Australia","Sud√°frica","Inglaterra","Francia"],c:1},
  {id:45,d:12,q:"¬øQu√© selecci√≥n se apoda 'Brave Blossoms'?",o:["Samoa","Fiji","Jap√≥n","Tonga"],c:2},
  {id:46,d:12,q:"¬øQu√© naci√≥n gan√≥ la primera Rugby Championship (4 Nations) en 2012?",o:["NZ","Aus","RSA","Arg"],c:0},

  /* --- Posiciones / t√©cnica (5-9) --- */
  {id:47,d:5,q:"El hooker usa el pie para:",o:["Hookear en scrum","Marcar un try","Drop goal","Nada especial"],c:0},
  {id:48,d:5,q:"El fullback (15) suele:",o:["Patear despejes y recibir patadas","Ser pilar del scrum","Introducir el bal√≥n","Lanzar line-out"],c:0},
  {id:49,d:6,q:"En line-out, ¬øqui√©n lanza?",o:["Hooker","Pilar izquierdo","Medio scrum","Apertura"],c:0},
  {id:50,d:6,q:"Jugador 7 (flanker abierto) destaca por:",o:["Velocidad y caza de rucks","Patear a palos","Salto de line-out √∫nicamente","Ser m√°s pesado del pack"],c:0},
  {id:51,d:6,q:"El n√∫mero 10 (apertura) decide:",o:["Juego al pie y distribuci√≥n","Empuje en scrum","Saque de banda","Formaci√≥n de ruck"],c:0},
  {id:52,d:7,q:"¬øQu√© indica el √°rbitro con brazo extendido horizontal?",o:["Ley de ventaja","Penal","Scrum","Tarjeta"],c:0},
  {id:53,d:7,q:"¬øQu√© pasa si el portador se zambulle de cabeza al ruck (sin apoyar)?",o:["Legal","Penal por zambullida","Scrum","Free kick"],c:1},
  {id:54,d:7,q:"El bloqueo a un pateador sin contacto al bal√≥n es:",o:["Obstrucci√≥n (penal)","Legal","Scrum","Free kick"],c:0},
  {id:55,d:8,q:"'Crocodile roll' en ruck (giro peligroso) se sanciona:",o:["Nada","Penal y posible tarjeta","Solo scrum","Free kick"],c:1},
  {id:56,d:8,q:"Entrada en maul por el costado:",o:["Legal","Penal","Scrum","Tarjeta directa"],c:1},

  /* --- M√°s situaciones (8-12) --- */
  {id:57,d:8,q:"Pelota tocada por atacante, rebota en √°rbitro y queda para atacante:",o:["Scrum al equipo que atacaba","Se sigue","Scrum defensivo","Line-out"],c:0},
  {id:58,d:8,q:"Tackle con contacto en cabeza bajo mit. mitigantes:",o:["Siempre roja","Puede ser amarilla","Nunca sanci√≥n","Libre"],c:1},
  {id:59,d:9,q:"Reinicia equipo que recibi√≥ la conversi√≥n:",o:["Kick-off desde mitad","Drop desde 22","Scrum","Touch"],c:0},
  {id:60,d:9,q:"Jugador en offside se vuelve onside si:",o:["Se queda quieto","Un compa√±ero lo habilita o rival lo juega","Grita 'onside'","Retrocede 1 m"],c:1},
  {id:61,d:9,q:"Pelota a touch sin botar desde fuera de 22 tras pase hacia atr√°s en 22:",o:["No gana metros","Gana metros","Scrum","Free kick"],c:0},
  {id:62,d:10,q:"Placaje sin brazos (shoulder charge):",o:["Legal si fuerte","Penal y tarjeta posible","Solo scrum","Nada"],c:1},
  {id:63,d:10,q:"En scrum, adelantarse antes de la introducci√≥n:",o:["Legal","Free kick","Penal","Tarjeta"],c:1},
  {id:64,d:10,q:"¬øCu√°ndo se marca 'goal line drop-out'?",o:["Atacante sostiene en in-goal rival sin apoyar","Defensor pisa en touch-in-goal","Drop de salida luego de try","Nunca"],c:0},
  {id:65,d:11,q:"Si el pateador de penal pide palos, defensa debe:",o:["Quedarse a 5 m","Retroceder 10 m","No importa","Salir del campo"],c:1},
  {id:66,d:11,q:"¬øQu√© ocurre si un defensor derrumba intencionalmente un maul a 5 m?",o:["Nada","Scrum","Penal y posible tarjeta","Free kick"],c:2},
  {id:67,d:11,q:"L√≠mites de sustituciones en test-match tradicionales:",o:["8","7","10","Ilimitadas"],c:0},
  {id:68,d:12,q:"Tarjeta amarilla implica:",o:["5 min afuera","10 min afuera","15 min afuera","Expulsi√≥n definitiva"],c:1},
  {id:69,d:12,q:"Tarjeta roja:",o:["Se reemplaza al toque","No se reemplaza (expulsi√≥n)","Vuelve a los 10","Solo en juveniles"],c:1},
  {id:70,d:12,q:"¬øQu√© es 'advantage over'?",o:["Se agot√≥ la ventaja","Ventaja comienza","Se anula ventaja","Marca el final del partido"],c:0},

  /* --- Leyendas y datos (9-13) --- */
  {id:71,d:9,q:"Capit√°n de Inglaterra campe√≥n 2003:",o:["Martin Johnson","Jonny Wilkinson","Lawrence Dallaglio","Owen Farrell"],c:0},
  {id:72,d:9,q:"Jugador autor del drop decisivo en 2003:",o:["Dan Carter","Jonny Wilkinson","Matt Giteau","Stephen Larkham"],c:1},
  {id:73,d:10,q:"Apodo de Sud√°frica:",o:["Wallabies","Pumas","Springboks","Bokswana"],c:2},
  {id:74,d:10,q:"Sede de 'La Catedral' del rugby argentino:",o:["GEBA","Belgrano","CASI","SIC"],c:2},
  {id:75,d:10,q:"Los Pumas derrotaron por primera vez a Nueva Zelanda en:",o:["2020","2007","2015","2012"],c:0},
  {id:76,d:11,q:"M√°ximo anotador por drops en Mundiales (hist√≥rico):",o:["Jonny Wilkinson","Dan Carter","Grant Fox","Jannie de Beer"],c:3},
  {id:77,d:11,q:"¬øQu√© selecci√≥n se conoce como 'Les Bleus'?",o:["Francia","Italia","Escocia","Gales"],c:0},
  {id:78,d:11,q:"¬øQu√© pa√≠s usa el cardo como emblema?",o:["Gales","Escocia","Irlanda","Italia"],c:1},
  {id:79,d:12,q:"¬øQu√© selecci√≥n integr√≥ el Five Nations original pero no el Home Nations?",o:["Italia","Francia","Espa√±a","Rusia"],c:1},
  {id:80,d:12,q:"¬øCu√°ntos √°rbitros de campo hay en test-match?",o:["1 + 2 asistentes","2","3","1 solo"],c:0},

  /* --- Casi imposible (14-15) --- */
  {id:81,d:14,q:"¬øQu√© equipo gan√≥ el Tri-Nations 1996 (primera edici√≥n)?",o:["Australia","Sud√°frica","Nueva Zelanda","Empate"],c:2},
  {id:82,d:14,q:"Ley 50:22 permite ganar line-out si:",o:["Pate√°s desde tu campo y la pelota bota y sale dentro 22 rival","Pate√°s directo a touch desde cualquier lado","Solo si es penal","Nunca"],c:0},
  {id:83,d:14,q:"¬øQu√© a√±o se introdujo el bonus ofensivo en Rugby Championship?",o:["2016","2017","2018","2019"],c:1},
  {id:84,d:14,q:"Hooker r√©cord de tries con Inglaterra:",o:["Dylan Hartley","Jamie George","Keith Wood","Tom Youngs"],c:1},
  {id:85,d:14,q:"'Caterpillar ruck' se utiliza para:",o:["Formar maul m√°s largo","Proteger salida de box-kick del 9","Evitar offside de backs","Simular scrum"],c:1},
  {id:86,d:15,q:"¬øQu√© equipo logr√≥ Grand Slam en Five/Six Nations m√°s veces (hasta 2024)?",o:["Inglaterra","Gales","Francia","Irlanda"],c:0},
  {id:87,d:15,q:"L√≠mite de altura de line-out lift legal:",o:["Sin l√≠mite expl√≠cito, prima seguridad","2 metros","2,5 metros","3 metros"],c:0},
  {id:88,d:15,q:"Distancia m√≠nima de 10 m en reinicio corto: rival salta y la toma a 9 m sin interferencia:",o:["Juego sigue (legal)","Free kick al no llegar a 10","Scrum","Penal"],c:0},
  {id:89,d:15,q:"Si el pateador anuncia palos y luego patea a touch intencionalmente:",o:["Penal contra por conducta antideportiva","Legal","Scrum","Repetir penal"],c:0},
  {id:90,d:15,q:"En goal-line drop-out: atacante en offside dentro de 5 m participa antes de habilitaci√≥n:",o:["Penal a defensa","Penal al ataque","Scrum","Nada"],c:1},

  /* M√°s para llegar a 100 */
  {id:91,d:9,q:"¬øQui√©n es el capit√°n hist√≥rico de los All Blacks con m√°s tests (hasta 2024)?",o:["Richie McCaw","Sean Fitzpatrick","Kieran Read","Dane Coles"],c:0},
  {id:92,d:10,q:"¬øCu√°l es el apodo de Australia?",o:["Wallabies","Kangaroos","Kiwis","Bulls"],c:0},
  {id:93,d:11,q:"¬øQu√© pa√≠s es 'Los C√≥ndores'?",o:["Chile","Uruguay","Espa√±a","Rumania"],c:0},
  {id:94,d:12,q:"La ventaja se puede jugar por:",o:["Avance territorial/posicional o t√°ctica clara","Solo 10 m","Solo 5 fases","Solo hasta mitad"],c:0},
  {id:95,d:13,q:"N√∫mero m√°ximo de jugadores en touch para line-out:",o:["Ilimitado si sim√©tricos","5","7","4"],c:0},
  {id:96,d:13,q:"¬øQu√© sanci√≥n por bloquear con correr l√≠neas al receptor de alto (no mirando bal√≥n)?",o:["Obstrucci√≥n (penal)","Legal","Scrum","Free kick"],c:0},
  {id:97,d:13,q:"Si en 22 propia pate√°s directo a touch y ven√≠a de pase hacia atr√°s dentro de 22:",o:["Gana metros","No gana metros","Scrum","Free kick"],c:0},
  {id:98,d:14,q:"¬øQu√© juez controla TMO?",o:["Oficial de video independiente","Juez de touch","Cuarto √°rbitro","Capit√°n local"],c:0},
  {id:99,d:14,q:"Drop-kick en salida desde mitad debe:",o:["Ser drop obligatoriamente","Puede ser puntapi√© place","Cualquier pase","Scrum"],c:0},
  {id:100,d:15,q:"¬øCu√°ndo puede un jugador en offside ser puesto onside por rival?",o:["Cuando rival corre 5 m o patea o la toca/porta intencionalmente","Nunca","Solo con penal","Solo con scrum"],c:0},
];

/* ===================  L√ìGICA  =================== */
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
function poolForLevel(L){
  if(L<=3) return Q.filter(x=>x.d<=3);
  if(L<=6) return Q.filter(x=>x.d<=6);
  if(L<=9) return Q.filter(x=>x.d<=9);
  if(L<=12) return Q.filter(x=>x.d<=12);
  if(L===13) return Q.filter(x=>x.d>=10);
  if(L===14) return Q.filter(x=>x.d>=14);
  return Q.filter(x=>x.d>=15); // nivel 15
}

function nextQuestion(){
  const pool = shuffle(poolForLevel(level).filter(q=>!usedIds.has(q.id)));
  if(pool.length===0){ usedIds.clear(); return nextQuestion(); }
  roundQ = pool[0]; usedIds.add(roundQ.id);
  $("qText").textContent = roundQ.q;
  const ops = $("opts"); ops.innerHTML="";
  roundQ.o.forEach((txt,idx)=>{
    const b=document.createElement("button");
    b.textContent=txt;
    b.onclick=()=>answer(idx);
    ops.appendChild(b);
  });
  $("qBox").classList.remove("hidden");
  startTimer();
}

function startTimer(){
  clearInterval(timer); timeLeft=20;
  $("bar").style.width="100%"; $("ball").style.left="0%";
  timer = setInterval(()=>{
    timeLeft--;
    const p = Math.max(0, timeLeft/20*100);
    $("bar").style.width = p+"%";
    $("ball").style.left = (100-p)+"%";
    if(timeLeft<=0){ clearInterval(timer); resolve(false,true); }
  },1000);
}

async function answer(idx){ clearInterval(timer); resolve(idx===roundQ.c,false); }

async function resolve(correct,timeout){
  const trainingNow = inTraining && trainingLeft>0;
  const bet = parseInt($("bet").value,10) || 0;

  if(trainingNow){
    trainingLeft--; $("trainLeft").textContent=trainingLeft;
    if(trainingLeft<=0){ inTraining=false; $("trainingBox").classList.add("hidden"); toast("Fin del entrenamiento. ¬°Compr√° monedas para seguir!"); }
    if(correct){ play("snd-right"); confeti(); play("snd-roar"); toast("‚úÖ ¬°Correcto! (entrenamiento)"); }
    else{ play("snd-wrong"); toast(timeout?"‚è≥ Tiempo agotado":"‚ùå Incorrecto"); }
  }else{
    if(correct){
      me.coins += bet;
      toast(`‚úÖ ¬°Correcto! +${bet}`);
      play("snd-right"); confeti(); play("snd-roar");
    }else{
      me.coins = Math.max(0, me.coins - bet);
      toast(timeout?`‚è≥ Tiempo agotado. -${bet}`:`‚ùå Incorrecto. -${bet}`);
      play("snd-wrong");
    }
    await supabase.from("users").update({coins:me.coins}).eq("id",me.id);
  }

  qInLevel++; updateTop();
  if(qInLevel>=5){
    level = Math.min(15, level+1);
    qInLevel = 0; toast(`‚¨ÜÔ∏è ¬°Subiste a Nivel ${level}!`);
  }
  nextQuestion();
}

function updateTop(){
  $("uName").textContent = me.username;
  $("uCoins").textContent = me.coins;
  $("uLevel").textContent = `${level} / 15`;
  $("uQCount").textContent = `${qInLevel}/5`;
}

/* ===================  LOGIN / LOBBY  =================== */
$("btnPlay").onclick = async ()=>{
  const alias = $("alias").value.trim();
  if(!alias){ toast("Ingres√° un alias"); return; }
  // buscar / crear
  let { data: u, error } = await supabase.from("users").select("*").eq("username", alias).maybeSingle();
  if(error){ toast("Error buscando usuario"); return; }
  let created=false;
  if(!u){
    const ins = await supabase.from("users").insert([{ username: alias, coins: 0 }]).select().single();
    if(ins.error){ toast("No se pudo crear el usuario"); return; }
    u = ins.data; created=true;
  }
  me = u;
  // entrenamiento local por jugador
  const key=`train:${alias}`;
  if(created && localStorage.getItem(key)==null){ localStorage.setItem(key,"3"); }
  trainingLeft = parseInt(localStorage.getItem(key)||"0",10);
  inTraining = trainingLeft>0;
  $("trainLeft").textContent=trainingLeft;
  $("trainingBox").classList.toggle("hidden", !inTraining);

  $("lobby").classList.add("hidden");
  $("game").classList.remove("hidden");
  play("snd-start");

  level=1; qInLevel=0; usedIds.clear(); updateTop();
  if(!inTraining && me.coins<500) toast("Necesit√°s monedas para apostar (m√≠nimo 500). Mir√° la tienda.");
  nextQuestion();

  cargarRanking(); cargarChat(); suscribirChat();
  setInterval(cargarRanking, 8000);
};

$("btnBack").onclick = ()=>{
  $("game").classList.add("hidden");
  $("lobby").classList.remove("hidden");
};

/* ===================  TIENDA  =================== */
document.querySelectorAll(".shop button").forEach(b=>{
  b.addEventListener("click", ()=>{
    const url=b.getAttribute("data-url"); const amount=b.getAttribute("data-amount");
    toast(`Ser√°s redirigido a Mercado Pago por ${amount} monedas. Compart√≠ el comprobante en el chat.`);
    window.open(url,"_blank");
  });
});

/* ===================  CHAT  =================== */
$("btnSend").onclick = async ()=>{
  if(!me) return;
  const txt=$("chatText").value.trim();
  if(!txt) return;
  $("chatText").value="";
  play("snd-chat");
  await supabase.from("messages").insert([{ username: me.username, content: txt }]);
};
async function cargarChat(){
  const { data } = await supabase.from("messages").select("*").order("created_at",{ascending:false}).limit(80);
  pintarChat((data||[]).reverse());
}
function pintarChat(rows){
  const c=$("chat"); c.innerHTML="";
  rows.forEach(r=>{
    const d=document.createElement("div"); d.className="msg";
    d.innerHTML=`<span class="alias">${r.username}:</span> <span>${r.content}</span>`;
    c.appendChild(d);
  });
  c.scrollTop=c.scrollHeight;
}
function suscribirChat(){
  supabase.channel('realtime:messages')
    .on('postgres_changes',{event:'INSERT',schema:'public',table:'messages'}, payload=>{
      const r = payload.new;
      const c=$("chat"); const d=document.createElement("div"); d.className="msg";
      d.innerHTML=`<span class="alias">${r.username}:</span> <span>${r.content}</span>`;
      c.appendChild(d); c.scrollTop=c.scrollHeight;
    }).subscribe();
}

/* ===================  RANKING  =================== */
async function cargarRanking(){
  const { data } = await supabase.from("users").select("username,coins").order("coins",{ascending:false}).limit(20);
  const r=$("ranking"); r.innerHTML="";
  (data||[]).forEach((u,i)=>{
    const d=document.createElement("div"); d.className="r";
    d.textContent = `#${i+1} ${u.username} ‚Äî ${u.coins} monedas`;
    r.appendChild(d);
  });
}

/* ===================  PERSISTENCIA ENTRENAMIENTO  =================== */
window.addEventListener("beforeunload", ()=>{
  if(me){ localStorage.setItem(`train:${me.username}`, String(trainingLeft)); }
});
</script>
</body>
</html>
