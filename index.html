<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trivia Rugby Argentina</title>
  <style>
    /* ==============================
       üé® ESTILOS GENERALES
       ============================== */
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #ff4081, #7c4dff, #40c4ff);
      color: #fff;
      text-align: center;
      overflow-x: hidden;
    }

    header {
      background: url("https://i.ibb.co/YXkT8fc/banner-rugby.jpg") no-repeat center/cover;
      height: 220px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 2.5em;
      font-weight: bold;
      text-shadow: 2px 2px 6px black;
      animation: fadeIn 2s ease-in-out;
    }

    h2 {
      margin-top: 15px;
      animation: fadeIn 1.5s ease-in-out;
    }

    .hidden { display: none; }

    button {
      background: linear-gradient(45deg, #ff9800, #ff5722);
      border: none;
      padding: 12px 20px;
      border-radius: 30px;
      color: white;
      font-size: 1em;
      margin: 10px;
      cursor: pointer;
      transition: transform 0.2s, background 0.3s;
    }

    button:hover {
      transform: scale(1.1);
      background: linear-gradient(45deg, #ff5722, #d32f2f);
    }

    input {
      padding: 10px;
      border-radius: 20px;
      border: none;
      margin: 8px;
      width: 200px;
      text-align: center;
    }

    /* ==============================
       üü¶ SECCIONES
       ============================== */
    section {
      padding: 20px;
      margin: 15px auto;
      width: 90%;
      max-width: 800px;
      border-radius: 15px;
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(8px);
      box-shadow: 0 6px 18px rgba(0,0,0,0.3);
      animation: fadeSlide 1s ease-in-out;
    }

    /* CHAT */
    #chatBox {
      background: #fafafa;
      color: black;
      border-radius: 12px;
      height: 200px;
      overflow-y: auto;
      padding: 10px;
      text-align: left;
    }

    /* RANKING */
    #rankingList {
      list-style: none;
      padding: 0;
    }
    #rankingList li {
      padding: 8px;
      margin: 5px 0;
      border-radius: 10px;
      animation: slideIn 0.5s ease;
    }
    #rankingList li:nth-child(1) { background: gold; color: black; }
    #rankingList li:nth-child(2) { background: silver; color: black; }
    #rankingList li:nth-child(3) { background: #cd7f32; color: white; }

    /* ADMIN */
    #adminPanel {
      background: linear-gradient(135deg, #000, #b71c1c);
      color: white;
      border: 2px solid #ff1744;
    }

    /* TIENDA */
    #store button {
      background: linear-gradient(45deg, #00c853, #1de9b6);
    }

    /* PREGUNTAS */
    #questionText {
      font-size: 1.3em;
      font-weight: bold;
      margin: 20px 0;
      animation: fadeIn 1s ease-in-out;
    }

    #answers button {
      display: block;
      margin: 10px auto;
      width: 80%;
      animation: popIn 0.4s ease;
    }

    /* TIMER */
    #timer {
      font-size: 1.2em;
      font-weight: bold;
      margin: 10px 0;
    }

    /* LOGOUT */
    #logoutBtn {
      background: linear-gradient(45deg, #607d8b, #263238);
    }

    /* ==============================
       üì± RESPONSIVE
       ============================== */
    @media (max-width: 600px) {
      header { font-size: 1.5em; height: 150px; }
      section { width: 95%; padding: 10px; }
      input { width: 150px; }
      button { font-size: 0.9em; padding: 10px 15px; }
    }

    /* ==============================
       ‚ú® ANIMACIONES
       ============================== */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes slideIn {
      from { transform: translateX(-50px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes fadeSlide {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes popIn {
      from { transform: scale(0.5); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
  </style>
</head>
<body>
  <!-- ==============================
       BANNER
       ============================== -->
  <header>üèâ Trivia Rugby Argentina</header>

  <!-- LOGIN -->
  <section id="loginSection">
    <h2>üîë Iniciar Sesi√≥n</h2>
    <input type="text" id="username" placeholder="Usuario"><br>
    <button onclick="login()">Ingresar</button>
    <button onclick="adminLogin()">Admin</button>
  </section>

  <!-- JUEGO -->
  <section id="gameSection" class="hidden">
    <h2>Pregunta</h2>
    <div id="questionText">Haz clic en jugar para empezar</div>
    <div id="answers"></div>
    <div id="timer">‚è±Ô∏è 20s</div>
    <button onclick="loadQuestion()">‚ñ∂Ô∏è Jugar</button>
  </section>

  <!-- RANKING -->
  <section id="rankingSection" class="hidden">
    <h2>üèÜ Ranking</h2>
    <ul id="rankingList"></ul>
  </section>

  <!-- CHAT -->
  <section id="chatSection" class="hidden">
    <h2>üí¨ Chat</h2>
    <div id="chatBox"></div>
    <input type="text" id="chatInput" placeholder="Escribe un mensaje">
    <button onclick="sendMessage()">Enviar</button>
  </section>

  <!-- TIENDA -->
  <section id="store" class="hidden">
    <h2>üõí Tienda</h2>
    <button onclick="buyCoins(100)">Comprar 100 monedas</button>
    <button onclick="buyCoins(500)">Comprar 500 monedas</button>
    <button onclick="buyCoins(1000)">Comprar 1000 monedas</button>
  </section>

  <!-- ADMIN -->
  <section id="adminPanel" class="hidden">
    <h2>‚öôÔ∏è Panel de Administraci√≥n</h2>
    <input type="text" id="targetUser" placeholder="Usuario objetivo"><br>
    <input type="number" id="coinAmount" placeholder="Cantidad de monedas"><br>
    <button onclick="addCoins()">‚ûï Sumar monedas</button>
    <button onclick="removeCoins()">‚ûñ Restar monedas</button><br>
    <button onclick="blockUser()">üö´ Bloquear usuario</button><br>
    <input type="text" id="deleteMessageId" placeholder="ID mensaje a borrar"><br>
    <button onclick="deleteMessage()">üóëÔ∏è Borrar mensaje</button>
  </section>

  <!-- LOGOUT -->
  <section id="logoutSection" class="hidden">
    <button id="logoutBtn" onclick="logout()">Cerrar Sesi√≥n</button>
  </section>

  <!-- SONIDOS -->
  <audio id="correctSound" src="https://www.soundjay.com/button/beep-07.wav"></audio>
  <audio id="wrongSound" src="https://www.soundjay.com/button/beep-10.wav"></audio>

  <!-- ==============================
       üìú JAVASCRIPT
       ============================== -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    const supabaseUrl = "https://TU-PROJECT.supabase.co";
    const supabaseKey = "TU-API-KEY";
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    let currentUser = null;
    let currentLevel = 1;
    let timerInterval = null;
    let currentQuestion = null;

    // ------------------------
    // LOGIN
    // ------------------------
    async function login() {
      const username = document.getElementById("username").value.trim();
      if (!username) return alert("Ingresa un nombre de usuario");

      let { data, error } = await supabaseClient
        .from("users")
        .select("*")
        .eq("username", username)
        .maybeSingle();

      if (!data) {
        let { data: newUser } = await supabaseClient
          .from("users")
          .insert([{ username }])
          .select()
          .single();
        currentUser = newUser;
      } else {
        currentUser = data;
      }

      document.getElementById("loginSection").classList.add("hidden");
      document.getElementById("gameSection").classList.remove("hidden");
      document.getElementById("rankingSection").classList.remove("hidden");
      document.getElementById("chatSection").classList.remove("hidden");
      document.getElementById("store").classList.remove("hidden");
      document.getElementById("logoutSection").classList.remove("hidden");

      loadRanking();
      loadMessages();
    }

    function adminLogin() {
      const pass = prompt("Clave admin:");
      if (pass === "admin123") {
        document.getElementById("adminPanel").classList.remove("hidden");
      } else {
        alert("Clave incorrecta");
      }
    }

    function logout() {
      currentUser = null;
      currentLevel = 1;
      document.querySelectorAll("section").forEach(s => s.classList.add("hidden"));
      document.getElementById("loginSection").classList.remove("hidden");
    }

    // ------------------------
    // RANKING
    // ------------------------
    async function loadRanking() {
      let { data } = await supabaseClient
        .from("users")
        .select("username, coins")
        .order("coins", { ascending: false })
        .limit(10);

      const list = document.getElementById("rankingList");
      list.innerHTML = "";
      data.forEach((u, i) => {
        let medal = i === 0 ? "ü•á" : i === 1 ? "ü•à" : i === 2 ? "ü•â" : "";
        let li = document.createElement("li");
        li.textContent = `${medal} ${u.username} ‚Äî ${u.coins} monedas`;
        list.appendChild(li);
      });
    }

    // ------------------------
    // CHAT
    // ------------------------
    async function sendMessage() {
      const msg = document.getElementById("chatInput").value.trim();
      if (!msg) return;
      await supabaseClient.from("chat").insert([{ user_id: currentUser.id, message: msg }]);
      document.getElementById("chatInput").value = "";
      loadMessages();
    }

    async function loadMessages() {
      let { data } = await supabaseClient
        .from("chat")
        .select("id, message, created_at, users(username)")
        .order("created_at", { ascending: false })
        .limit(10);

      const box = document.getElementById("chatBox");
      box.innerHTML = "";
      data.forEach(m => {
        let div = document.createElement("div");
        div.textContent = `[${new Date(m.created_at).toLocaleTimeString()}] ${m.users.username}: ${m.message}`;
        box.appendChild(div);
      });
    }

    // ------------------------
    // ADMIN
    // ------------------------
    async function addCoins() {
      const user = document.getElementById("targetUser").value;
      const amount = parseInt(document.getElementById("coinAmount").value);
      if (!user || isNaN(amount)) return;
      await supabaseClient.rpc("add_coins", { uname: user, qty: amount });
      loadRanking();
    }

    async function removeCoins() {
      const user = document.getElementById("targetUser").value;
      const amount = parseInt(document.getElementById("coinAmount").value);
      if (!user || isNaN(amount)) return;
      await supabaseClient.rpc("remove_coins", { uname: user, qty: amount });
      loadRanking();
    }

    async function blockUser() {
      const user = document.getElementById("targetUser").value;
      await supabaseClient.from("users").update({ blocked: true }).eq("username", user);
      alert(`Usuario ${user} bloqueado`);
    }

    async function deleteMessage() {
      const id = document.getElementById("deleteMessageId").value;
      if (!id) return;
      await supabaseClient.from("chat").delete().eq("id", id);
      loadMessages();
    }

    // ------------------------
    // TIENDA
    // ------------------------
    function buyCoins(amount) {
      alert(`üëâ Simulaci√≥n de compra de ${amount} monedas con MercadoPago`);
    }

    // ------------------------
    // PREGUNTAS
    // ------------------------
    async function loadQuestion() {
      let { data } = await supabaseClient
        .from("questions")
        .select("*")
        .eq("level", currentLevel);

      if (!data || data.length === 0) {
        alert("üéâ ¬°Ganaste! No hay m√°s preguntas.");
        return;
      }

      currentQuestion = data[Math.floor(Math.random() * data.length)];
      document.getElementById("questionText").textContent = currentQuestion.question;

      const answersDiv = document.getElementById("answers");
      answersDiv.innerHTML = "";

      [["A", currentQuestion.option_a], ["B", currentQuestion.option_b], ["C", currentQuestion.option_c]].forEach(opt => {
        let btn = document.createElement("button");
        btn.textContent = opt[1];
        btn.onclick = () => checkAnswer(opt[0]);
        answersDiv.appendChild(btn);
      });

      startTimer();
    }

    function startTimer() {
      let time = 20;
      document.getElementById("timer").textContent = `‚è±Ô∏è ${time}s`;
      clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        time--;
        document.getElementById("timer").textContent = `‚è±Ô∏è ${time}s`;
        if (time <= 0) {
          clearInterval(timerInterval);
          checkAnswer(null);
        }
      }, 1000);
    }

    async function checkAnswer(opt) {
      clearInterval(timerInterval);
      if (!currentQuestion) return;

      if (opt === currentQuestion.correct_option) {
        document.getElementById("correctSound").play();
        alert("‚úÖ Correcto!");
        await supabaseClient.from("users").update({ coins: currentUser.coins + 500 }).eq("id", currentUser.id);
        currentLevel++;
      } else {
        document.getElementById("wrongSound").play();
        alert("‚ùå Incorrecto");
        await supabaseClient.from("users").update({ coins: Math.max(0, currentUser.coins - 200) }).eq("id", currentUser.id);
      }

      loadRanking();
      loadQuestion();
    }
  </script>
</body>
</html>
