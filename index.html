<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Rugby Preguntados</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: radial-gradient(circle, #3b82f6, #1e3a8a);
      color: white;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    h1 {
      font-size: 2.5rem;
      margin: 20px 0;
      text-shadow: 2px 2px #000;
    }
    .container {
      max-width: 1000px;
      margin: auto;
      padding: 20px;
    }
    button {
      padding: 10px 20px;
      margin: 10px;
      border: none;
      border-radius: 8px;
      background: #facc15;
      color: #000;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s;
    }
    button:hover {
      transform: scale(1.1);
    }
    .hidden { display: none; }

    /* Preguntas estilo Preguntados */
    .question-box {
      background: white;
      color: black;
      border-radius: 20px;
      padding: 20px;
      margin: 20px auto;
      max-width: 600px;
      animation: fadeIn 0.6s ease-in-out;
    }
    .option {
      background: #3b82f6;
      color: white;
      padding: 15px;
      border-radius: 10px;
      margin: 10px 0;
      cursor: pointer;
      transition: 0.3s;
    }
    .option:hover {
      background: #1d4ed8;
    }

    /* Chat */
    #chat-box {
      background: rgba(0,0,0,0.5);
      border-radius: 10px;
      padding: 10px;
      height: 200px;
      overflow-y: auto;
      margin-bottom: 10px;
      text-align: left;
      font-size: 14px;
    }

    /* Ranking */
    #ranking {
      margin-top: 20px;
      background: rgba(255,255,255,0.1);
      border-radius: 15px;
      padding: 15px;
    }
    #ranking h2 {
      margin-bottom: 10px;
    }
    .rank-item {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
      border-bottom: 1px solid rgba(255,255,255,0.3);
    }

    /* Notificaciones */
    #notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #22c55e;
      color: white;
      padding: 15px;
      border-radius: 10px;
      display: none;
      animation: fadeIn 0.5s ease-in-out;
    }

    /* Animaciones */
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    /* Panel admin */
    #admin-panel {
      background: rgba(0,0,0,0.7);
      padding: 20px;
      border-radius: 15px;
    }
  </style>
</head>
<body>
  <h1>🏉 Rugby Preguntados</h1>
  <div class="container">

    <!-- LOGIN -->
    <div id="login-screen">
      <h2>Iniciar Sesión</h2>
      <input id="username" placeholder="Tu alias" />
      <button onclick="loginUser()">Entrar</button>
      <br>
      <h3>Login Admin</h3>
      <input id="adminToken" placeholder="Token admin" />
      <button onclick="loginAdmin()">Entrar Admin</button>
    </div>

    <!-- PANEL PRINCIPAL -->
    <div id="main-screen" class="hidden">
      <h2 id="welcome"></h2>
      <p>💰 Monedas: <span id="coins">0</span></p>
      <button onclick="startGame()">🎮 Jugar</button>
      <button onclick="showPacks()">💰 Comprar Monedas</button>

      <!-- CHAT -->
      <h3>💬 Chat en vivo</h3>
      <div id="chat-box"></div>
      <input id="chat-input" placeholder="Escribe tu mensaje..." />
      <button onclick="sendMessage()">Enviar</button>

      <!-- RANKING -->
      <div id="ranking">
        <h2>🏆 Ranking TOP 10</h2>
        <div id="ranking-list"></div>
      </div>

      <button onclick="logout()">Cerrar Sesión</button>
    </div>

    <!-- PREGUNTAS -->
    <div id="game-screen" class="hidden">
      <h2>Nivel <span id="current-level">1</span></h2>
      <p>Apuesta mínima: 500 monedas</p>
      <input id="bet-amount" type="number" min="500" value="500" />
      <button onclick="startQuestion()">Iniciar Pregunta</button>
      <div id="question-container"></div>
      <p id="timer"></p>
      <button onclick="backToMenu()">⬅️ Volver al Menú</button>
    </div>

    <!-- PACKS -->
    <div id="packs-screen" class="hidden">
      <h2>Comprar Monedas</h2>
      <button onclick="buyCoins(1000)">1000 monedas - $1 USD</button>
      <button onclick="buyCoins(5000)">5000 monedas - $4 USD</button>
      <button onclick="buyCoins(10000)">10000 monedas - $7 USD</button>
      <br>
      <button onclick="backToMenu()">⬅️ Volver</button>
    </div>

    <!-- PANEL ADMIN -->
    <div id="admin-panel" class="hidden">
      <h2>Panel Admin</h2>
      <input id="targetUser" placeholder="Usuario" />
      <input id="coinAmount" type="number" placeholder="Cantidad monedas" />
      <button onclick="addCoins()">Cargar</button>
      <button onclick="removeCoins()">Restar</button>
      <br><br>
      <button onclick="blockUser()">Bloquear Usuario</button>
      <button onclick="deleteMessages()">Eliminar Mensajes</button>
      <button onclick="logout()">Cerrar Sesión</button>
    </div>
  </div>

  <!-- Notificación -->
  <div id="notification"></div>

  <!-- Sonidos -->
  <audio id="sound-correct" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>
  <audio id="sound-wrong" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>
  <audio id="sound-levelup" src="https://actions.google.com/sounds/v1/cartoon/woodpecker.ogg"></audio>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <script>
    const SUPABASE_URL = "https://aqkqbtunbyifbfrvkpxv.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFxa3FidHVuYnlpZmJmcnZrcHh2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyOTg5NDgsImV4cCI6MjA3MDg3NDk0OH0.Xqtii5yiIO6tFOzzqza70ZA7N1KmbcTIkoNtV5YCVDY";
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentUser = null;
    let coins = 0;
    let currentLevel = 1;
    let currentQuestion = null;
    let timerInterval;

    async function loginUser() {
      const username = document.getElementById("username").value.trim();
      if (!username) return alert("Ingresá un alias");
      let { data: user, error } = await supabase.from("users").select("*").eq("username", username).single();
      if (!user) {
        await supabase.from("users").insert([{ username, coins: 1500 }]);
        user = { username, coins: 1500 };
      }
      currentUser = user;
      coins = user.coins;
      document.getElementById("welcome").innerText = `Bienvenido ${username}`;
      document.getElementById("coins").innerText = coins;
      showScreen("main-screen");
      loadChat();
      loadRanking();
    }

    async function loginAdmin() {
      const token = document.getElementById("adminToken").value;
      if (token === "20250819802006") {
        showScreen("admin-panel");
      } else {
        alert("Token inválido");
      }
    }

    function logout() {
      currentUser = null;
      showScreen("login-screen");
    }

    function showScreen(id) {
      document.querySelectorAll(".container > div").forEach(div => div.classList.add("hidden"));
      document.getElementById(id).classList.remove("hidden");
    }

    function backToMenu() {
      showScreen("main-screen");
      loadRanking();
    }

    function notify(msg, color = "#22c55e") {
      const notif = document.getElementById("notification");
      notif.innerText = msg;
      notif.style.background = color;
      notif.style.display = "block";
      setTimeout(() => notif.style.display = "none", 3000);
    }

    // CHAT
    async function loadChat() {
      const { data } = await supabase.from("chat").select("*, users(username)").order("created_at", { ascending: true });
      const chatBox = document.getElementById("chat-box");
      chatBox.innerHTML = "";
      data.forEach(m => {
        const time = new Date(m.created_at).toLocaleTimeString();
        chatBox.innerHTML += `<p><b>${m.users.username}</b> [${time}]: ${m.message}</p>`;
      });
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    async function sendMessage() {
      const msg = document.getElementById("chat-input").value.trim();
      if (!msg || !currentUser) return;
      await supabase.from("chat").insert([{ user_id: currentUser.id, message: msg }]);
      document.getElementById("chat-input").value = "";
      loadChat();
    }

    // RANKING
    async function loadRanking() {
      const { data } = await supabase.from("users").select("username, coins").order("coins", { ascending: false }).limit(10);
      const rankDiv = document.getElementById("ranking-list");
      rankDiv.innerHTML = "";
      data.forEach((u, i) => {
        rankDiv.innerHTML += `<div class="rank-item"><span>🏅 ${i+1}. ${u.username}</span><span>${u.coins} 💰</span></div>`;
      });
    }

    // GAME
    async function startGame() {
      currentLevel = 1;
      showScreen("game-screen");
      document.getElementById("current-level").innerText = currentLevel;
    }

    async function startQuestion() {
      const bet = parseInt(document.getElementById("bet-amount").value);
      if (bet < 500 || bet > coins) return alert("Apuesta inválida");
      const { data } = await supabase.from("questions").select("*").eq("level", currentLevel).order("random()").limit(1);
      if (!data || !data.length) return notify("No hay más preguntas", "red");
      currentQuestion = data[0];
      document.getElementById("question-container").innerHTML = `
        <div class="question-box">
          <h3>${currentQuestion.question}</h3>
          <div class="option" onclick="answer('A', ${bet})">${currentQuestion.option_a}</div>
          <div class="option" onclick="answer('B', ${bet})">${currentQuestion.option_b}</div>
          <div class="option" onclick="answer('C', ${bet})">${currentQuestion.option_c}</div>
        </div>
      `;
      startTimer(20, bet);
    }

    function startTimer(seconds, bet) {
      let timeLeft = seconds;
      document.getElementById("timer").innerText = `⏳ ${timeLeft}s`;
      clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        timeLeft--;
        document.getElementById("timer").innerText = `⏳ ${timeLeft}s`;
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          answer("TIMEOUT", bet);
        }
      }, 1000);
    }

    async function answer(choice, bet) {
      clearInterval(timerInterval);
      if (choice === currentQuestion.correct_option) {
        coins += bet;
        document.getElementById("coins").innerText = coins;
        notify("✅ Respuesta Correcta! +" + bet + " monedas");
        document.getElementById("sound-correct").play();
        currentLevel++;
        if (currentLevel > 15) {
          notify("🎉 Terminaste todos los niveles!", "#facc15");
        } else {
          document.getElementById("current-level").innerText = currentLevel;
          document.getElementById("sound-levelup").play();
        }
      } else {
        coins -= bet;
        document.getElementById("coins").innerText = coins;
        notify("❌ Respuesta Incorrecta -" + bet + " monedas", "red");
        document.getElementById("sound-wrong").play();
      }
      await supabase.from("users").update({ coins }).eq("username", currentUser.username);
    }

    // PACKS
    async function buyCoins(amount) {
      coins += amount;
      document.getElementById("coins").innerText = coins;
      await supabase.from("users").update({ coins }).eq("username", currentUser.username);
      notify("Compraste " + amount + " monedas!");
    }

    // ADMIN
    async function addCoins() {
      const user = document.getElementById("targetUser").value;
      const amt = parseInt(document.getElementById("coinAmount").value);
      await supabase.rpc("increment_coins", { username_input: user, amount: amt });
      notify("Monedas cargadas a " + user);
    }
    async function removeCoins() {
      const user = document.getElementById("targetUser").value;
      const amt = parseInt(document.getElementById("coinAmount").value);
      await supabase.rpc("increment_coins", { username_input: user, amount: -amt });
      notify("Monedas restadas a " + user, "red");
    }
    async function blockUser() {
      const user = document.getElementById("targetUser").value;
      await supabase.from("users").update({ blocked: true }).eq("username", user);
      notify(user + " bloqueado", "red");
    }
    async function deleteMessages() {
      const user = document.getElementById("targetUser").value;
      const { data } = await supabase.from("users").select("id").eq("username", user).single();
      if (data) {
        await supabase.from("chat").delete().eq("user_id", data.id);
        notify("Mensajes de " + user + " borrados");
      }
    }
  </script>
</body>
</html>
