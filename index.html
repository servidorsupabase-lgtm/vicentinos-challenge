<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Viventinos Challenge</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">

  <style>
    /* -------------------------
       ESTILO GENERAL - PREGUNTADOS
    --------------------------*/
    body {
      font-family: 'Fredoka One', cursive;
      margin: 0;
      background: linear-gradient(135deg, #001f54, #004aad, #00c6ff);
      color: white;
      text-align: center;
      overflow-x: hidden;
    }

    h1, h2, h3 {
      text-shadow: 2px 2px 6px rgba(0,0,0,0.8);
    }

    img.banner {
      width: 100%;
      max-height: 220px;
      object-fit: cover;
      border-bottom: 5px solid gold;
      animation: slideDown 1.5s ease-out;
    }

    @keyframes slideDown {
      from { transform: translateY(-100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .container {
      display: none;
      padding: 20px;
      margin: 20px auto;
      max-width: 600px;
      border-radius: 15px;
      box-shadow: 0 0 25px rgba(0,0,0,0.5);
      animation: fadeIn 1s ease-in-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    input, button {
      padding: 12px;
      margin: 8px;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
    }

    input {
      width: 220px;
    }

    button {
      background: linear-gradient(45deg, #FFD700, #FFA500);
      color: black;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 0 12px rgba(255, 215, 0, 0.8);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    button:hover {
      transform: scale(1.1) rotate(-1deg);
      box-shadow: 0 0 20px rgba(255, 255, 0, 1);
    }

    /* -------------------------
       LOGIN
    --------------------------*/
    .login {
      background: rgba(0,0,0,0.6);
    }

    /* -------------------------
       GAME
    --------------------------*/
    .game {
      background: rgba(0,0,50,0.7);
      border: 2px solid #00c6ff;
    }
    #questionText {
      font-size: 1.4rem;
      margin: 15px 0;
      animation: fadeIn 0.8s ease;
    }

    /* -------------------------
       CHAT
    --------------------------*/
    .chat {
      background: rgba(255,255,255,0.1);
      border: 2px solid #ccc;
    }
    #messages {
      height: 220px;
      overflow-y: auto;
      border: 2px solid gold;
      padding: 12px;
      text-align: left;
      background: rgba(0,0,0,0.4);
      border-radius: 10px;
      margin-bottom: 10px;
      animation: fadeIn 1s ease;
    }
    .msg {
      margin: 6px 0;
      padding: 8px;
      border-radius: 8px;
      animation: fadeIn 0.5s ease;
    }
    .msg.user { background: #004aad; }
    .msg.other { background: #0066cc; }

    /* -------------------------
       RANKING
    --------------------------*/
    .ranking {
      background: rgba(0,50,0,0.6);
      border: 2px solid lime;
    }
    #rankingList {
      list-style: none;
      padding: 0;
    }
    #rankingList li {
      margin: 6px;
      padding: 10px;
      border-radius: 8px;
      background: rgba(255,255,255,0.1);
      font-size: 1.2rem;
      animation: slideIn 0.6s ease;
    }
    #rankingList li:nth-child(1) { background: gold; color: black; font-weight: bold; }
    #rankingList li:nth-child(2) { background: silver; color: black; }
    #rankingList li:nth-child(3) { background: #cd7f32; color: black; }

    @keyframes slideIn {
      from { transform: translateX(-50%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* -------------------------
       ADMIN
    --------------------------*/
    .admin {
      background: rgba(100,0,0,0.8);
      border: 2px solid red;
    }
    .admin button {
      background: linear-gradient(45deg, red, darkred);
      color: white;
    }

    /* -------------------------
       TIENDA
    --------------------------*/
    .store {
      background: rgba(0,0,0,0.6);
      border: 2px solid orange;
    }
    .store button {
      width: 90%;
      margin: 10px auto;
      display: block;
      font-size: 1.1rem;
    }

    /* -------------------------
       NOTIFICACIONES
    --------------------------*/
    .notification {
      position: fixed;
      top: 15px;
      right: 15px;
      background: gold;
      color: black;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: bold;
      animation: fadeout 3s forwards;
      z-index: 999;
    }
    @keyframes fadeout {
      0% { opacity: 1; }
      70% { opacity: 1; }
      100% { opacity: 0; }
    }

    /* -------------------------
       RESPONSIVE
    --------------------------*/
    @media (max-width: 600px) {
      h1 { font-size: 1.8rem; }
      .container { max-width: 90%; padding: 15px; }
      button { font-size: 0.9rem; padding: 10px; }
      input { width: 100%; }
    }
  </style>
</head>
<body>
  <!-- Banner -->
  <img src="https://i.ibb.co/kVGptVnJ/wp2896798.jpg" alt="Banner" class="banner">

  <h1>üèâ Viventinos Challenge üèâ</h1>

  <!-- LOGIN -->
  <div class="container login" id="loginContainer" style="display:block;">
    <h2>Iniciar Sesi√≥n</h2>
    <input type="text" id="username" placeholder="Nombre de usuario">
    <button onclick="loginUser()">Entrar</button>
    <h3>Admin</h3>
    <input type="password" id="adminToken" placeholder="Token admin">
    <button onclick="loginAdmin()">Entrar Admin</button>
  </div>

  <!-- GAME -->
  <div class="container game" id="gameContainer">
    <h2 id="questionTitle">Pregunta</h2>
    <p id="questionText"></p>
    <button id="optionA" onclick="answer('A')"></button>
    <button id="optionB" onclick="answer('B')"></button>
    <button id="optionC" onclick="answer('C')"></button>
    <p id="levelInfo"></p>
    <button onclick="logout()">üîô Volver al Men√∫</button>
  </div>

  <!-- CHAT -->
  <div class="container chat" id="chatContainer">
    <h2>Chat en Vivo</h2>
    <div id="messages"></div>
    <input type="text" id="chatInput" placeholder="Escribe un mensaje">
    <button onclick="sendMessage()">Enviar</button>
  </div>
  <!-- RANKING -->
  <div class="container ranking" id="rankingContainer">
    <h2>üèÜ Ranking</h2>
    <ul id="rankingList"></ul>
    <button onclick="logout()">üîô Volver al Men√∫</button>
  </div>

  <!-- TIENDA -->
  <div class="container store" id="storeContainer">
    <h2>üõí Comprar Monedas</h2>
    <p>Elige un pack y paga con MercadoPago. Una vez abonado, se acreditan manualmente.</p>
    <button onclick="window.open('https://mpago.la/16CyPeY','_blank')">Pack $2000 (2000 monedas)</button>
    <button onclick="window.open('https://mpago.la/1TTVVcV','_blank')">Pack $5000 (5000 monedas)</button>
    <button onclick="window.open('https://mpago.la/2HR6fjA','_blank')">Pack $10000 (10000 monedas)</button>
    <button onclick="logout()">üîô Volver al Men√∫</button>
  </div>

  <!-- PANEL ADMIN -->
  <div class="container admin" id="adminContainer">
    <h2>üëë Panel de Administrador</h2>

    <h3>Gesti√≥n de Usuarios</h3>
    <input type="text" id="targetUser" placeholder="Usuario">
    <input type="number" id="coinAmount" placeholder="Cantidad monedas">
    <button onclick="addCoins()">‚ûï Sumar</button>
    <button onclick="removeCoins()">‚ûñ Restar</button>
    <button onclick="blockUser()">üö´ Bloquear</button>

    <h3>Gesti√≥n de Chat</h3>
    <input type="text" id="deleteMessageId" placeholder="ID mensaje">
    <button onclick="deleteMessage()">üóëÔ∏è Borrar Mensaje</button>

    <button onclick="logout()">üîô Cerrar Sesi√≥n</button>
  </div>

  <!-- SONIDOS -->
  <audio id="correctSound" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>
  <audio id="wrongSound" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>

  <!-- SCRIPTS SUPABASE -->
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <script>
    const SUPABASE_URL = "https://aqkqbtunbyifbfrvkpxv.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFxa3FidHVuYnlpZmJmcnZrcHh2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyOTg5NDgsImV4cCI6MjA3MDg3NDk0OH0.Xqtii5yiIO6tFOzzqza70ZA7N1KmbcTIkoNtV5YCVDY";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentUser = null;
    let isAdmin = false;
    let currentLevel = 1;

    // ------------------------
    // LOGIN USUARIO
    // ------------------------
    async function loginUser() {
      const username = document.getElementById("username").value.trim();
      if (!username) {
        showNotification("‚ö†Ô∏è Ingres√° un nombre de usuario");
        return;
      }

      let { data, error } = await supabaseClient
        .from("usuarios")
        .select("*")
        .eq("username", username)
        .maybeSingle();

      if (!data) {
        // crear nuevo
        const { data: newUser, error: insertError } = await supabaseClient
          .from("usuarios")
          .insert([{ username: username, monedas: 1000, nivel: 1, bloqueado: false }])
          .select()
          .single();
        currentUser = newUser;
        showNotification("Bienvenido üéâ Se te acreditaron 1000 monedas iniciales.");
      } else {
        if (data.bloqueado) {
          showNotification("üö´ Usuario bloqueado por el admin");
          return;
        }
        currentUser = data;
        showNotification("Bienvenido de nuevo " + username + " üôå");
      }

      isAdmin = false;
      switchToGame();
    }

    // ------------------------
    // LOGIN ADMIN
    // ------------------------
    function loginAdmin() {
      const token = document.getElementById("adminToken").value.trim();
      if (token === "admin123") {
        isAdmin = true;
        currentUser = { username: "ADMIN" };
        document.getElementById("loginContainer").style.display = "none";
        document.getElementById("adminContainer").style.display = "block";
        showNotification("‚úÖ Acceso Admin concedido");
      } else {
        showNotification("‚ùå Token inv√°lido");
      }
    }

    // ------------------------
    // SWITCH A GAME
    // ------------------------
    function switchToGame() {
      document.getElementById("loginContainer").style.display = "none";
      document.getElementById("gameContainer").style.display = "block";
      document.getElementById("chatContainer").style.display = "block";
      document.getElementById("rankingContainer").style.display = "block";
      document.getElementById("storeContainer").style.display = "block";
      loadRanking();
      loadMessages();
      loadQuestion();
    }

    // ------------------------
    // LOGOUT
    // ------------------------
    function logout() {
      currentUser = null;
      isAdmin = false;
      currentLevel = 1;
      document.querySelectorAll(".container").forEach(c => c.style.display = "none");
      document.getElementById("loginContainer").style.display = "block";
    }

    // ------------------------
    // NOTIFICACIONES
    // ------------------------
    function showNotification(msg) {
      const n = document.createElement("div");
      n.className = "notification";
      n.innerText = msg;
      document.body.appendChild(n);
      setTimeout(() => n.remove(), 3000);
    }
    // ------------------------
    // CARGAR RANKING
    // ------------------------
    async function loadRanking() {
      let { data, error } = await supabaseClient
        .from("usuarios")
        .select("username, monedas")
        .order("monedas", { ascending: false })
        .limit(10);

      const list = document.getElementById("rankingList");
      list.innerHTML = "";
      if (data) {
        data.forEach((user, idx) => {
          let medal = "";
          if (idx === 0) medal = "ü•á";
          else if (idx === 1) medal = "ü•à";
          else if (idx === 2) medal = "ü•â";
          const li = document.createElement("li");
          li.textContent = `${medal} ${user.username} ‚Äî ${user.monedas} monedas`;
          list.appendChild(li);
        });
      }
    }

    // ------------------------
    // CHAT
    // ------------------------
    async function sendMessage() {
      const input = document.getElementById("chatInput");
      const message = input.value.trim();
      if (!message) return;

      await supabaseClient.from("mensajes").insert([
        { usuario: currentUser.username, mensaje: message }
      ]);

      input.value = "";
      loadMessages();
    }

    async function loadMessages() {
      let { data, error } = await supabaseClient
        .from("mensajes")
        .select("*")
        .order("fecha", { ascending: false })
        .limit(10);

      const box = document.getElementById("chatBox");
      box.innerHTML = "";
      if (data) {
        data.forEach(msg => {
          const div = document.createElement("div");
          div.textContent = `[${new Date(msg.fecha).toLocaleTimeString()}] ${msg.usuario}: ${msg.mensaje}`;
          box.appendChild(div);
        });
      }
    }

    // ------------------------
    // ADMIN FUNCIONES
    // ------------------------
    async function addCoins() {
      const user = document.getElementById("targetUser").value;
      const amount = parseInt(document.getElementById("coinAmount").value);
      if (!user || isNaN(amount)) return;

      await supabaseClient.rpc("sumar_monedas", { user_name: user, cantidad: amount });
      showNotification(`Se sumaron ${amount} monedas a ${user}`);
    }

    async function removeCoins() {
      const user = document.getElementById("targetUser").value;
      const amount = parseInt(document.getElementById("coinAmount").value);
      if (!user || isNaN(amount)) return;

      await supabaseClient.rpc("restar_monedas", { user_name: user, cantidad: amount });
      showNotification(`Se restaron ${amount} monedas a ${user}`);
    }

    async function blockUser() {
      const user = document.getElementById("targetUser").value;
      if (!user) return;
      await supabaseClient
        .from("usuarios")
        .update({ bloqueado: true })
        .eq("username", user);
      showNotification(`üö´ Usuario ${user} bloqueado`);
    }

    async function deleteMessage() {
      const id = document.getElementById("deleteMessageId").value;
      if (!id) return;
      await supabaseClient.from("mensajes").delete().eq("id", id);
      showNotification(`üóëÔ∏è Mensaje ${id} borrado`);
      loadMessages();
    }

    // ------------------------
    // PREGUNTAS Y JUEGO
    // ------------------------
    let currentQuestion = null;
    let timerInterval = null;

    async function loadQuestion() {
      let { data, error } = await supabaseClient
        .from("preguntas")
        .select("*")
        .eq("nivel", currentLevel);

      if (!data || data.length === 0) {
        showNotification("üéâ ¬°Felicitaciones! Terminaste el juego.");
        return;
      }

      currentQuestion = data[Math.floor(Math.random() * data.length)];
      document.getElementById("questionText").textContent = currentQuestion.pregunta;

      const answersDiv = document.getElementById("answers");
      answersDiv.innerHTML = "";
      [currentQuestion.opcion1, currentQuestion.opcion2, currentQuestion.opcion3].forEach(op => {
        const btn = document.createElement("button");
        btn.textContent = op;
        btn.onclick = () => checkAnswer(op);
        answersDiv.appendChild(btn);
      });

      startTimer();
    }

    function startTimer() {
      let timeLeft = 20;
      const timerEl = document.getElementById("timer");
      timerEl.textContent = `‚è±Ô∏è ${timeLeft}s`;
      clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        timeLeft--;
        timerEl.textContent = `‚è±Ô∏è ${timeLeft}s`;
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          checkAnswer(null);
        }
      }, 1000);
    }

    async function checkAnswer(selected) {
      clearInterval(timerInterval);

      if (!currentQuestion) return;
      const correct = selected === currentQuestion.respuesta_correcta;

      if (correct) {
        document.getElementById("correctSound").play();
        showNotification("‚úÖ Correcto!");
        await supabaseClient
          .from("usuarios")
          .update({ monedas: currentUser.monedas + 500 })
          .eq("username", currentUser.username);
        currentLevel++;
      } else {
        document.getElementById("wrongSound").play();
        showNotification("‚ùå Incorrecto");
        await supabaseClient
          .from("usuarios")
          .update({ monedas: Math.max(0, currentUser.monedas - 500) })
          .eq("username", currentUser.username);
      }

      loadRanking();
      loadQuestion();
    }

  </script>
</body>
</html>
