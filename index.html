<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Vicentinos Challenge</title>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0; padding: 0;
      background: linear-gradient(135deg, #4facfe, #00f2fe);
      display: flex; justify-content: center; align-items: center;
      min-height: 100vh; color: #333;
    }
    .container {
      width: 95%; max-width: 1000px;
      background: #fff; border-radius: 16px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.25);
      padding: 30px; text-align: center;
    }
    h1 { color: #444; margin-bottom: 10px; }
    h2 { color: #555; }
    .btn {
      padding: 12px 25px; margin: 8px;
      border-radius: 50px; border: none;
      background: linear-gradient(135deg, #4facfe, #00f2fe);
      color: white; font-weight: bold;
      cursor: pointer; transition: 0.2s;
    }
    .btn:hover { transform: scale(1.05); }
    .btn-danger { background: linear-gradient(135deg, #ff416c, #ff4b2b); }
    .section { display: none; }
    .active { display: block; }
    #question-card {
      background: #f7f9fc; padding: 20px; border-radius: 12px;
      margin: 20px 0; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    #options .btn { width: 80%; max-width: 400px; display: block; margin: 12px auto; }
    #timer-bar { width: 100%; background: #ddd; border-radius: 10px; overflow: hidden; margin: 15px 0; }
    #timer-fill { height: 12px; width: 100%; background: linear-gradient(90deg, #4caf50, #8bc34a); transition: width 1s linear; }
    #ranking-list { text-align: left; margin-top: 20px; }
    #ranking-list li {
      background: #f1f1f1; margin: 6px 0; padding: 8px 12px;
      border-radius: 8px; display: flex; justify-content: space-between;
    }
    #chat-box { max-height: 250px; overflow-y: auto; border: 1px solid #ccc; border-radius: 10px; padding: 10px; background: #fafafa; text-align: left; }
    .msg { margin: 5px 0; padding: 8px 12px; border-radius: 12px; max-width: 70%; clear: both; }
    .msg.self { background: #4facfe; color: #fff; float: right; }
    .msg.other { background: #eee; float: left; }
    .msg.admin { background: #ff9800; color: #fff; float: left; }
    #notification {
      position: fixed; top: 20px; right: 20px;
      background: #333; color: white;
      padding: 12px 20px; border-radius: 8px;
      display: none;
    }
    #notification.success { background: #4caf50; }
    #notification.error { background: #f44336; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Vicentinos Challenge üèâ</h1>

    <!-- LOGIN -->
    <div id="login-section" class="section active">
      <h2>Iniciar Sesi√≥n</h2>
      <input type="text" id="alias" placeholder="Alias"><br>
      <input type="password" id="password" placeholder="Contrase√±a / Token"><br>
      <button class="btn" onclick="login()">Entrar</button>
      <button class="btn" onclick="register()">Registrarse</button>
    </div>

    <!-- JUEGO -->
    <div id="game-section" class="section">
      <h2>Nivel <span id="current-level"></span></h2>
      <div id="timer-bar"><div id="timer-fill"></div></div>
      <div id="question-card">
        <p id="question"></p>
        <div id="options"></div>
      </div>
      <button class="btn" onclick="showSection('menu-section')">Men√∫ Principal</button>
    </div>

    <!-- MEN√ö PRINCIPAL -->
    <div id="menu-section" class="section">
      <h2>Men√∫ Principal</h2>
      <button class="btn" onclick="showSection('game-section')">‚ñ∂Ô∏è Jugar</button>
      <button class="btn" onclick="loadRanking()">üèÜ Ranking</button>
      <button class="btn" onclick="loadChat()">üí¨ Chat</button>
      <button class="btn" onclick="showSection('packs-section')">üíµ Comprar Pack</button>
    </div>

    <!-- RANKING -->
    <div id="ranking-section" class="section">
      <h2>üèÜ Ranking</h2>
      <ul id="ranking-list"></ul>
      <button class="btn" onclick="showSection('menu-section')">Men√∫ Principal</button>
    </div>

    <!-- CHAT -->
    <div id="chat-section" class="section">
      <h2>üí¨ Chat</h2>
      <div id="chat-box"></div>
      <input type="text" id="chat-msg" placeholder="Escribir mensaje...">
      <button class="btn" onclick="sendMessage()">Enviar</button>
      <button class="btn" onclick="showSection('menu-section')">Men√∫ Principal</button>
    </div>

    <!-- PACKS -->
    <div id="packs-section" class="section">
      <h2>Comprar Pack</h2>
      <p>Selecciona un pack para seguir jugando:</p>
      <a href="https://mpago.la/16CyPeY" target="_blank" class="btn">$2000 ‚Üí 2000 monedas</a>
      <a href="https://mpago.la/1TTVVcV" target="_blank" class="btn">$5000 ‚Üí 5000 monedas</a>
      <a href="https://mpago.la/2HR6fjA" target="_blank" class="btn">$10000 ‚Üí 10000 monedas</a>
      <button class="btn" onclick="showSection('menu-section')">Men√∫ Principal</button>
    </div>

    <!-- ADMIN -->
    <div id="admin-section" class="section">
      <h2>‚öôÔ∏è Panel Admin</h2>
      <input type="text" id="admin-alias" placeholder="Alias usuario">
      <input type="number" id="admin-amount" placeholder="Monto">
      <button class="btn" onclick="sumarMonedas()">‚ûï Sumar</button>
      <button class="btn btn-danger" onclick="restarMonedas()">‚ûñ Restar</button>
      <button class="btn" onclick="showNotificationGlobal()">üì¢ Notificar a todos</button>
      <button class="btn" onclick="showSection('menu-section')">Men√∫ Principal</button>
    </div>
  </div>

  <div id="notification"></div>

  <script>
    const supabaseUrl = "https://aqkqbtunbyifbfrvkpxv.supabase.co";
    const supabaseKey = "TU_ANON_KEY_AQUI";
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    let currentUser = null;
    let currentLevel = 1;
    let currentQuestion = null;
    let timerInterval = null;
    let freeQuestions = 3;

    function showSection(id) {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    function showNotification(msg, type="success") {
      const n = document.getElementById("notification");
      n.textContent = msg;
      n.className = type;
      n.style.display = "block";
      setTimeout(() => n.style.display = "none", 2000);
    }

    async function register() {
      const alias = document.getElementById("alias").value;
      const password = document.getElementById("password").value;
      await supabase.from("usuarios").insert([{ alias, password }]);
      showNotification("Registro exitoso!");
    }

    async function login() {
      const alias = document.getElementById("alias").value;
      const password = document.getElementById("password").value;
      if (password === "20250819802006") {
        currentUser = { alias: "Admin" };
        showSection("admin-section");
        return;
      }
      const { data } = await supabase.from("usuarios").select("*").eq("alias", alias).eq("password", password).single();
      if (!data) { showNotification("Login incorrecto","error"); return; }
      currentUser = data;
      showNotification("Bienvenido " + alias);
      showSection("menu-section");
    }

    async function loadQuestion() {
      if (freeQuestions <= 0 && currentUser.monedas <= 0) {
        showNotification("Debes comprar un pack para seguir","error");
        showSection("packs-section");
        return;
      }
      const { data } = await supabase.from("preguntas").select("*").eq("nivel", currentLevel);
      currentQuestion = data[Math.floor(Math.random()*data.length)];
      document.getElementById("current-level").textContent = currentLevel;
      document.getElementById("question").textContent = currentQuestion.pregunta;
      const options = JSON.parse(currentQuestion.opciones);
      const optionsEl = document.getElementById("options");
      optionsEl.innerHTML = "";
      options.forEach((opt,i)=>{
        const btn=document.createElement("button");
        btn.className="btn"; btn.textContent=opt;
        btn.onclick=()=>checkAnswer(i);
        optionsEl.appendChild(btn);
      });
      startTimer();
    }

    function startTimer() {
      let time=20; const bar=document.getElementById("timer-fill");
      clearInterval(timerInterval);
      timerInterval=setInterval(()=>{
        time--; bar.style.width=(time/20*100)+"%";
        if(time<=0){ clearInterval(timerInterval); nextQuestion(false); }
      },1000);
    }

    function checkAnswer(i) {
      clearInterval(timerInterval);
      let apuesta = 100;
      if (freeQuestions>0) { freeQuestions--; apuesta=0; }
      if (i===currentQuestion.correcta) {
        currentUser.monedas += apuesta;
        currentLevel++;
        showNotification("‚úÖ Correcto! Ganaste "+apuesta+" monedas");
      } else {
        currentUser.monedas -= apuesta;
        showNotification("‚ùå Incorrecto! Perdiste "+apuesta+" monedas","error");
      }
      if(currentUser.monedas<=0 && freeQuestions<=0){
        showNotification("Sin monedas! Compra un pack.","error");
        showSection("packs-section");
        return;
      }
      setTimeout(loadQuestion,1500);
    }

    async function loadRanking() {
      const { data } = await supabase.from("ranking").select("*").order("puntaje",{ascending:false});
      const list=document.getElementById("ranking-list");
      list.innerHTML=""; data.forEach(r=>{ const li=document.createElement("li"); li.textContent=r.alias+" - "+r.puntaje; list.appendChild(li); });
      showSection("ranking-section");
    }

    async function sendMessage() {
      const msg=document.getElementById("chat-msg").value; if(!msg)return;
      await supabase.from("chat").insert([{ alias: currentUser.alias, mensaje: msg }]);
      document.getElementById("chat-msg").value=""; loadChat();
    }

    async function loadChat() {
      const { data } = await supabase.from("chat").select("*").order("creado_en",{ascending:true});
      const box=document.getElementById("chat-box"); box.innerHTML="";
      data.forEach(m=>{
        const div=document.createElement("div");
        div.className="msg "+(m.alias===currentUser.alias?"self":(m.alias.includes("Vicentinos")?"admin":"other"));
        div.textContent=m.alias+": "+m.mensaje;
        box.appendChild(div);
      });
      box.scrollTop=box.scrollHeight;
      showSection("chat-section");
    }

    async function sumarMonedas() {
      const usuario=document.getElementById("admin-alias").value;
      const monto=parseInt(document.getElementById("admin-amount").value);
      await supabase.rpc("sumar_monedas",{usuario,monto}); showNotification("Monedas sumadas!");
    }

    async function restarMonedas() {
      const usuario=document.getElementById("admin-alias").value;
      const monto=parseInt(document.getElementById("admin-amount").value);
      await supabase.rpc("restar_monedas",{usuario,monto}); showNotification("Monedas restadas!");
    }

    async function showNotificationGlobal() {
      const msg=prompt("Mensaje para todos los jugadores:");
      if(!msg)return;
      await supabase.from("chat").insert([{ alias:"Vicentinos Challenge", mensaje: msg }]);
      showNotification("Notificaci√≥n enviada!");
    }
  </script>
</body>
</html>
