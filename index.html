<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>Vicentinos Challenge</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{
    background:#003366;color:#0f0;min-height:100vh;display:flex;flex-direction:column;align-items:center;
    font-family:'Inter',sans-serif;text-shadow:0 0 5px #0f0;overflow-x:hidden
  }
  .banner{width:100%;height:160px;background:url('https://i.postimg.cc/gjRyvHHM/wp2896798.jpg') center/cover no-repeat;border-bottom:4px solid #0f0;display:flex;justify-content:center;align-items:center}
  .titulo{font-size:2rem;font-weight:700;color:#fff;text-shadow:0 0 10px #0f0,0 0 20px #0f0;text-align:center;letter-spacing:1px}
  .container{margin:16px auto;background:rgba(0,0,0,.85);padding:18px;border-radius:12px;width:92%;max-width:760px;border:1px solid #0f0;box-shadow:0 0 15px #0f0}
  h2{color:#0f0;margin-bottom:12px;text-align:center;font-size:1.25rem;font-weight:600}
  input,button,select{margin:8px 0;padding:12px;width:100%;border:none;border-radius:6px;font-family:'Inter',sans-serif;font-size:1rem}
  input,select{background:#111;color:#0f0;border:1px solid #0f0}
  button{background:#0f0;color:#000;font-weight:bold;cursor:pointer;transition:.25s}
  button:hover{transform:scale(1.03)}
  .fila{display:flex;gap:8px}
  .fila>*{flex:1}
  .toast{position:fixed;top:16px;right:16px;background:#111;border:1px solid #0f0;color:#0f0;padding:10px 14px;border-radius:8px;opacity:0;transform:translateY(-8px);transition:.3s;z-index:1000}
  .toast.show{opacity:1;transform:none}
  .temporizador{width:100%;height:18px;background:#111;border-radius:10px;margin:10px 0;overflow:hidden;position:relative;border:1px solid #0f0}
  .barra-tiempo{height:100%;width:100%;background:#0f0}
  .jugador-corriendo{position:absolute;top:-6px;left:0;width:28px;height:14px;background:url('https://cdn-icons-png.flaticon.com/512/723/723943.png') no-repeat center/contain;transition:left 1s linear;z-index:2}
  .pregunta{margin:10px 0;font-size:1.05rem;line-height:1.5}
  .opciones button{margin:6px 4px;background:#111;color:#0f0;font-size:.95rem;padding:10px 12px;border:1px solid #0f0;width:auto}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:920px){.grid{grid-template-columns:1fr 1fr}}
  .panel{background:#000;border:1px solid #0f0;border-radius:10px;padding:10px;max-height:320px;overflow:auto}
  .msg{margin:6px 0;padding:6px;background:rgba(0,255,0,0.08);border-left:3px solid #0f0;display:flex;gap:8px;align-items:flex-start}
  .alias{font-weight:700;margin-right:6px}
  .ranking .item{padding:6px;border-bottom:1px dashed rgba(0,255,0,.3)}
  .tienda button{display:block;width:100%;margin-top:8px}
  .small{font-size:.9rem;opacity:.9}
</style>
</head>
<body>

<!-- Sonidos -->
<audio id="sBien" src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-opening-2034.mp3"></audio>
<audio id="sApuesta" src="https://assets.mixkit.co/sfx/preview/mixkit-coin-drop-384.mp3"></audio>
<audio id="sOk" src="https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3"></audio>
<audio id="sBad" src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-946.mp3"></audio>
<audio id="sChat" src="https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-2574.mp3"></audio>

<div class="banner">
  <div class="titulo">Vicentinos Challenge üèâüî•</div>
</div>

<div id="toast" class="toast"></div>

<!-- LOGIN / INICIO -->
<div class="container" id="inicio">
  <h2>üéÆ Tu nombre de guerra</h2>
  <p class="small" style="text-align:center;margin-bottom:10px;">Preparate para ir por los puntos</p>
  <div class="fila">
    <input type="text" id="alias" maxlength="24" placeholder="Tu alias (ej: Pumita10)" />
    <button id="btnJugar">¬°JUGAR!</button>
  </div>
  <p class="small">üí° Si ya existe el alias, retom√°s tu progreso. Si es nuevo, te creamos la cuenta.</p>
</div>

<!-- INFO JUGADOR + JUEGO -->
<div class="container" id="juego" style="display:none;">
  <h2><span id="nivel-texto">Nivel 1</span> ‚Äî <span id="nivel-titulo">Iniciaci√≥n</span></h2>
  <div class="fila">
    <div><strong>Jugador:</strong> <span id="jugador-nombre"></span></div>
    <div><strong>Monedas:</strong> <span id="monedas">0</span></div>
    <div><strong>Preguntas:</strong> <span id="pregs">0/5</span></div>
  </div>

  <div class="temporizador">
    <div class="barra-tiempo" id="barra"></div>
    <div class="jugador-corriendo" id="runner"></div>
  </div>

  <!-- Apuesta -->
  <div id="fase-apuesta">
    <label>¬øCu√°nto apost√°s? (m√≠nimo 500)</label>
    <div class="fila">
      <input type="number" id="apuesta" min="500" step="100" value="500" />
      <button id="btnIniciarPregunta">‚û°Ô∏è Jugar Pregunta</button>
    </div>
  </div>

  <!-- Pregunta -->
  <div id="preguntaBox" style="display:none;">
    <div class="pregunta"><p id="txtPregunta"></p></div>
    <div class="opciones" id="opciones"></div>
  </div>
</div>

<!-- CHAT + RANKING + TIENDA -->
<div class="grid" style="width:92%;max-width:760px;">
  <div class="container">
    <h2>üí¨ Chat del Estadio</h2>
    <div class="fila">
      <input type="text" id="msg" placeholder="¬°Mand√° tu picard√≠a!" />
      <button id="btnEnviar" style="width:auto;">Enviar</button>
    </div>
    <div class="panel" id="chat"></div>
  </div>

  <div class="container">
    <h2>üèÜ Ranking</h2>
    <div class="panel ranking" id="ranking"></div>
  </div>

  <div class="container tienda">
    <h2>üõí Tienda de Monedas</h2>
    <p class="small" style="margin-bottom:8px;">Ser√°s redirigido a Mercado Pago. <br>Luego <strong>compart√≠ el comprobante</strong> por chat y el admin acreditar√° las monedas a tu alias.</p>
    <button data-url="https://mpago.la/16CyPeY" data-amount="2000">Comprar Pack $2.000 ‚Üí 2.000 monedas</button>
    <button data-url="https://mpago.la/1TTVVcV" data-amount="5000">Comprar Pack $5.000 ‚Üí 5.000 monedas</button>
    <button data-url="https://mpago.la/2HR6fjA" data-amount="10000">Comprar Pack $10.000 ‚Üí 10.000 monedas</button>
  </div>
</div>

<script>
/* ====== CONFIG SUPABASE ====== */
const SUPABASE_URL = "https://aqkqbtunbyifbfrvkpxv.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFxa3FidHVuYnlpZmJmcnZrcHh2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyOTg5NDgsImV4cCI6MjA3MDg3NDk0OH0.Xqtii5yiIO6tFOzzqza70ZA7N1KmbcTIkoNtV5YCVDY";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ====== UI ====== */
const $ = (id)=>document.getElementById(id);
const toast = (t)=>{ const el=$("toast"); el.textContent=t; el.classList.add("show"); setTimeout(()=>el.classList.remove("show"),2000); };
const play = (id)=>{ const a=$(id); if(!a) return; a.currentTime=0; a.play().catch(()=>{}); };

/* ====== ESTADO ====== */
let me = null; // {id, alias, role, coins, blocked}
let nivel = 1, preguntasRespondidas = 0, ronda = [];
let temporizador = null, tiempo = 20;

/* ====== PREGUNTAS ====== */
const titulosNivel = [
  "Iniciaci√≥n","Primeros Pasos","T√°ctica B√°sica","Medio Campo","Delanteros",
  "Backs","Estrategia","Torneos Sudam","Campe√≥n Nacional","Internacional",
  "Copa Mundial","Semifinalista","Finalista","Clase Mundial I","Clase Mundial II"
];
const banco = [
  {q:"¬øCu√°ntos jugadores tiene un equipo de rugby 15?",o:["13","15","11","7"],c:1},
  {q:"¬øCu√°ntos puntos vale un try?",o:["3","5","6","7"],c:1},
  {q:"¬øQu√© pa√≠s gan√≥ el Mundial de Rugby 2023?",o:["Francia","Inglaterra","Sud√°frica","Nueva Zelanda"],c:2},
  {q:"¬øQui√©n es 'El Mago' en el rugby argentino?",o:["Hugo Porta","Agust√≠n Pichot","Felipe Contepomi","Jer√≥nimo de la Fuente"],c:0},
  {q:"¬øQu√© posici√≥n inicia con kickoff?",o:["Fullback","Apertura","Wing","Pilar"],c:0},
  {q:"¬øSanci√≥n por tackle alto?",o:["Puntapi√© de mitad","Penal","Try","Tarjeta amarilla"],c:1},
  {q:"¬øA√±o de ingreso al Rugby Championship?",o:["2010","2012","2014","2016"],c:1},
  {q:"¬øQu√© es un 'ruck'?",o:["Formaci√≥n de 8","Lucha por el bal√≥n en el suelo","Pase hacia atr√°s","Patada de castigo"],c:1},
  {q:"Capit√°n de Los Pumas 2007",o:["Agust√≠n Pichot","Juan M. Hern√°ndez","Felipe Contepomi","Omar Hasan"],c:0},
  {q:"Duraci√≥n de un partido de rugby",o:["60","70","80","90"],c:2}
];
const mix = (arr)=>[...arr].sort(()=>Math.random()-0.5);

/* ====== LOGIN ====== */
$("btnJugar").onclick = async ()=>{
  const alias = $("alias").value.trim();
  if(!alias) return toast("Ingres√° un alias");
  // buscar / crear
  let { data: user, error } = await supabase.from("users").select("*").eq("alias", alias).maybeSingle();
  if(error){ toast("Error al buscar usuario"); return; }
  if(!user){
    const ins = await supabase.from("users").insert([{ alias, role:"player", coins:0, blocked:false }]).select().single();
    if(ins.error){ toast("No se pudo crear el usuario"); return; }
    user = ins.data;
  }
  if(user.blocked){ toast("‚õî Est√°s bloqueado"); return; }
  me = user;
  play("sBien");
  $("inicio").style.display="none";
  $("juego").style.display="block";
  $("jugador-nombre").textContent = me.alias;
  actualizarTop();
  nuevaRonda();
  suscribirChat();
  cargarChat();
  setInterval(cargarRanking, 5000);
};

/* ====== RONDA / PREGUNTAS ====== */
function actualizarTop(){
  $("monedas").textContent = me.coins ?? 0;
  $("nivel-texto").textContent = `Nivel ${nivel}`;
  $("nivel-titulo").textContent = titulosNivel[nivel-1] || "Leyenda";
  $("pregs").textContent = `${preguntasRespondidas}/5`;
}
function nuevaRonda(){
  ronda = mix(banco).slice(0,5);
  preguntasRespondidas = 0;
  mostrarApuesta();
  actualizarTop();
}
function mostrarApuesta(){
  clearInterval(temporizador);
  $("fase-apuesta").style.display="block";
  $("preguntaBox").style.display="none";
  $("barra").style.width="100%";
  $("runner").style.left="0";
}
$("btnIniciarPregunta").onclick = ()=>{
  const apuesta = parseInt($("apuesta").value,10);
  if(isNaN(apuesta) || apuesta<500) return toast("M√≠nimo 500");
  if(apuesta > (me.coins||0)) return toast("No ten√©s monedas suficientes");
  play("sApuesta");
  // registrar la intenci√≥n de apuesta en recaudaci√≥n (transacci√≥n positiva)
  supabase.from("transactions").insert([{ user_id: me.id, type:"apuesta", amount: apuesta }]).then(()=>{});
  // mostrar pregunta
  const p = ronda[preguntasRespondidas];
  $("txtPregunta").textContent = p.q;
  const ops = $("opciones"); ops.innerHTML="";
  p.o.forEach((txt,idx)=>{
    const b=document.createElement("button");
    b.textContent = txt;
    b.onclick = ()=>verificar(idx, p.c, apuesta);
    ops.appendChild(b);
  });
  $("fase-apuesta").style.display="none";
  $("preguntaBox").style.display="block";
  // temporizador
  tiempo=20;
  correrTimer(apuesta, p.c, true);
};
function correrTimer(apuesta, correcta){
  clearInterval(temporizador);
  const barra=$("barra"), run=$("runner");
  temporizador = setInterval(()=>{
    tiempo--;
    const porc = Math.max(0,(tiempo/20)*100);
    barra.style.width = porc+"%";
    run.style.left = (100-porc)+"%";
    if(tiempo<=0){
      clearInterval(temporizador);
      perder(apuesta);
      siguiente();
    }
  },1000);
}
async function verificar(idx, correcta, apuesta){
  clearInterval(temporizador);
  if(idx===correcta){
    // gana
    me.coins = (me.coins||0)+apuesta;
    await supabase.from("users").update({ coins: me.coins }).eq("id", me.id);
    play("sOk");
    toast(`‚úÖ ¬°Correcto! +${apuesta}`);
  }else{
    perder(apuesta);
  }
  actualizarTop();
  siguiente();
}
async function perder(apuesta){
  me.coins = Math.max(0,(me.coins||0)-apuesta);
  await supabase.from("users").update({ coins: me.coins }).eq("id", me.id);
  play("sBad");
  toast(`‚ùå Incorrecto / tiempo. -${apuesta}`);
}
function siguiente(){
  preguntasRespondidas++;
  if(preguntasRespondidas>=5){
    nivel = Math.min(15, nivel+1);
    toast(`‚¨ÜÔ∏è ¬°Subiste a Nivel ${nivel}!`);
    nuevaRonda();
  }else{
    mostrarApuesta();
  }
  actualizarTop();
}

/* ====== CHAT ====== */
$("btnEnviar").onclick = async ()=>{
  if(!me) return;
  if(me.blocked) return toast("‚õî Bloqueado para chatear");
  const m = $("msg").value.trim();
  if(!m) return;
  $("msg").value="";
  play("sChat");
  await supabase.from("messages").insert([{ user_id: me.id, alias: me.alias, message: m }]);
};
async function cargarChat(){
  const { data } = await supabase.from("messages").select("*").order("created_at",{ascending:false}).limit(50);
  pintarChat((data||[]).reverse());
}
function pintarChat(rows){
  const c=$("chat"); c.innerHTML="";
  rows.forEach(r=>{
    const d=document.createElement("div");
    d.className="msg";
    d.innerHTML = `<span class="alias">${r.alias}:</span> <span>${r.message}</span>`;
    c.appendChild(d);
  });
  c.scrollTop=c.scrollHeight;
}
function suscribirChat(){
  const ch = supabase.channel('realtime:messages')
    .on('postgres_changes',{event:'INSERT',schema:'public',table:'messages'}, payload=>{
      const r = payload.new;
      const c=$("chat");
      const d=document.createElement("div");
      d.className="msg";
      d.innerHTML=`<span class="alias">${r.alias}:</span> <span>${r.message}</span>`;
      c.appendChild(d);
      c.scrollTop=c.scrollHeight;
    }).subscribe();
}

/* ====== RANKING ====== */
async function cargarRanking(){
  const { data, error } = await supabase.from("ranking_jugadores").select("*");
  const cont=$("ranking"); cont.innerHTML="";
  (data||[]).forEach((r,i)=>{
    const el=document.createElement("div");
    el.className="item";
    el.textContent = `#${i+1} ${r.alias} ‚Äî $${r.coins}`;
    cont.appendChild(el);
  });
}
setInterval(()=>{ if(me) cargarRanking(); }, 12000);

/* ====== TIENDA ====== */
document.querySelectorAll(".tienda button").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const url = btn.getAttribute("data-url");
    const amount = btn.getAttribute("data-amount");
    toast(`Vas a Mercado Pago por ${amount} monedas. Luego compart√≠ el comprobante en el chat y el admin acreditar√°.`);
    window.open(url, "_blank");
  });
});
</script>
</body>
</html>
