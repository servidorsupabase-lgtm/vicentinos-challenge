<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Vicentinos Challenge â€” Trivia Rugby</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
  :root{
    --bg:#003366;
    --neon:#00ff88;
    --neon2:#00e0ff;
    --card:rgba(0,0,0,.82);
    --text:#d9ffef;
    --danger:#ff4d4d;
    --warn:#f8c12a;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0}
  body{
    font-family:'Inter',system-ui,Segoe UI,Roboto,Arial,sans-serif;
    background:linear-gradient(180deg,#001d3d 0%, #003366 40%, #001a2b 100%);
    color:var(--text);
    min-height:100vh;
  }
  .banner{
    width:100%;height:190px;position:relative;display:flex;align-items:center;justify-content:center;
    background:url('https://i.postimg.cc/nVvFmXQR/wp2896798.jpg') center/cover no-repeat;
    border-bottom:3px solid var(--neon2); box-shadow: 0 6px 30px rgba(0,224,255,.15) inset;
  }
  .banner h1{
    text-align:center;padding:0 12px;font-weight:800;letter-spacing:.5px;
    text-shadow:0 0 16px rgba(0,224,255,.9), 0 0 40px rgba(0,255,136,.5);
    -webkit-text-stroke: 1px rgba(0,0,0,.25);
  }
  .title-lg{font-size:clamp(22px,3.8vw,42px)}
  .subtitle{font-size:clamp(12px,1.8vw,16px);opacity:.95;margin-top:4px}
  .wrap{max-width:1100px;margin:16px auto;padding:12px}
  .row{display:grid;grid-template-columns:1fr;gap:14px}
  @media(min-width:960px){ .row{grid-template-columns:1.2fr .8fr} }
  .card{
    background:var(--card);
    border:1px solid rgba(0,224,255,.25);
    border-radius:14px; padding:14px;
    box-shadow: 0 0 24px rgba(0,224,255,.08), 0 0 0 1px rgba(0,255,136,.08) inset;
    backdrop-filter: blur(4px);
  }
  h2{margin:.2rem 0 1rem 0;font-size:1.15rem;color:#e9fffb}
  .muted{opacity:.8;font-size:.95rem}

  /* Inputs / buttons */
  .grid-2{display:grid;grid-template-columns:1fr auto;gap:10px}
  input,button{
    border-radius:10px;border:1px solid rgba(0,224,255,.25); padding:12px;
    background:#071721;color:#dff; font-size:1rem;
  }
  input:focus{outline:none;border-color:var(--neon2);box-shadow:0 0 0 3px rgba(0,224,255,.2)}
  button{
    background:linear-gradient(90deg,var(--neon2),var(--neon));
    color:#003; font-weight:800; cursor:pointer; transition:.2s;
  }
  button:hover{transform:translateY(-1px) scale(1.01)}
  button:disabled{opacity:.5;cursor:not-allowed}
  .btn-ghost{
    background:transparent;color:#dff;border:1px dashed rgba(0,224,255,.35);
  }
  .btn-warn{ background:linear-gradient(90deg,#ffd76b,#ff9b44); color:#000; }
  .btn-danger{ background:linear-gradient(90deg,#ff6b6b,#ff3636); color:#000; }

  /* Top info bar */
  .statusbar{
    display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-bottom:10px;
  }
  .pill{
    background:#06121b;border:1px solid rgba(0,224,255,.25); padding:10px 12px;border-radius:10px;
    display:flex;align-items:center;gap:10px;justify-content:center
  }
  .pill strong{color:#fff}
  .mono{font-variant-numeric:tabular-nums}

  /* Timer */
  .timer{height:18px;background:#06121b;border:1px solid rgba(0,224,255,.25);border-radius:11px;position:relative;overflow:hidden;margin:10px 0 6px}
  .tbar{position:absolute;left:0;top:0;height:100%;width:100%;background:linear-gradient(90deg,#00e0ff,#00ff88);box-shadow:0 0 12px rgba(0,255,136,.45) inset}
  .ball{position:absolute;top:-6px;left:0;width:26px;height:26px;background:url('https://cdn-icons-png.flaticon.com/512/2243/2243887.png') center/contain no-repeat;filter:drop-shadow(0 0 4px rgba(0,224,255,.7))}
  .qtext{font-size:1.05rem;line-height:1.5;margin:10px 0}
  .opts{display:flex;flex-wrap:wrap;gap:10px}
  .opt{background:#0a1e29;border:1px solid rgba(0,224,255,.25); color:#dff;padding:10px 12px;border-radius:10px;cursor:pointer}
  .opt:hover{border-color:var(--neon); box-shadow:0 0 0 3px rgba(0,255,136,.18)}

  /* Chat & ranking */
  .messages{max-height:280px;overflow:auto;display:flex;flex-direction:column;gap:8px;background:#06121b;border:1px solid rgba(0,224,255,.25);border-radius:12px;padding:10px}
  .msg{display:flex;gap:8px;align-items:flex-start;background:rgba(0,255,136,.06);border-left:3px solid var(--neon);padding:8px;border-radius:8px}
  .msg .who{font-weight:800;color:#fff}
  .msg .txt{flex:1}
  .msg .x{border:none;background:transparent;color:#ff9b9b;cursor:pointer}
  .ranking .item{padding:8px;border-bottom:1px dashed rgba(0,224,255,.2)}
  .ranking .item:last-child{border-bottom:none}

  /* Store */
  .store .btn{width:100%;margin-top:8px}

  /* Admin panel */
  .admin{display:none;margin-top:10px;border:1px solid rgba(255,215,0,.35);box-shadow:0 0 12px rgba(255,215,0,.15) inset}
  .admin h3{margin:.2rem 0 8px 0;color:#ffe180}
  .grid-3{display:grid;grid-template-columns:1.2fr .8fr auto;gap:10px}
  .split{display:grid;grid-template-columns:1fr 1fr;gap:10px}

  /* Toast */
  .toast{position:fixed;top:14px;right:14px;background:#06121b;border:1px solid rgba(0,224,255,.35);
         color:#dff;padding:10px 14px;border-radius:10px;opacity:0;transform:translateY(-8px);transition:.25s;z-index:9999}
  .toast.show{opacity:1;transform:none}

  /* Confetti */
  .confetti{position:fixed;left:0;top:0;width:100%;height:0;pointer-events:none;z-index:9998}
  .confetti i{position:absolute;width:10px;height:16px;background:linear-gradient(180deg,#00e0ff,#00ff88);transform:rotate(20deg);animation:fall 1.6s linear forwards}
  @keyframes fall{
    to{transform:translateY(120vh) rotate(360deg);opacity:.2}
  }

  /* Welcome strip */
  .welcome{
    max-width:1100px;margin:10px auto 0;padding:8px 12px;text-align:center;
    color:#001b26;background:linear-gradient(90deg,#c8fff2,#a8f3ff);
    border-radius:10px;border:1px solid rgba(0,224,255,.35)
  }
</style>
</head>
<body>

<div class="banner">
  <div>
    <h1 class="title-lg">Vicentinos Challenge ğŸ‰ğŸ”¥</h1>
    <div class="subtitle">Preparate para ir por los puntos</div>
  </div>
</div>

<div class="welcome">ğŸŸï¸ Jugadores nuevos: probÃ¡ <b>3 preguntas de entrenamiento</b>. DespuÃ©s, comprÃ¡ monedas en la <b>Tienda</b> para seguir jugando.</div>

<div class="wrap">
  <!-- LOGIN -->
  <div class="card" id="card-login">
    <h2>ğŸ® EntrÃ¡ al estadio</h2>
    <div class="grid-2">
      <input id="inp-alias" placeholder="Tu alias (ej: Pumita10)" maxlength="24">
      <button id="btn-login">Entrar</button>
    </div>
    <div class="muted" style="margin-top:6px">ğŸ’¡ Si el alias existe, retomÃ¡s tu progreso. Si es nuevo, te creamos la cuenta.</div>
  </div>

  <div class="row" id="row-app" style="display:none;">
    <!-- JUEGO -->
    <div class="card">
      <h2>ğŸ‰ Juego â€” <span id="lbl-nivel">Nivel 1</span> <span class="muted">(<span id="lbl-titulo">IniciaciÃ³n</span>)</span></h2>

      <div class="statusbar">
        <div class="pill">ğŸ‘¤ <strong id="lbl-user">â€”</strong></div>
        <div class="pill">ğŸ’° Monedas: <strong class="mono" id="lbl-coins">0</strong></div>
        <div class="pill">â“ Preguntas: <strong class="mono" id="lbl-progress">0/5</strong></div>
      </div>

      <!-- Timer -->
      <div class="timer"><div class="tbar" id="tbar"></div><div class="ball" id="ball"></div></div>

      <!-- Apuesta -->
      <div id="box-bet">
        <div class="muted" style="margin-top:4px;margin-bottom:8px;">ApostÃ¡ sin ver la pregunta (mÃ­n. <b>500</b>)</div>
        <div class="grid-2">
          <input id="inp-bet" type="number" min="500" step="100" value="500" />
          <button id="btn-start">â¡ï¸ Jugar Pregunta</button>
        </div>
      </div>

      <!-- Pregunta -->
      <div id="box-q" style="display:none;">
        <div class="qtext" id="qtext">â€”</div>
        <div class="opts" id="opts"></div>
        <div class="split" style="margin-top:10px">
          <button class="btn-ghost" id="btn-menu">ğŸ  MenÃº Principal</button>
          <button class="btn-ghost" id="btn-next" style="display:none;">â¡ï¸ Siguiente</button>
        </div>
      </div>

      <!-- ENTRENAMIENTO cartel -->
      <div class="card" id="card-train" style="display:none;margin-top:10px;">
        <div>ğŸ“ Modo Entrenamiento finalizado. Para continuar necesitÃ¡s monedas. PasÃ¡ por la <b>Tienda</b> y compartÃ­ el comprobante por el chat para que el admin te acredite.</div>
      </div>
    </div>

    <!-- LATERAL: Chat / Ranking / Tienda / Admin -->
    <div class="card">
      <h2>ğŸ’¬ Chat del Estadio</h2>
      <div class="messages" id="chat"></div>
      <div class="grid-2" style="margin-top:10px">
        <input id="inp-msg" placeholder="Â¡MandÃ¡ tu picardÃ­a!">
        <button id="btn-send">Enviar</button>
      </div>

      <h2 style="margin-top:16px;">ğŸ† Ranking</h2>
      <div class="messages ranking" id="ranking"></div>

      <h2 style="margin-top:16px;">ğŸ›’ Tienda de Monedas</h2>
      <div class="store">
        <div class="muted">SerÃ¡s redirigido a Mercado Pago. Luego <b>compartÃ­ el comprobante</b> por el chat y el admin acreditarÃ¡ las monedas a tu alias.</div>
        <button class="btn" data-url="https://mpago.la/16CyPeY" data-amount="2000">Pack $2.000 â†’ 2.000 monedas</button>
        <button class="btn" data-url="https://mpago.la/1TTVVcV" data-amount="5000">Pack $5.000 â†’ 5.000 monedas</button>
        <button class="btn" data-url="https://mpago.la/2HR6fjA" data-amount="10000">Pack $10.000 â†’ 10.000 monedas</button>
      </div>

      <div class="card admin" id="admin-panel">
        <h3>ğŸ› ï¸ Panel Admin</h3>
        <div class="grid-3">
          <input id="adm-username" placeholder="Alias jugador">
          <input id="adm-amount" type="number" placeholder="Monedas (+/-)">
          <div class="split">
            <button class="btn-warn" id="adm-add">Cargar</button>
            <button class="btn-warn" id="adm-sub">Restar</button>
          </div>
        </div>
        <div class="grid-2" style="margin-top:8px">
          <button class="btn-danger" id="adm-deluser">Eliminar usuario</button>
          <button class="btn-danger" id="adm-delchat">Borrar todo el chat</button>
        </div>
        <div class="grid-2" style="margin-top:8px">
          <button class="btn-ghost" id="adm-close">ğŸ”’ Cerrar panel</button>
          <button class="btn-ghost" id="adm-home">ğŸ  MenÃº Principal</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Audios -->
<audio id="snd-open" src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-opening-2034.mp3"></audio>
<audio id="snd-bet"  src="https://assets.mixkit.co/sfx/preview/mixkit-coin-drop-384.mp3"></audio>
<audio id="snd-ok"   src="https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3"></audio>
<audio id="snd-bad"  src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-946.mp3"></audio>
<audio id="snd-crowd" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_2d5e90a0d5.mp3?filename=stadium-crowd-ambient-143155.mp3"></audio>

<div class="toast" id="toast"></div>
<div class="confetti" id="confetti"></div>

<script>
/* =========================
   CONFIG SUPABASE
========================= */
const SUPABASE_URL = "https://aqkqbtunbyifbfrvkpxv.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFxa3FidHVuYnlpZmJmcnZrcHh2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyOTg5NDgsImV4cCI6MjA3MDg3NDk0OH0.Xqtii5yiIO6tFOzzqza70ZA7N1KmbcTIkoNtV5YCVDY";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* =========================
   UTILIDADES UI
========================= */
const $ = id => document.getElementById(id);
function toast(msg, t=2000){ const a=$("toast"); a.textContent=msg; a.classList.add("show"); setTimeout(()=>a.classList.remove("show"), t); }
function play(id){ const el=$(id); if(!el) return; el.currentTime=0; el.play().catch(()=>{}); }
function confettiBurst(count=80){
  const box=$("confetti"); box.innerHTML="";
  const w=window.innerWidth;
  for(let i=0;i<count;i++){
    const p=document.createElement('i');
    p.style.left = (Math.random()*w) + "px";
    p.style.opacity = .9;
    p.style.transform = `translateY(-20px) rotate(${Math.random()*60}deg)`;
    p.style.animationDelay = (Math.random()*0.4)+"s";
    p.style.background = Math.random()>.5 ? "linear-gradient(180deg,#00e0ff,#00ff88)" : "linear-gradient(180deg,#ffdd66,#ff6b6b)";
    box.appendChild(p);
  }
  setTimeout(()=>box.innerHTML="",1800);
}

/* =========================
   ESTADO
========================= */
const ADMIN_TOKEN = "20250819802006";
let me = null;            // {id, username, coins}
let isAdmin = false;
let level = 1;
let answered = 0;
let round = [];
let used = new Set();     // indices globales usados en la sesiÃ³n
let timer = null, secs = 20, currentBet = 0, currentQ = null;
let trained = false;

/* =========================
   PREGUNTAS (70) â€” con nivel 1..15
   c: Ã­ndice de opciÃ³n correcta (0..2)
========================= */
const LEVEL_TITLES = [
 "IniciaciÃ³n","Primeros Pasos","TÃ¡ctica BÃ¡sica","Medio Campo","Delanteros",
 "Backs","Estrategia","Torneos Sudam","CampeÃ³n Nacional","Internacional",
 "Copa Mundial","Semifinalista","Finalista","Clase Mundial I","Clase Mundial II"
];
const Q = [
  // Nivel 1-3 (bÃ¡sico)
  {q:"Â¿CuÃ¡ntos jugadores por equipo en rugby union?",o:["13","15","7"],c:1,l:1},
  {q:"Â¿CuÃ¡ntos puntos vale un try?",o:["5","3","2"],c:0,l:1},
  {q:"Â¿El pase hacia adelante estÃ¡ permitido?",o:["SÃ­","No","Solo en 22 propia"],c:1,l:1},
  {q:"Â¿CuÃ¡nto dura un partido en rugby 15 (sin adiciÃ³n)?",o:["80 min","70 min","60 min"],c:0,l:1},
  {q:"Â¿QuÃ© es un scrum?",o:["FormaciÃ³n para reiniciar juego","Tipo de patada","Penal menor"],c:0,l:1},
  {q:"Â¿QuÃ© es un lineout?",o:["Saque lateral con salto","Patada al touch","Reinicio tras try"],c:0,l:2},
  {q:"Â¿QuÃ© es un ruck?",o:["Disputa en el suelo","Melee a 8","Saque desde 22"],c:0,l:2},
  {q:"Â¿QuÃ© tarjeta implica expulsiÃ³n temporal?",o:["Roja","Amarilla","Azul"],c:1,l:2},
  {q:"Â¿QuÃ© se sanciona por tackle alto?",o:["Penal","Scrum","Drop"],c:0,l:2},
  {q:"Â¿QuiÃ©n patea el kickoff normalmente?",o:["Apertura","Pilar","Hooker"],c:0,l:3},
  {q:"Â¿Se puede obstruir sin intentar tacklear?",o:["SÃ­","No","Solo dentro de 22"],c:1,l:3},
  {q:"Â¿CuÃ¡nto vale una conversiÃ³n?",o:["2","3","1"],c:0,l:3},
  {q:"Â¿CuÃ¡nto vale un penal a los palos?",o:["3","2","5"],c:0,l:3},
  {q:"Â¿El drop goal valeâ€¦?",o:["3","2","1"],c:0,l:3},
  {q:"Â¿La pelota puede ser pateada hacia adelante?",o:["SÃ­","No","Nunca"],c:0,l:3},

  // Nivel 4-6 (intermedio)
  {q:"Â¿QuÃ© infracciÃ³n es el 'knock-on'?",o:["Tirar el balÃ³n hacia adelante con la mano","Patada desviada","Entrar por el costado"],c:0,l:4},
  {q:"Â¿QuiÃ©n lanza en el lineout?",o:["Hooker","Medio scrum","Apertura"],c:0,l:4},
  {q:"Â¿CuÃ¡ntos jugadores participan en un scrum completo?",o:["6","8","7"],c:1,l:4},
  {q:"En defensa, Â¿el offside se mide desdeâ€¦?",o:["Ãšltimo pie del ruck/maul","LÃ­nea de 10 m","La pelota"],c:0,l:4},
  {q:"Â¿QuÃ© es un maul?",o:["Portador en pie + rivales enganchados","Disputa en el suelo","Reinicio tras penal"],c:0,l:5},
  {q:"Â¿CuÃ¡ndo se canta 'advantage'?",o:["Tras infracciÃ³n con beneficio posible","Tras try","Solo tras scrum"],c:0,l:5},
  {q:"Â¿QuÃ© indica el Ã¡rbitro con brazo extendido horizontal?",o:["Scrum","Advantage","Penal"],c:1,l:5},
  {q:"Â¿DÃ³nde se patea la conversiÃ³n?",o:["En lÃ­nea con el lugar del try","Desde la marca de 22","Desde mitad"],c:0,l:5},
  {q:"Â¿QuÃ© determina un forward pass?",o:["Trayectoria relativa hacia adelante","IntenciÃ³n del pasador","Viento"],c:0,l:6},
  {q:"Â¿Se puede tacklear sin brazos (shoulder charge)?",o:["Permitido","Prohibido","Solo en ingoal"],c:1,l:6},
  {q:"Â¿QuÃ© sanciona entrar por el costado al ruck?",o:["Penal","Free-kick","Scrum"],c:0,l:6},
  {q:"Â¿CuÃ¡ndo hay 50:22?",o:["Pateas desde campo propio al touch rival botando y ganÃ¡s line","Pateas directo a touch y sale de mitad","Pateas de 22 a mitad"],c:0,l:6},
  {q:"Â¿CuÃ¡ndo es mark vÃ¡lido?",o:["Atrapas de aire dentro de 22 y gritas 'mark'","Cualquier atrape","Solo en defensa rival"],c:0,l:6},
  {q:"Â¿QuÃ© color de tarjeta implica expulsiÃ³n definitiva?",o:["Amarilla","Roja","Naranja"],c:1,l:6},

  // Nivel 7-9 (tÃ¡ctico/situaciones)
  {q:"Si la pelota toca al Ã¡rbitro y beneficia a un equipo, Â¿quÃ© ocurre?",o:["Scrum al equipo que atacaba","Sigue","Lineout"],c:0,l:7},
  {q:"En un ruck, el medio scrum rival te carga sin el balÃ³n. Â¿SanciÃ³n?",o:["Penal","Scrum","Free-kick"],c:0,l:7},
  {q:"Un tackle alto con contacto directo a la cabeza sin atenuantes esâ€¦",o:["Solo amarilla","Roja","Nada"],c:1,l:7},
  {q:"En un maul, el balÃ³n no sale. Â¿Reinicio?",o:["Scrum al rival","Lineout","Free-kick"],c:0,l:7},
  {q:"Â¿CuÃ¡ndo es knock-on deliberado?",o:["Manotazo sin chance de captura","Intento real de interceptar","Rebote casual"],c:0,l:7},
  {q:"Tras un mark vÃ¡lido, Â¿opciones?",o:["Salida de free-kick o jugar rÃ¡pido","Solo patear a touch","Solo scrum"],c:0,l:8},
  {q:"Â¿QuÃ© sucede si el pateador pisa fuera al patear?",o:["Line donde saliÃ³","Scrum mitad","Jugada sigue"],c:0,l:8},
  {q:"Ruck formado: tu compaÃ±ero patea por encima. Un rival lo carga tarde. Â¿SanciÃ³n?",o:["Penal + posible tarjeta","Scrum","Nada"],c:0,l:8},
  {q:"En salida de mitad, Â¿distancia mÃ­nima de 10m?",o:["SÃ­","No","Solo si gana el viento"],c:0,l:8},
  {q:"'Playing the man in the air' (tocar en el aire) esâ€¦",o:["Penal y probable amarilla","Legal","Scrum"],c:0,l:9},
  {q:"Â¿Se puede formar maul directo desde la recepciÃ³n de kickoff?",o:["SÃ­","No","Solo si hay ventaja"],c:0,l:9},
  {q:"Tu equipo defiende un maul cerca del ingoal: colapsarlo deliberadamente esâ€¦",o:["Penal y posible amarilla/penal try","Legal","Scrum"],c:0,l:9},
  {q:"Deliberado knock-on cortando un try claro",o:["Penal + amarilla + penal try a criterio","Solo penal","Scrum"],c:0,l:9},
  {q:"Â¿Se puede recuperar un balÃ³n propio tras up&under antes de 10m?",o:["SÃ­ si estÃ¡s habilitado por el kicker o atrÃ¡s del pie","Nunca","Solo si lo atrapa el rival"],c:0,l:9},

  // Nivel 10-12 (historia/figuras/alto nivel)
  {q:"Â¿QuÃ© paÃ­s ganÃ³ el Mundial 2023?",o:["SudÃ¡frica","Nueva Zelanda","Francia"],c:0,l:10},
  {q:"Hugo Porta es leyenda deâ€¦",o:["Argentina","Italia","SudÃ¡frica"],c:0,l:10},
  {q:"Â¿CuÃ¡ntos Mundiales ganÃ³ Nueva Zelanda (hasta 2023)?",o:["3","2","4"],c:0,l:10},
  {q:"Apodo de Jonah Lomu",o:["The Bus","The Wizard","The Doctor"],c:0,l:10},
  {q:"Los Pumas 2007 terminaronâ€¦",o:["3Âº","2Âº","4Âº"],c:0,l:10},
  {q:"Â¿AÃ±o de ingreso argentino al Rugby Championship?",o:["2012","2014","2010"],c:0,l:11},
  {q:"Â¿CuÃ¡ntos puntos vale un penal try?",o:["7 (sin conversiÃ³n)","5 + conversiÃ³n","3 + scrum"],c:0,l:11},
  {q:"Â¿QuÃ© selecciÃ³n tiene mÃ¡s tÃ­tulos mundiales (hasta 2023)?",o:["SudÃ¡frica","NZ","Australia"],c:0,l:11},
  {q:"â€œEl rugby es un deporte de hooligans jugado por caballerosâ€ se atribuye aâ€¦",o:["Winston Churchill (popularmente)","Jonah Lomu","John Eales"],c:0,l:11},
  {q:"CapitÃ¡n de Argentina en RWC 2007",o:["AgustÃ­n Pichot","HernÃ¡ndez","Contepomi"],c:0,l:11},
  {q:"Â¿QuÃ© es el TMO?",o:["Ãrbitro de video","Entrenador de ataque","Oficial de equipo"],c:0,l:12},
  {q:"Â¿CuÃ¡ndo se usa TMO?",o:["Situaciones de try, foul play, in-goal","Cualquier lateral","Tiempo muerto"],c:0,l:12},
  {q:"Â¿CuÃ¡ntos reservas en test match moderno?",o:["8","7","6"],c:0,l:12},
  {q:"â€œGanar con humildad, perder con dignidadâ€ estÃ¡ asociado aâ€¦",o:["Valores del rugby","Slogan comercial","Regla 22"],c:0,l:12},
  {q:"Jugador argentino apodado 'Mago'",o:["Juan MartÃ­n HernÃ¡ndez","Juan Imhoff","NicolÃ¡s SÃ¡nchez"],c:0,l:12},

  // Nivel 13-15 (muy difÃ­cil / casi imposible)
  {q:"Regla de 50:22 exacta:",o:["PateÃ¡s desde propio campo, bota y sale 50:22 rival â†’ tu line","PateÃ¡s directo desde mitad â†’ tu line","Pasa mitad en aire â†’ tu line"],c:0,l:13},
  {q:"En scrum: Â¿quiÃ©n marca el 'engage' actualmente?",o:["El referee con secuencia y timing","El 8","El hooker"],c:0,l:13},
  {q:"Â¿QuÃ© define fuera de juego en patada al cajÃ³n (box-kick)?",o:["LÃ­nea de offside desde Ãºltimo pie","10m siempre","Mitad de cancha"],c:0,l:13},
  {q:"Pick and go en 5m: defensor entra por puerta pero cae sobre 9. Â¿DecisiÃ³n?",o:["Penal por obstaculizar salida","Scrum 5","Nada"],c:0,l:13},
  {q:"Ley de ventaja: Â¿cuÃ¡ndo vuelve a la infracciÃ³n?",o:["Sin ganancia territorial/tÃ¡ctica clara","Siempre","Nunca"],c:0,l:13},
  {q:"Tackle alto con baja mitigaciÃ³n y contacto indirecto cabeza: consenso actual",o:["Amarilla revisable (bunker)","Roja directa","Nada"],c:0,l:14},
  {q:"Mall 'sack' legal:",o:["Solo si portador no estÃ¡ sostenido: si es maul, colapsar es penal","Siempre que sea ordenado","Nunca"],c:0,l:14},
  {q:"En 5m scrum defensivo, salida temprana del 8 generando try. Â¿Resultado?",o:["Scrum de nuevo/penal si ventaja inequÃ­voca","Try vÃ¡lido sin mÃ¡s","Free-kick"],c:0,l:14},
  {q:"Penalty advantage cerca del ingoal, infracciÃ³n reiterada: decisiÃ³n probable",o:["Penal try + amarilla","Solo penal","Scrum"],c:0,l:14},
  {q:"InterpretaciÃ³n de deliberate knock-on con manos arriba y opciÃ³n real de captura:",o:["No sancionar como deliberado si intentÃ³ jugar el balÃ³n","Siempre amarilla","Roja"],c:0,l:14},
  {q:"Offside en juego abierto: compaÃ±ero patea, estÃ¡s delante; retrocedes sin interferir:",o:["Te habilitÃ¡s cuando pasÃ¡s por detrÃ¡s del kicker o te habilitan","Siempre penal","Scrum"],c:0,l:15},
  {q:"Ley 9 (conducta): limpiar ruck con contacto a la cabeza",o:["SanciÃ³n severa: penal + tarjeta posible","Legal si es rÃ¡pido","Solo scrum"],c:0,l:15},
  {q:"Tackle en el aire con intento claro de disputar pero desequilibrio mÃ­nimo",o:["Penal, generalmente sin tarjeta (segÃºn peligro)",o=["Libre","Roja","Penal"],c:2,l:15}, // FIX malformed, will correct below
  {q:"Salida rÃ¡pida en 22: pateÃ¡s fuera directo desde 22 propia",o:["Line donde saliÃ³","Line al punto de la patada","Scrum"],c:0,l:15},
  {q:"'Croc roll' en limpieza de ruck",o:["Ilegal por seguridad: sanciÃ³n","Legal con control","Solo amarilla"],c:0,l:15},
];
// Corrige pregunta mal armada en l:15
Q.splice(Q.length-3, 1, {q:"Tackle en el aire con intento de disputar y contacto leve",o:["Penal sin tarjeta (segÃºn peligro)","Roja siempre","Libre"],c:0,l:15});

// Asegurar 70: contamos y si faltan, aÃ±adimos difÃ­ciles adicionales
while(Q.length<70){
  Q.push({
    q:"Caso avanzado: ventaja tÃ¡ctica reconocible vs territorial Â¿cuÃ¡l prima?",
    o:["Cualquiera clara; si no, se vuelve a la infracciÃ³n","Siempre territorial","Nunca se vuelve"],
    c:0, l:15
  });
}

/* =========================
   HELPERS
========================= */
const easy = Q.filter(x=>x.l<=3).map((_,i)=>i);
function rnd(a){ return a[Math.floor(Math.random()*a.length)] }
function freshQuestionIndices(levelWant, n=5){
  // Elegimos por nivel, evitando usados
  const pool = Q.map((q,idx)=>({idx,q})).filter(x=>x.q.l===levelWant && !used.has(x.idx));
  let pick = [];
  const copy = [...pool];
  while(pick.length<n && copy.length){
    const k = Math.floor(Math.random()*copy.length);
    pick.push(copy[k].idx);
    copy.splice(k,1);
  }
  // Si no hay suficientes, rellenamos con niveles cercanos
  let radius=1;
  while(pick.length<n && radius<=15){
    const near = Q.map((q,idx)=>({idx,q})).filter(x=>!used.has(x.idx) && Math.abs(x.q.l-levelWant)===radius);
    for(const it of near){
      if(pick.length<n) pick.push(it.idx); else break;
    }
    radius++;
  }
  return pick;
}

/* =========================
   LOGIN
========================= */
$("btn-login").onclick = async ()=>{
  const alias = $("inp-alias").value.trim();
  if(!alias){ toast("IngresÃ¡ un alias"); return; }

  // Admin oculto
  if(alias === ADMIN_TOKEN){
    isAdmin = true;
    me = { id:null, username:"Admin", coins:999999 };
    $("card-login").style.display="none";
    $("row-app").style.display="grid";
    $("admin-panel").style.display="block";
    $("lbl-user").textContent = "Amo del Try (admin)";
    $("lbl-coins").textContent = "âˆ";
    play("snd-open");
    toast("Bienvenido, Admin.");
    cargarRanking(); // ver usuarios
    suscribirChat();
    cargarChat();
    return;
  }

  // Jugador normal
  isAdmin = false;
  try{
    // Buscar/crear
    let { data:user, error } = await supabase.from("users").select("*").eq("username", alias).maybeSingle();
    if(error){ console.error(error); toast("Error de conexiÃ³n (users)"); return; }
    if(!user){
      const ins = await supabase.from("users").insert([{ username: alias, coins: 0 }]).select().single();
      if(ins.error){ console.error(ins.error); toast("No se pudo crear el usuario"); return; }
      user = ins.data;
      // Flag local de entrenamiento por Ãºnica vez
      localStorage.setItem("train_"+alias, "0");
    }
    me = user;
    $("card-login").style.display="none";
    $("row-app").style.display="grid";
    $("lbl-user").textContent = me.username;
    $("lbl-coins").textContent = me.coins ?? 0;
    $("lbl-nivel").textContent = "Nivel "+level;
    $("lbl-titulo").textContent = LEVEL_TITLES[level-1] || "Leyenda";
    $("lbl-progress").textContent = "0/5";
    play("snd-open");
    toast("Bienvenido, " + me.username);

    // detectar entrenamiento
    const t = localStorage.getItem("train_"+me.username);
    if(t===null || t==="0"){
      trained=false;
      toast("ğŸ“ TenÃ©s 3 preguntas de entrenamiento.");
    }else{
      trained=true;
    }

    // preparar interfaz
    mostrarApuesta();
    suscribirChat();
    cargarChat();
    cargarRankingRegular();
  }catch(e){
    console.error(e);
    toast("Error inesperado");
  }
};

/* =========================
   FLUJO DE JUEGO
========================= */
function mostrarApuesta(){
  clearInterval(timer);
  $("box-bet").style.display="block";
  $("box-q").style.display="none";
  $("btn-next").style.display="none";
  $("tbar").style.width="100%";
  $("ball").style.left="0";
  $("lbl-progress").textContent = `${answered}/5`;
  $("lbl-nivel").textContent = `Nivel ${level}`;
  $("lbl-titulo").textContent = LEVEL_TITLES[level-1] || "Leyenda";
}

function startTimer(){
  clearInterval(timer);
  secs = 20;
  const bar=$("tbar"), ball=$("ball");
  timer = setInterval(()=>{
    secs--;
    const p = Math.max(0, secs/20*100);
    bar.style.width = p+"%";
    ball.style.left = (100-p)+"%";
    if(secs<=0){
      clearInterval(timer);
      perder();
      finPregunta();
    }
  },1000);
}

function elegirPregunta(){
  // Entrenamiento: 3 preguntas de niveles bajos
  if(!trained){
    let count = parseInt(localStorage.getItem("train_"+me.username) || "0",10);
    const pool = easy.filter(i=>!used.has(i));
    if(pool.length===0){ used.clear(); }
    const idx = rnd(pool.length ? pool : easy);
    used.add(idx);
    currentQ = { idx, data: Q[idx], training:true, tcount:count };
    return;
  }
  // Juego real: 5 preguntas por nivel
  if(answered===0) round = freshQuestionIndices(level, 5);
  const idx = round[answered] ?? rnd(Q.map((_,i)=>i).filter(i=>!used.has(i)));
  used.add(idx);
  currentQ = { idx, data: Q[idx], training:false };
}

$("btn-start").onclick = ()=>{
  // Validar entrenamiento y/o saldo
  if(!isAdmin){
    if(!trained){
      let count = parseInt(localStorage.getItem("train_"+me.username) || "0",10);
      if(count>=3){
        $("card-train").style.display="block";
        toast("âš ï¸ Entrenamiento finalizado. ComprÃ¡ monedas para seguir.");
        return;
      }
    }else{
      const bet = parseInt($("inp-bet").value,10);
      if(isNaN(bet) || bet<500){ toast("La apuesta mÃ­nima es 500."); return; }
      if((me.coins||0) < bet){ toast("No tenÃ©s monedas suficientes."); return; }
      currentBet = bet;
    }
  } else {
    currentBet = 0; // admin no paga
  }

  play("snd-bet");
  $("box-bet").style.display="none";
  $("box-q").style.display="block";
  $("btn-next").style.display="none";

  elegirPregunta();
  const p = currentQ.data;
  $("qtext").textContent = p.q;
  const ops = $("opts"); ops.innerHTML="";
  p.o.forEach((txt, i)=>{
    const b=document.createElement("button");
    b.className="opt";
    b.textContent = txt;
    b.onclick = ()=> responder(i);
    ops.appendChild(b);
  });

  startTimer();
};

function finPregunta(){
  $("btn-next").style.display="inline-block";
}

$("btn-next").onclick = ()=>{
  // avance de nivel
  if(!currentQ.training){
    answered++;
    $("lbl-progress").textContent = `${answered}/5`;
    if(answered>=5){
      answered = 0;
      level = Math.min(15, level+1);
      toast(`â¬†ï¸ Â¡Subiste a Nivel ${level}!`);
    }
  }else{
    // aumentar contador de entrenamiento
    let c = parseInt(localStorage.getItem("train_"+me.username) || "0",10);
    c++;
    localStorage.setItem("train_"+me.username, String(c));
    if(c>=3){
      trained = true;
      $("card-train").style.display="block";
    }
  }
  mostrarApuesta();
};

async function ganar(){
  play("snd-ok");
  confettiBurst();
  toast(`âœ… Â¡Correcto! +${currentBet}`);
  if(!isAdmin && currentBet>0){
    me.coins = (me.coins||0) + currentBet;
    $("lbl-coins").textContent = me.coins;
    await supabase.from("users").update({ coins: me.coins }).eq("id", me.id);
  }
}
async function perder(){
  play("snd-bad");
  toast(`âŒ Incorrecto / tiempo. -${currentBet}`);
  if(!isAdmin && currentBet>0){
    me.coins = Math.max(0,(me.coins||0) - currentBet);
    $("lbl-coins").textContent = me.coins;
    await supabase.from("users").update({ coins: me.coins }).eq("id", me.id);
  }
}
function responder(i){
  clearInterval(timer);
  if(i===currentQ.data.c) ganar(); else perder();
  finPregunta();
}

/* MenÃº principal */
$("btn-menu").onclick = ()=>{
  if(confirm("Â¿Volver al menÃº principal? PerderÃ¡s la pregunta actual.")){
    $("row-app").style.display="none";
    $("card-login").style.display="block";
  }
};

/* =========================
   CHAT (Realtime) + RANKING
========================= */
$("btn-send").onclick = async ()=>{
  const t = $("inp-msg").value.trim();
  if(!t) return;
  if(!me && !isAdmin){ toast("DebÃ©s entrar con un alias."); return; }
  const username = isAdmin ? "ğŸ›¡ï¸ Staff" : me.username;
  $("inp-msg").value="";
  await supabase.from("messages").insert([{ username, content: t }]);
  play("snd-crowd");
};
async function cargarChat(){
  const { data } = await supabase.from("messages").select("*").order("created_at",{ascending:true}).limit(200);
  pintarChat(data||[]);
}
function pintarChat(rows){
  const chat=$("chat"); chat.innerHTML="";
  rows.forEach(r=>{
    const line=document.createElement("div");
    line.className="msg";
    const who = document.createElement("div"); who.className="who"; who.textContent=r.username+":";
    const txt = document.createElement("div"); txt.className="txt"; txt.textContent=r.content;
    line.appendChild(who); line.appendChild(txt);
    if(isAdmin){
      const btn = document.createElement("button");
      btn.className="x"; btn.textContent="ğŸ—‘ï¸";
      btn.title="Eliminar mensaje";
      btn.onclick = async ()=>{ await supabase.from("messages").delete().eq("id", r.id); };
      line.appendChild(btn);
    }
    chat.appendChild(line);
  });
  chat.scrollTop = chat.scrollHeight;
}
function suscribirChat(){
  supabase.channel('room:messages')
    .on('postgres_changes', { event:'*', schema:'public', table:'messages' }, payload=>{
      cargarChat();
    }).subscribe();
}
async function cargarRanking(){
  const { data } = await supabase.from("users").select("username,coins").order("coins",{ascending:false}).limit(50);
  const box=$("ranking"); box.innerHTML="";
  (data||[]).forEach((r,i)=>{
    const d=document.createElement("div");
    d.className="item";
    d.textContent = `#${i+1} ${r.username} â€” $${r.coins}`;
    box.appendChild(d);
  });
}
function cargarRankingRegular(){
  cargarRanking();
  setInterval(cargarRanking, 12000);
}

/* =========================
   TIENDA
========================= */
document.querySelectorAll(".store .btn").forEach(b=>{
  b.addEventListener("click", ()=>{
    const url=b.getAttribute("data-url");
    const amount=b.getAttribute("data-amount");
    toast(`Vas a Mercado Pago por ${amount} monedas. CompartÃ­ el comprobante en el chat para la acreditaciÃ³n.`);
    window.open(url,"_blank");
  });
});

/* =========================
   ADMIN PANEL
========================= */
$("adm-add").onclick = ()=> adminUpdateCoins(+1);
$("adm-sub").onclick = ()=> adminUpdateCoins(-1);
$("adm-delchat").onclick = async ()=>{
  if(confirm("Â¿Borrar TODO el chat?")){ await supabase.from("messages").delete().neq("id",-1); }
};
$("adm-deluser").onclick = async ()=>{
  const u = $("adm-username").value.trim();
  if(!u){ toast("Alias requerido"); return; }
  if(!confirm(`Eliminar usuario ${u}?`)) return;
  await supabase.from("users").delete().eq("username", u);
  toast(`Usuario ${u} eliminado.`);
  cargarRanking();
};
$("adm-close").onclick = ()=>{ $("admin-panel").style.display="none"; toast("Panel admin cerrado"); };
$("adm-home").onclick = ()=>{
  $("row-app").style.display="none"; $("card-login").style.display="block"; isAdmin=false; me=null;
};

async function adminUpdateCoins(sign){
  const u = $("adm-username").value.trim();
  const a = parseInt($("adm-amount").value,10);
  if(!u || isNaN(a)){ toast("CompletÃ¡ alias y monto"); return; }
  const delta = sign*a;
  // Buscar usuario
  let { data:user } = await supabase.from("users").select("*").eq("username", u).maybeSingle();
  if(!user){ toast("Usuario no existe"); return; }
  const newCoins = Math.max(0, (user.coins||0) + delta);
  await supabase.from("users").update({ coins:newCoins }).eq("id", user.id);
  toast(`Listo: ${u} ahora tiene $${newCoins}`);
  cargarRanking();
}
</script>
</body>
</html>
