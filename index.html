<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Vicentinos Challenge ‚Äî Estilo Preguntados</title>
<meta name="theme-color" content="#0a2bff" />
<link rel="preconnect" href="https://fonts.gstatic.com  " crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
<script src="  https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2  "></script>
<style>
/* ===================== ESTILO COMPLETO ===================== */
:root{
  --bg:#0c0f24;        /* fondo gamer/casino */
  --card:#111537;      /* cartas */
  --card-2:#0f1330;    /* cartas secundarias */
  --primary:#1f6fff;   /* azul vibrante */
  --accent:#ff7a18;    /* naranja casino */
  --accent-2:#ffb703;  /* dorado */
  --ok:#19d47b;
  --bad:#f44336;
  --text:#f2f6ff;
  --muted:#98a2b3;
  --ring: 0 0 0 3px rgba(31,111,255,.35);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background: radial-gradient(1200px 800px at 10% -10%, #122261 0%, transparent 60%),
                  radial-gradient(1000px 700px at 120% 0%, #1a336e 0%, transparent 60%),
                  var(--bg);
  font-family: Poppins, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
  color: var(--text);
}
.container{max-width:1100px;margin:0 auto;padding:16px}
header{position:sticky;top:0;z-index:50;background:rgba(12,15,36,.75);backdrop-filter: blur(8px);border-bottom:1px solid #1b2250}
.nav{display:flex;align-items:center;justify-content:space-between;padding:10px 16px}
.brand{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.3px}
.logo{width:36px;height:36px;border-radius:50%;background: conic-gradient(from 0deg, var(--accent), var(--primary), var(--accent-2), var(--accent));box-shadow:0 0 0 3px rgba(255,255,255,.08)}
.tag{margin-left:8px;padding:2px 8px;border-radius:999px;background:linear-gradient(90deg,#1536a8,#1f6fff);font-size:12px;color:#fff;box-shadow:0 2px 0 #0d1b6a}
.flex{display:flex;align-items:center;gap:8px}
.badge{font-size:12px;background:#0f1330;border:1px solid #203089;padding:6px 10px;border-radius:999px}
.hidden{display:none!important}

.banner{position:relative;height:210px;border-radius:16px;overflow:hidden;margin:16px 0;box-shadow:0 10px 40px rgba(0,0,0,.35),0 0 0 1px rgba(255,255,255,.06) inset}
.banner img{width:100%;height:100%;object-fit:cover;filter:saturate(1.1) contrast(1.05)}
.banner .shine{position:absolute;inset:0;background: radial-gradient(650px 140px at 60% -20%, rgba(255,255,255,.18), transparent 50%), radial-gradient(900px 200px at -10% 120%, rgba(255,255,255,.12), transparent 50%)}

.grid{display:grid;grid-template-columns: 1.4fr .9fr;gap:16px}
@media (max-width:980px){.grid{grid-template-columns:1fr}}

.card{background:linear-gradient(180deg, rgba(23,30,84,.65), rgba(16,19,48,.65));border:1px solid #202a6a;border-radius:16px;padding:16px;box-shadow:0 12px 40px rgba(0,0,0,.35)}
.section-title{font-weight:800;margin-bottom:8px}
.section-sub{color:var(--muted);font-weight:600;font-size:.9rem}
.row{display:flex;gap:8px;align-items:center}
.grow{flex:1}
input,button,.btn{font-family:inherit}
input{background:#0d1336;border:1px solid #24308a;color:var(--text);border-radius:12px;padding:10px 12px;outline:none}
input:focus{box-shadow:var(--ring);border-color:#2f51ff}
button{background:linear-gradient(180deg,#2454ff,#173ee2);border:0;color:#fff;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;box-shadow:0 6px 0 #0d2aa3}
button:active{transform:translateY(1px);box-shadow:0 4px 0 #0d2aa3}
.btn-alt{background:linear-gradient(180deg,#ff8a25,#ff6d00);box-shadow:0 6px 0 #b74a00}
.btn-ghost{background:#0e153f;border:1px solid #2a3aa2;box-shadow:none}
.btn-danger{background:linear-gradient(180deg,#ff5a5a,#e12f2f);box-shadow:0 6px 0 #9c1d1d}
.lock{font-size:12px;background:#13206b;border:1px solid #2840b4;color:#d2dcff;padding:2px 8px;border-radius:999px}
.stat{background:#0e153f;border:1px solid #24308a;color:#d9e3ff;border-radius:12px;padding:8px 10px;font-weight:700}
.level-chip{background:linear-gradient(180deg,#1b2ea8,#2847ff);border:0;box-shadow:0 4px 0 #0d1b6a}

.qbox{background:linear-gradient(180deg,#0f143e,#0b0f2f);border:1px solid #26358a;border-radius:14px;padding:14px;font-weight:700;min-height:64px;display:flex;align-items:center}
.opts{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
@media (max-width:720px){.opts{grid-template-columns:1fr}}
.opt{background:#0e153f;border:1px solid #2a3aa2;border-radius:12px;padding:10px;font-weight:700;cursor:pointer;transition:transform .08s}
.opt:hover{transform:translateY(-1px)}
.opt.correct{border-color:#1ec77d;background:linear-gradient(180deg,#0f2c2a,#0b1e1d)}
.opt.wrong{border-color:#ff5454;background:linear-gradient(180deg,#2a0f16,#1d0b0e)}
.opt.disabled{opacity:.6;pointer-events:none}
.disabled{opacity:.6;pointer-events:none}

.timer{height:8px;background:#0d1240;border-radius:999px;border:1px solid #23318f;margin:12px 0;overflow:hidden}
#timerBar{height:100%;width:0;background:linear-gradient(90deg,#26ffb8,#1f6fff)}

.table{width:100%;border-collapse:collapse;margin-top:8px}
.table th,.table td{border-bottom:1px solid #22307a;padding:8px;text-align:left}
.table tbody tr:hover{background:rgba(255,255,255,.04)}

.chat{height:260px;overflow:auto;border:1px solid #22307a;border-radius:12px;padding:10px;background:#0d1336}
.msg{margin:6px 0}
.msg .who{font-weight:700;margin-right:6px}
.msg.admin{color:#ffd782}

.hr{height:1px;background:#22307a;margin:12px 0}
.welcome{font-weight:800;text-align:center;margin:10px 0;color:#e8eeff}

.toast{position:fixed;bottom:18px;left:50%;transform:translateX(-50%);background:#0e153f;border:1px solid #2a3aa2;color:#fff;padding:12px 16px;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,.45);opacity:0;pointer-events:none;transition:opacity .2s}
.toast.show{opacity:1}

.links a{color:#cfe2ff;text-decoration:none}
.links a:hover{text-decoration:underline}

/* apuesta rueda */
.wheel{position:relative;height:140px;border-radius:16px;background:conic-gradient(from 0deg,#1f6fff 0 25%, #ff7a18 0 50%, #1f6fff 0 75%, #ffb703 0 100%);display:flex;align-items:center;justify-content:center;box-shadow:0 10px 40px rgba(0,0,0,.42), inset 0 0 0 10px rgba(0,0,0,.18)}
.wheel .center{background:#0e153f;border:2px solid #2a3aa2;border-radius:14px;padding:10px 14px;text-align:center}
</style>
</head>
<body>
<header>
  <div class="nav container">
    <div class="brand"><div class="logo"></div><div>Vicentinos Challenge</div><span class="tag">Estilo Preguntados</span></div>
    <div class="rfloat flex">
      <div id="userBadge" class="badge hidden"></div>
      <button class="btn-ghost" id="btnLogout" style="display:none">Salir</button>
    </div>
  </div>
</header>

<div class="container">
  <div class="banner">
    <img src="https://i.ibb.co/kVGptVnJ/wp2896798.jpg  " alt="banner rugby">
    <div class="shine"></div>
  </div>

  <div id="welcome" class="welcome hidden">¬°Bienvenido a Vicentinos Challenge! üèâ</div>

  <div class="grid">
    <!-- Juego -->
    <div class="card">
      <div class="section-title">üéÆ Juego <span class="section-sub">Apost√°, acert√° y escal√° 15 niveles</span></div>
      <div id="loginBox" class="row">
        <input class="grow" id="aliasInput" placeholder="Eleg√≠ tu alias o peg√° el token admin" />
        <button id="btnLogin">Ingresar</button>
      </div>

      <div id="hud" class="row hidden" style="margin-top:6px">
        <div class="stat">Nivel: <b id="hudLevel">1</b></div>
        <div class="stat">Monedas: <b id="hudCoins">0</b></div>
        <div class="stat">Correctas: <b id="hudCorrect">0</b></div>
        <div class="stat">Incorrectas: <b id="hudWrong">0</b></div>
        <div class="stat">Promedio: <b id="hudAvg">0%</b></div>
      </div>

      <div id="adminPanel" class="card hidden" style="margin-top:12px">
        <div class="section-title">üõ°Ô∏è Panel Admin <span class="lock">token activo</span></div>
        <div class="row">
          <input id="admUser" placeholder="Alias usuario" />
          <input id="admCoins" type="number" placeholder="Monedas (+/-)" />
          <button id="admAdd">Sumar/Restar</button>
          <button id="admCreate" class="btn-alt">Crear</button>
          <button id="admDelete" class="btn-danger">Eliminar</button>
          <button id="admBlock" class="btn-ghost">Bloquear/Desbloquear</button>
          <button id="admExit" class="btn-ghost">Volver</button>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="admClearChat" class="btn-ghost">Limpiar chat</button>
        </div>
      </div>

      <div id="casino" class="hidden">
        <div class="wheel"><div class="center"><div style="font-size:12px;opacity:.8">Apuesta</div><div id="wheelBet" style="font-size:18px">500</div></div></div>
        <div class="row">
          <input id="betInput" type="number" min="500" step="100" placeholder="Apuesta m√≠nima $500" class="grow" />
          <button id="btnBet" class="btn-alt">Confirmar apuesta</button>
          <div class="stat rfloat level-chip">Nivel <span id="levelChip">1</span>/15</div>
        </div>
        <div id="freeInfo" class="notif hidden">Ten√©s <b id="freeLeft">3</b> preguntas gratis sin apostar.</div>
        <div class="timer"><div id="timerBar"></div></div>
        <div class="qbox" id="qText">Eleg√≠ apuesta y arrancamos‚Ä¶</div>
        <div class="opts" id="optList"></div>
        <div class="row" style="margin-top:8px">
          <button id="btnNext" class="btn-ghost disabled">Siguiente</button>
          <div class="rfloat flex links">
            <a href="https://mpago.la/16CyPeY  " target="_blank" rel="noopener">Pack $2000 ‚Üí 2000 monedas</a> ¬∑
            <a href="https://mpago.la/1TTVVcV  " target="_blank" rel="noopener">Pack $5000 ‚Üí 5000 monedas</a> ¬∑
            <a href="https://mpago.la/2HR6fjA  " target="_blank" rel="noopener">Pack $10000 ‚Üí 10000 monedas</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Ranking + Chat -->
    <div class="card">
      <div class="section-title">üèÜ Ranking <span class="section-sub">Promedio ponderado</span></div>
      <table class="table" id="rankTable">
        <thead><tr><th>#</th><th>Alias</th><th>Prom.</th><th>Nivel</th><th>Monedas</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="hr"></div>
      <div class="section-title">üí¨ Chat</div>
      <div id="chatBox" class="chat"></div>
      <div class="row" style="margin-top:8px">
        <input id="chatInput" placeholder="Escrib√≠ un mensaje‚Ä¶" class="grow" />
        <button id="chatSend">Enviar</button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ===================== CONFIG ===================== */
// ‚ö†Ô∏è Peg√° tu URL/KEY de Supabase para habilitar ranking/chat globales.
// Si se dejan vac√≠os o fallan las llamadas, el juego usa localStorage.
const SUPABASE_URL = "https://aqkqbtunbyifbfrvkpxv.supabase.co  "; // de tu archivo
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFxa3FidHVuYnlpZmJmcnZrcHh2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyOTg5NDgsImV4cCI6MjA3MDg3NDk0OH0.Xqtii5yiIO6tFOzzqza70ZA7N1KmbcTIkoNtV5YCVDY"; // <-- pega aqu√≠ tu anon key completa
const ADMIN_TOKEN = "20250819802006"; // token admin
const MIN_BET = 500;
const FREE_QUESTIONS = 3;
const TOTAL_LEVELS = 15;
const QUESTIONS_PER_LEVEL = 5; // 15 x 5 = 75; los 5 restantes se sortean como bonus
const TIME_PER_QUESTION = 20; // seg

/* ===================== HELPERS ===================== */
const $ = s=>document.querySelector(s);
const $$ = s=>document.querySelectorAll(s);
const wait = ms=>new Promise(r=>setTimeout(r, ms));
const fmt = n=> new Intl.NumberFormat('es-AR').format(n);
function toast(msg, ms=2200){ const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), ms); }

/* ===================== STORAGE (fallback) ===================== */
function dbGet(key){ return JSON.parse(localStorage.getItem(key)||'[]'); }
function dbSet(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

/* ===================== SUPABASE ===================== */
let supa = null; let online=false;
try{
  if(SUPABASE_URL && SUPABASE_KEY){
    supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {auth:{autoRefreshToken:false,persistSession:false}});
    online = true;
  }
}catch(e){ online=false; }

/* ===================== ESTADO ===================== */
let user=null; // {alias, coins, level, correct_answers, wrong_answers, blocked}
let freeLeft = FREE_QUESTIONS;
let currentQ=null; let currentBet=MIN_BET; let timer=null; let timeLeft=TIME_PER_QUESTION; let asked=new Set(); let levelCount=0;

/* ===================== PREGUNTAS (80) ===================== */
// Cada obj: {q, a:[op1, op2, op3], i:indexCorrecto (0..2), lvl:1..15}
const QUESTIONS = [
  {q:"¬øCu√°ntos jugadores tiene un equipo de rugby union en cancha?", a:["13", "15", "11"], i:1, lvl:1},
  {q:"¬øC√≥mo se llama el puntaje obtenido al apoyar la pelota en el in-goal rival?", a:["Try", "Drop", "Scrum"], i:0, lvl:1},
  {q:"¬øCu√°ntos puntos vale un try en rugby union desde 1992?", a:["4", "5", "6"], i:1, lvl:1},
  {q:"¬øQu√© tarjeta indica expulsi√≥n definitiva?", a:["Amarilla", "Roja", "Azul"], i:1, lvl:1},
  {q:"¬øC√≥mo se reinicia el juego tras un pase hacia adelante accidental?", a:["Lineout", "Scrum", "Kick-off"], i:1, lvl:1},
  {q:"¬øQu√© pa√≠s gan√≥ la primera Copa del Mundo (1987)?", a:["Nueva Zelanda", "Sud√°frica", "Australia"], i:0, lvl:2},
  {q:"¬øC√≥mo se llama el tiro de bote pronto con el pie que vale 3 puntos?", a:["Drop goal", "Punt", "Grubber"], i:0, lvl:2},
  {q:"¬øQu√© posici√≥n suele usar el n√∫mero 10?", a:["Apertura", "Hooker", "Wing"], i:0, lvl:2},
  {q:"¬øCu√°ntos √°rbitros de campo hay en rugby union?", a:["1", "2", "3"], i:0, lvl:2},
  {q:"¬øQu√© indica un pase hacia adelante?", a:["Penal", "Scrum", "Lineout"], i:1, lvl:2},
  {q:"¬øC√≥mo se llama el agrupamiento para disputar la pelota tras un tackle?", a:["Maul", "Ruck", "Melee"], i:1, lvl:3},
  {q:"¬øQu√© es un maul?", a:["Agrupamiento de pie empujando", "Pelota al piso post-tackle", "Saque lateral"], i:0, lvl:3},
  {q:"¬øQu√© jugador lanza la pelota en un lineout?", a:["Pilar", "Hooker", "Medio scrum"], i:1, lvl:3},
  {q:"¬øCu√°ntos puntos vale una conversi√≥n?", a:["2", "3", "1"], i:0, lvl:3},
  {q:"¬øQu√© infracci√≥n sanciona un offside?", a:["Avance", "Fuera de juego", "Juego peligroso"], i:1, lvl:3},
  {q:"¬øQu√© selecci√≥n es conocida como los All Blacks?", a:["Gales", "Nueva Zelanda", "Escocia"], i:1, lvl:4},
  {q:"¬øC√≥mo se denomina al n√∫mero 9?", a:["Wing", "Medio scrum", "Centro"], i:1, lvl:4},
  {q:"¬øQu√© hace el TMO?", a:["Juzga videos", "Controla offside en vivo", "Cronometra"], i:0, lvl:4},
  {q:"¬øQu√© equipo argentino compite en el S√∫per Rugby Am√©ricas como franquicia nacional?", a:["Ceibos", "Pampas", "Jaguares XV"], i:1, lvl:4},
  {q:"¬øCu√°ntos cambios t√°cticos se permiten por equipo en test matches?", a:["8", "6", "10"], i:0, lvl:4},
  {q:"¬øQu√© significa 'knock-on'?", a:["Pase largo", "Adelantar la pelota con la mano/brazo", "Pisar la l√≠nea"], i:1, lvl:5},
  {q:"¬øC√≥mo se reanuda tras un knock-on?", a:["Scrum", "Penal", "Lineout"], i:0, lvl:5},
  {q:"¬øCu√°ntos pilares hay en la primera l√≠nea?", a:["1", "2", "3"], i:1, lvl:5},
  {q:"¬øQu√© posici√≥n usa el n√∫mero 15?", a:["Fullback", "Wing", "Centro"], i:0, lvl:5},
  {q:"¬øQu√© pa√≠s es apodado los Springboks?", a:["Inglaterra", "Sud√°frica", "Irlanda"], i:1, lvl:5},
  {q:"¬øQu√© torneo del Hemisferio Norte re√∫ne a seis selecciones europeas?", a:["Tri Nations", "Seis Naciones", "Nations Cup"], i:1, lvl:6},
  {q:"¬øQu√© selecci√≥n argentina es conocida como Los Pumas?", a:["M20", "Mayor", "Seven"], i:1, lvl:6},
  {q:"¬øQu√© hace el hooker en el scrum?", a:["Patea la pelota hacia atr√°s", "Empuja desde afuera", "Dirige la l√≠nea"], i:0, lvl:6},
  {q:"¬øCu√°ndo se marca un penal try?", a:["Falta t√°ctica que evita try probable", "Try con patada", "Choque peligroso"], i:0, lvl:6},
  {q:"¬øCu√°nto vale un penal convertido a los palos?", a:["2", "3", "4"], i:1, lvl:6},
  {q:"¬øQu√© club argentino est√° en San Isidro y es cuna de muchos Pumas?", a:["CASI", "Newman", "La Plata RC"], i:0, lvl:7},
  {q:"¬øQui√©n fue el hist√≥rico apertura de Los Pumas que jug√≥ en Stade Fran√ßais y Racing 92?", a:["Juan Mart√≠n Hern√°ndez", "Nicol√°s S√°nchez", "Felipe Contepomi"], i:2, lvl:7},
  {q:"¬øQu√© indica el √°rbitro con el brazo en horizontal?", a:["Ventaja", "Scrum", "Tiempo"], i:0, lvl:7},
  {q:"¬øQu√© es un 'mark' en el in-goal propio?", a:["Pedido de scrum", "Pique libre tras atrapar un kick", "Tiempo muerto"], i:1, lvl:7},
  {q:"¬øQu√© selecci√≥n gan√≥ el Mundial 2019?", a:["Inglaterra", "Sud√°frica", "Nueva Zelanda"], i:1, lvl:7},
  {q:"¬øCu√°l es la distancia m√≠nima para un lineout?", a:["5 metros", "10 metros", "15 metros"], i:0, lvl:8},
  {q:"¬øQu√© indica el gesto de 'cuadrado' del √°rbitro hacia el TMO?", a:["Revisi√≥n de try", "Cambio", "Fuera de juego"], i:0, lvl:8},
  {q:"¬øQu√© se sanciona por ingresar de costado a un ruck?", a:["Scrum", "Penal", "Free kick"], i:1, lvl:8},
  {q:"¬øQui√©n es el capit√°n hist√≥rico de Los Pumas en 2007?", a:["Agust√≠n Pichot", "Juan Leguizam√≥n", "Mario Ledesma"], i:0, lvl:8},
  {q:"¬øQu√© valor tiene un drop goal?", a:["1", "2", "3"], i:2, lvl:8},
  {q:"¬øQu√© selecci√≥n es apodada Wallabies?", a:["Australia", "Italia", "Tonga"], i:0, lvl:9},
  {q:"¬øCu√°l es la amplitud m√≠nima del canal de lineout?", a:["1 metro", "3 metros", "0.5 metros"], i:0, lvl:9},
  {q:"¬øQu√© jugador suele usar el n√∫mero 7?", a:["Wing", "Tercera l√≠nea", "Centro"], i:1, lvl:9},
  {q:"¬øQu√© equipo argentino profesional compiti√≥ como Jaguares en Super Rugby?", a:["Club Jaguares", "Franquicia de UAR", "Pampas XV provincial"], i:1, lvl:9},
  {q:"¬øQu√© es un 'knock-on intencional'?", a:["Interceptar ilegalmente desviando hacia adelante", "Golpear con el pie", "Tocar lateral"], i:0, lvl:9},
  {q:"¬øQu√© pa√≠s organiza el Top 14?", a:["Inglaterra", "Francia", "Irlanda"], i:1, lvl:10},
  {q:"¬øCu√°l es la funci√≥n principal del medio scrum?", a:["Conectar forwards y backs", "Patear todo", "Defender √∫ltimo"], i:0, lvl:10},
  {q:"¬øQu√© infracci√≥n es levantar los pies del pilar rival en el scrum?", a:["Penal", "Free kick", "Nada"], i:0, lvl:10},
  {q:"¬øQu√© equipo argentino tiene estadio en V√©lez y lleg√≥ a la final 2019 del SR?", a:["Pumas", "Jaguares", "Pampas"], i:1, lvl:10},
  {q:"¬øCu√°ntos puntos suma un try penal?", a:["5 + conversi√≥n autom√°tica", "7 directos", "6 con drop"], i:1, lvl:10},
  {q:"¬øQu√© selecci√≥n es apodada Le Bleus?", a:["Italia", "Irlanda", "Francia"], i:2, lvl:11},
  {q:"¬øQu√© define el √°rbitro al decir 'use it' en un ruck/maul?", a:["Soltar la pelota", "Usar la pelota en 5 segundos", "Patear al touch"], i:1, lvl:11},
  {q:"¬øQu√© es 'advantage over'?", a:["Se acab√≥ la ventaja", "Hay nueva ventaja", "Penal directo"], i:0, lvl:11},
  {q:"¬øQu√© jugador argentino es goleador hist√≥rico de Los Pumas?", a:["Nicol√°s S√°nchez", "Hern√°ndez", "Contepomi"], i:0, lvl:11},
  {q:"¬øQu√© equipo gan√≥ el Mundial 2015?", a:["Nueva Zelanda", "Australia", "Sud√°frica"], i:0, lvl:11},
  {q:"¬øQu√© se cobra por tacklear alto a la cabeza?", a:["Scrum", "Penal y posible tarjeta", "Nada"], i:1, lvl:12},
  {q:"¬øQu√© debe hacer el tacklador tras el tackle?", a:["Soltar y ponerse de pie", "Empujar al rival", "Quedarse encima"], i:0, lvl:12},
  {q:"¬øQu√© lado saca el lineout?", a:["El que no cometi√≥ la infracci√≥n", "Siempre el local", "Lo decide el √°rbitro"], i:0, lvl:12},
  {q:"¬øC√≥mo se llama el torneo del Hemisferio Sur de selecciones?", a:["Seis Naciones", "Rugby Championship", "Tri Nations europeo"], i:1, lvl:12},
  {q:"¬øQu√© club de Buenos Aires es apodado Cardenales?", a:["SIC", "Newman", "Belgrano"], i:1, lvl:12},
  {q:"¬øCu√°l es el largo m√°ximo de una patada de salida v√°lida?", a:["Debe superar la l√≠nea de 10m", "Debe salir afuera", "Debe picar 2 veces"], i:0, lvl:13},
  {q:"¬øQu√© es un '50:22'?", a:["Regla de scrum", "Kick que pica en 22 rival desde propio 50 y da lineout al que patea", "Se√±al de √°rbitro"], i:1, lvl:13},
  {q:"¬øQu√© sanci√≥n corresponde por no liberar la pelota en el piso?", a:["Penal", "Scrum", "Lineout"], i:0, lvl:13},
  {q:"¬øQu√© equipo ingl√©s juega en Twickenham Stoop?", a:["Leicester", "Harlequins", "Saracens"], i:1, lvl:13},
  {q:"¬øQu√© pa√≠s gan√≥ el Mundial 2003?", a:["Inglaterra", "Australia", "Francia"], i:0, lvl:13},
  {q:"¬øQu√© rol tiene el fullback en defensa?", a:["√öltimo hombre y recepci√≥n de kicks", "Empujar scrum", "Lanzar lineout"], i:0, lvl:14},
  {q:"¬øQu√© indica el √°rbitro con brazo arriba y silbato?", a:["Penal", "Scrum", "Ventaja"], i:0, lvl:14},
  {q:"¬øQu√© club argentino es conocido como Marr√≥n?", a:["Belgrano Athletic", "Hind√∫", "San Luis"], i:0, lvl:14},
  {q:"¬øQu√© posici√≥n suelen ocupar los n√∫meros 12 y 13?", a:["Pilares", "Centros", "Wings"], i:1, lvl:14},
  {q:"¬øQu√© equipo gan√≥ el Rugby World Cup 2007?", a:["Sud√°frica", "Inglaterra", "Nueva Zelanda"], i:0, lvl:14},
  {q:"¬øQu√© es 'crocodile roll' y c√≥mo se sanciona?", a:["Despejar ruck girando rival: peligroso, penal", "Tackle legal", "Empuje en maul"], i:0, lvl:15},
  {q:"¬øQu√© indica 'deliberate knock-on' generalmente?", a:["Tarjeta y penal", "Scrum", "Nada"], i:0, lvl:15},
  {q:"¬øQu√© naci√≥n tiene m√°s t√≠tulos mundiales hasta 2023?", a:["Nueva Zelanda", "Sud√°frica", "Australia"], i:1, lvl:15},
  {q:"¬øQu√© estadio es la casa del rugby ingl√©s?", a:["Murrayfield", "Twickenham", "Cardiff"], i:1, lvl:15},
  {q:"¬øQu√© partido ganaron Los Pumas por primera vez a los All Blacks (a√±o)?", a:["2020", "2015", "2022"], i:0, lvl:15}
];
while(QUESTIONS.length<80){ // completar 80 con variaciones
  const base=[
    {q:"¬øCu√°ntos jueces de touch asisten al √°rbitro?", a:["2", "1", "3"], i:0, lvl:5},
    {q:"¬øQu√© equipo europeo viste de verde y tr√©bol?", a:["Gales", "Irlanda", "Italia"], i:1, lvl:6},
    {q:"¬øQu√© es 'obstrucci√≥n' en ataque?", a:["Bloquear defensor sin pelota", "Pisar touch", "Avanzar en offside"], i:0, lvl:9},
    {q:"¬øQu√© selecci√≥n gan√≥ el Mundial 1999?", a:["Australia", "Francia", "Sud√°frica"], i:0, lvl:10},
    {q:"¬øQu√© equipo argentino de San Isidro es apodado Zanja?", a:["SIC", "CASI", "Newman"], i:1, lvl:11}
  ];
  QUESTIONS.push(base[(QUESTIONS.length)%base.length]);
}

/* ===================== UI & L√ìGICA ===================== */
const aliasInput=$('#aliasInput');
const btnLogin=$('#btnLogin');
const btnLogout=$('#btnLogout');
const userBadge=$('#userBadge');
const loginBox=$('#loginBox');
const casino=$('#casino');
const hud=$('#hud');
const levelChip=$('#levelChip');
const wheelBet=$('#wheelBet');
const betInput=$('#betInput');
const btnBet=$('#btnBet');
const qText=$('#qText');
const optList=$('#optList');
const btnNext=$('#btnNext');
const timerBar=$('#timerBar');
const freeInfo=$('#freeInfo');
const freeLeftEl=$('#freeLeft');

const rankTable=$('#rankTable tbody');
const chatBox=$('#chatBox');
const chatInput=$('#chatInput');
const chatSend=$('#chatSend');

const adminPanel=$('#adminPanel');
const admUser=$('#admUser');
const admCoins=$('#admCoins');
const admAdd=$('#admAdd');
const admCreate=$('#admCreate');
const admDelete=$('#admDelete');
const admBlock=$('#admBlock');
const admExit=$('#admExit');
const admClearChat=$('#admClearChat');

function setHUD(u){
  $('#hudLevel').textContent = u.level||1;
  levelChip.textContent = u.level||1;
  $('#hudCoins').textContent = fmt(u.coins||0);
  $('#hudCorrect').textContent = u.correct_answers||0;
  $('#hudWrong').textContent = u.wrong_answers||0;
  const t=(u.correct_answers||0)+(u.wrong_answers||0);
  $('#hudAvg').textContent = t? Math.round((u.correct_answers/t)*100)+'%':'0%';
}

async function upsertPlayer(u){
  if(online && supa){
    await supa.from('players').upsert({
      alias:u.alias, coins:u.coins||0, level:u.level||1,
      correct_answers:u.correct_answers||0, wrong_answers:u.wrong_answers||0,
      blocked: !!u.blocked
    });
  } else {
    const L=dbGet('players');
    const i=L.findIndex(x=>x.alias===u.alias);
    if(i>=0) L[i]=u; else L.push(u);
    dbSet('players',L);
  }
}

async function getPlayer(alias){
  if(online && supa){
    const {data}=await supa.from('players').select('*').eq('alias',alias).maybeSingle();
    return data||null;
  } else {
    return dbGet('players').find(x=>x.alias===alias)||null;
  }
}

async function ensurePlayer(alias){
  let u=await getPlayer(alias);
  if(!u){ u={alias, coins:0, level:1, correct_answers:0, wrong_answers:0, blocked:false}; await upsertPlayer(u);} 
  return u;
}

function startTimer(){
  timeLeft=TIME_PER_QUESTION; timerBar.style.width='100%';
  if(timer) clearInterval(timer);
  const total=TIME_PER_QUESTION;
  timer=setInterval(()=>{
    timeLeft--; const pct=Math.max(0, (timeLeft/total)*100); timerBar.style.width=pct+'%';
    if(timeLeft<=0){ clearInterval(timer); lockOptions(); answer(-1); }
  },1000);
}

function lockOptions(){ $$('.opt').forEach(el=>el.classList.add('disabled')); }
function unlockOptions(){ $$('.opt').forEach(el=>el.classList.remove('disabled')); }

function pickQuestion(){
  // por nivel: 5 preguntas; si se acaban, elegir al azar restante
  const currentLevel=user.level||1;
  const pool=QUESTIONS.map((q,idx)=>({q,idx}))
    .filter(o=> (o.q.lvl===currentLevel || QUESTIONS_PER_LEVEL<=0) && !asked.has(o.idx));
  let pick=pool[Math.floor(Math.random()*pool.length)];
  if(!pick){ // no quedan de este nivel -> cualquiera no usada
    const rest=QUESTIONS.map((q,idx)=>({q,idx})).filter(o=>!asked.has(o.idx));
    pick=rest[Math.floor(Math.random()*rest.length)];
  }
  asked.add(pick.idx);
  return pick.q;
}

function renderQuestion(){
  currentQ=pickQuestion();
  qText.textContent=currentQ.q;
  optList.innerHTML='';
  currentQ.a.forEach((txt,ix)=>{
    const b=document.createElement('button');
    b.className='opt'; b.textContent=txt; b.onclick=()=>{ answer(ix); };
    optList.appendChild(b);
  });
  btnNext.classList.add('disabled');
  startTimer(); unlockOptions();
}

async function answer(ix){
  lockOptions(); if(timer) clearInterval(timer);
  const correct = ix===currentQ.i;
  $$('.opt').forEach((el,i)=>{
    if(i===currentQ.i) el.classList.add('correct');
    if(i===ix && !correct) el.classList.add('wrong');
  });
  // econom√≠a
  const freeUse = freeLeft>0;
  if(freeUse){ freeLeft--; freeLeftEl.textContent=freeLeft; }
  if(!freeUse){
    if(correct) user.coins += currentBet; else user.coins = Math.max(0, user.coins - currentBet);
  }
  if(correct) user.correct_answers = (user.correct_answers||0)+1; else user.wrong_answers=(user.wrong_answers||0)+1;
  levelCount++;
  if(levelCount>=QUESTIONS_PER_LEVEL){ user.level=Math.min(TOTAL_LEVELS, (user.level||1)+1); levelCount=0; asked.clear(); toast('¬°Subiste de nivel!'); }
  setHUD(user); await upsertPlayer(user); refreshRanking();
  btnNext.classList.remove('disabled');
}

function setBet(){
  let v=parseInt(betInput.value||MIN_BET,10);
  if(isNaN(v)) v=MIN_BET; v=Math.max(MIN_BET, v);
  currentBet=v; wheelBet.textContent=fmt(v);
}

function scoreRow(u){
  const r=u.correct_answers||0, w=u.wrong_answers||0; const t=r+w; const acc=t? r/t:0; const coins=u.coins||0; const lvl=u.level||1;
  // ponderado 70% accuracy, 20% log monedas, 10% nivel
  return acc*0.7 + (Math.log10(Math.max(1,coins+1))/3)*0.2 + (lvl/TOTAL_LEVELS)*0.1;
}

async function refreshRanking(){
  let list=[];
  if(online && supa){ const {data}=await supa.from('players').select('*'); list=data||[]; }
  else { list=dbGet('players'); }
  list.sort((a,b)=> scoreRow(b)-scoreRow(a));
  rankTable.innerHTML='';
  list.slice(0,50).forEach((p,idx)=>{
    const r=p.correct_answers||0, w=p.wrong_answers||0; const t=r+w; const avg=t? Math.round((r/t)*100):0;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${idx+1}</td><td>${p.alias}</td><td>${avg}%</td><td>${p.level||1}</td><td>${fmt(p.coins||0)}</td>`;
    rankTable.appendChild(tr);
  });
}

/* ===================== LOGIN ===================== */
async function doLogin(){
  const v=(aliasInput.value||'').trim(); if(!v){ toast('Ingres√° un alias o token'); return; }
  if(v===ADMIN_TOKEN){
    loginBox.classList.add('hidden'); adminPanel.classList.remove('hidden'); $('#welcome').classList.remove('hidden'); $('#welcome').textContent='Modo administrador activo';
    $('#btnLogout').style.display='inline-block'; userBadge.classList.add('hidden'); casino.classList.add('hidden'); hud.classList.add('hidden');
    return;
  }
  user = await ensurePlayer(v);
  freeLeft = parseInt(localStorage.getItem(`free:${user.alias}`)||FREE_QUESTIONS,10);
  setHUD(user);
  userBadge.classList.remove('hidden'); userBadge.textContent=`${user.alias}`;
  loginBox.classList.add('hidden'); casino.classList.remove('hidden'); hud.classList.remove('hidden'); $('#welcome').classList.remove('hidden');
  freeLeftEl.textContent=freeLeft; freeInfo.classList.toggle('hidden', freeLeft<=0);
  setBet(); renderQuestion(); refreshRanking(); subscribeRealtime();
}

function doLogout(){
  user=null; loginBox.classList.remove('hidden'); adminPanel.classList.add('hidden'); casino.classList.add('hidden'); hud.classList.add('hidden'); userBadge.classList.add('hidden'); $('#btnLogout').style.display='none'; $('#welcome').classList.add('hidden');
}

btnLogin.onclick=doLogin; btnLogout.onclick=doLogout;
btnBet.onclick=()=>{ setBet(); toast('Apuesta lista'); renderQuestion(); };
betInput.oninput=()=>{ setBet(); };
btnNext.onclick=()=>{ if(btnNext.classList.contains('disabled')) return; renderQuestion(); };

window.addEventListener('beforeunload',()=>{ if(user) localStorage.setItem(`free:${user.alias}`, String(freeLeft)); });

/* ===================== CHAT ===================== */
async function loadChat(){
  let msgs=[]; if(online && supa){ const {data}=await supa.from('messages').select('*').order('ts',{ascending:true}); msgs=data||[]; }
  else { msgs=dbGet('messages'); }
  chatBox.innerHTML='';
  msgs.forEach(m=> appendMsg(m));
  chatBox.scrollTop = chatBox.scrollHeight;
}

function appendMsg(m){
  const d=document.createElement('div'); d.className='msg'+(m.admin?' admin':'');
  const ts = m.ts? new Date(m.ts): new Date();
  d.innerHTML = `<span class="who">${m.alias}</span> <span style="opacity:.6;font-size:12px">${ts.toLocaleTimeString()}</span> ‚Äî ${m.text}`;
  chatBox.appendChild(d);
}

async function sendMsg(){
  const txt=(chatInput.value||'').trim(); if(!txt) return;
  if(user && user.blocked){ toast('Usuario bloqueado para chatear'); return; }
  const msg={ id: Date.now(), alias: user? user.alias:"anon", text: txt, ts: new Date().toISOString(), admin: !user && adminPanel&&!loginBox.classList.contains('hidden') };
  if(online && supa){ await supa.from('messages').insert(msg); }
  else { const L=dbGet('messages'); L.push(msg); dbSet('messages',L); appendMsg(msg); }
  chatInput.value='';
}

chatSend.onclick=sendMsg; chatInput.addEventListener('keydown',e=>{ if(e.key==='Enter') sendMsg(); });

/* ===================== ADMIN ===================== */
admExit.onclick=()=>{ adminPanel.classList.add('hidden'); loginBox.classList.remove('hidden'); };

async function adminEnsure(alias){ let u=await getPlayer(alias); if(!u){ u={alias, coins:0, level:1, correct_answers:0, wrong_answers:0, blocked:false}; await upsertPlayer(u);} return u; }

admCreate.onclick=async()=>{ const a=(admUser.value||'').trim(); if(!a) return toast('Alias requerido'); await adminEnsure(a); toast('Usuario creado'); refreshRanking(); };
admDelete.onclick=async()=>{ const a=(admUser.value||'').trim(); if(!a) return toast('Alias requerido'); if(online && supa){ await supa.from('players').delete().eq('alias',a);} else { let L=dbGet('players').filter(x=>x.alias!==a); dbSet('players',L);} toast('Usuario eliminado'); refreshRanking(); };
admAdd.onclick=async()=>{ const a=(admUser.value||'').trim(); const v=parseInt(admCoins.value||0,10); if(!a) return toast('Alias requerido'); let u=await adminEnsure(a); u.coins=(u.coins||0)+v; if(u.coins<0) u.coins=0; await upsertPlayer(u); toast('Saldo actualizado'); refreshRanking(); };
admBlock.onclick=async()=>{ const a=(admUser.value||'').trim(); if(!a) return toast('Alias requerido'); let u=await adminEnsure(a); u.blocked=!u.blocked; await upsertPlayer(u); toast(u.blocked? 'Usuario bloqueado':'Usuario desbloqueado'); };
admClearChat.onclick=async()=>{ if(online && supa){ await supa.from('messages').delete().neq('id', -1);} else { dbSet('messages',[]); chatBox.innerHTML=''; } toast('Chat limpio'); };

/* ===================== REALTIME ===================== */
function subscribeRealtime(){ if(!online||!supa) return; try{
  supa.channel('any').on('postgres_changes',{event:'INSERT',schema:'public',table:'messages'}, payload=>{ appendMsg(payload.new); chatBox.scrollTop=chatBox.scrollHeight; }).subscribe();
  supa.channel('any2').on('postgres_changes',{event:'INSERT',schema:'public',table:'players'}, ()=>refreshRanking()).on('postgres_changes',{event:'UPDATE',schema:'public',table:'players'}, ()=>refreshRanking()).subscribe();
}catch(e){}
}

/* ===================== INIT ===================== */
(async function(){
  $('#btnLogout').style.display='none';
  await loadChat(); await refreshRanking();
  freeInfo.classList.add('hidden');
})();
</script>
</body>
</html>
