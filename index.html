<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Vicentinos Challenge ‚Äî Rugby Casino</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{
    --bg:#0a1020; --panel:#0f1730; --panel2:#0b1330;
    --acc:#ff7a00; --acc2:#ff9d3b; --blue:#1c56ff; --white:#f6f8ff;
    --ok:#2ee55f; --bad:#ff4b4b; --neon:#00eaff;
  }
  *{box-sizing:border-box}
  body{
    margin:0;background:radial-gradient(1200px 600px at 50% -10%,#10205a22,transparent),var(--bg);
    color:var(--white);font-family:Outfit,system-ui,Segoe UI,Roboto,Arial,sans-serif;
    min-height:100vh;display:flex;flex-direction:column;align-items:center
  }
  .banner{
    width:100%;height:180px;position:relative;border-bottom:3px solid var(--acc);
    background:url('https://i.ibb.co/kVGptVnJ/wp2896798.jpg') center/cover no-repeat;
    display:flex;align-items:flex-end;justify-content:center
  }
  .banner h1{
    margin:0 0 14px;border-radius:12px;padding:8px 16px;
    background:linear-gradient(90deg,#000000aa,#00000055);
    backdrop-filter:blur(2px);
    color:#fff;font-weight:800;letter-spacing:.5px;text-shadow:0 3px 18px #000
  }
  .content{width:96%;max-width:1050px;margin:16px auto 28px;display:grid;grid-template-columns:1fr;gap:16px}
  @media(min-width:980px){.content{grid-template-columns:2fr 1fr}}
  .card{
    background:linear-gradient(180deg,var(--panel),var(--panel2));
    border:1px solid #18235a;border-radius:14px;padding:14px;box-shadow:0 12px 30px #0007
  }
  .card h2{margin:4px 0 10px;font-size:1.2rem;color:#fff}
  .row{display:flex;gap:10px;align-items:center}
  .row>*{flex:1}
  input,button,select{
    width:100%;padding:12px 14px;border-radius:10px;border:1px solid #2a3a8a;background:#0c1440;color:#fff;
    font:600 15px Outfit,system-ui
  }
  input::placeholder{color:#9bb}
  button{cursor:pointer;background:linear-gradient(180deg,var(--acc),var(--acc2));border:none;color:#111;font-weight:800;letter-spacing:.3px}
  button:hover{transform:translateY(-1px);box-shadow:0 8px 22px #ff7a0022}
  .pill{display:inline-block;padding:5px 10px;border-radius:999px;background:#0b123a;border:1px solid #1f2b72;color:#9ec}
  .grid2{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:640px){.grid2{grid-template-columns:1fr 1fr}}
  .flex{display:flex;gap:10px;align-items:center}
  .right{justify-content:flex-end}
  .center{text-align:center}
  .hidden{display:none!important}
  /* Toast */
  .toast{position:fixed;top:18px;right:18px;z-index:9999;opacity:0;transform:translateY(-10px);transition:.3s}
  .toast.show{opacity:1;transform:none}
  .toast .box{background:#0b133a;border:1px solid var(--neon);padding:10px 14px;border-radius:10px;box-shadow:0 8px 24px #00eaff22}
  /* Juego */
  .hud{display:flex;gap:10px;flex-wrap:wrap}
  .hud .stat{background:#0b133a;border:1px solid #1f2b72;border-radius:10px;padding:8px 10px;min-width:120px}
  .question{font-size:1.08rem;line-height:1.45;margin:10px 0 8px}
  .opts{display:grid;gap:8px}
  .opts button{background:#0f1a55;border:1px solid #1f2b72;color:#eaf; text-align:left}
  .opts button:hover{border-color:#3e5cff;box-shadow:0 0 0 2px #3e5cff22}
  .betbox{background:#0b133a;border:1px solid #1f2b72;border-radius:12px;padding:10px;margin:8px 0}
  .timer{position:relative;height:22px;background:#091035;border:1px solid #1f2b72;border-radius:999px;overflow:hidden;margin:6px 0 10px}
  .timer .bar{position:absolute;left:0;top:0;height:100%;width:100%;background:linear-gradient(90deg,#2ee55f,#ffb000);transition:width 1s linear}
  .ball{position:absolute;top:-8px;left:0;width:38px;height:38px;background:url('https://i.postimg.cc/2SkhxQ6s/rugby-ball.png') center/contain no-repeat;filter:drop-shadow(0 3px 6px #000a)}
  .shake{animation:shake .6s cubic-bezier(.36,.07,.19,.97) both}
  @keyframes shake{10%,90%{transform:translate3d(-1px,0,0)}20%,80%{transform:translate3d(2px,0,0)}30%,50%,70%{transform:translate3d(-4px,0,0)}40%,60%{transform:translate3d(4px,0,0)}}
  /* Chat */
  .chatlist{height:260px;overflow:auto;background:#0a123a;border:1px solid #1d2a72;border-radius:10px;padding:10px}
  .msg{margin:6px 0;padding:6px 8px;background:#0e1750;border-left:3px solid #3e5cff;border-radius:8px}
  .msg .who{font-weight:700;color:#aef}
  .msg.sys{opacity:.8;border-left-color:#666}
  .tools{display:flex;gap:6px}
  /* Ranking */
  .rank{height:260px;overflow:auto;background:#0a123a;border:1px solid #1d2a72;border-radius:10px;padding:10px}
  .rank .item{padding:6px;border-bottom:1px dashed #1d2a72;display:flex;justify-content:space-between}
  /* Tienda */
  .store .pack{display:flex;gap:8px;align-items:center;justify-content:space-between;background:#0b133a;border:1px solid #1f2b72;border-radius:12px;padding:10px}
  .store .pack b{color:#fff}
  /* Confeti simple */
  .confetti{position:fixed;inset:0;pointer-events:none;z-index:9998}
  .confetti i{position:absolute;width:8px;height:14px;background:var(--acc);opacity:.9;animation:fall 1.2s linear forwards}
  @keyframes fall{to{transform:translateY(120vh) rotate(340deg);opacity:0}}
</style>
</head>
<body>
  <div class="banner"><h1>Vicentinos Challenge ‚Äî Rugby Trivia Casino</h1></div>

  <!-- SONIDOS -->
  <audio id="s-win" src="https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3" preload="auto"></audio>
  <audio id="s-lose" src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-946.mp3" preload="auto"></audio>
  <audio id="s-bet" src="https://assets.mixkit.co/sfx/preview/mixkit-coin-drop-384.mp3" preload="auto"></audio>
  <audio id="s-join" src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-opening-2034.mp3" preload="auto"></audio>
  <audio id="s-chat" src="https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-2574.mp3" preload="auto"></audio>
  <div id="confetti" class="confetti"></div>

  <div class="toast" id="toast"><div class="box" id="toastText"></div></div>

  <div class="content">

    <!-- COLUMNA IZQUIERDA: LOGIN + JUEGO -->
    <div class="card" id="loginCard">
      <h2>üéÆ Entrar al Juego</h2>
      <p class="pill center">Preparate para ir por los puntos</p>
      <div class="row">
        <input id="alias" maxlength="24" placeholder="Tu alias (ej: Pumita10)" />
        <button id="btnLogin">JUGAR</button>
      </div>
      <p class="center" style="opacity:.85;margin-top:6px">üí° Si es tu primera vez, te damos <b>3 preguntas de entrenamiento</b> sin apostar.</p>
    </div>

    <div class="card hidden" id="gameCard">
      <div class="hud">
        <div class="stat">üë§ Jugador: <b id="hudUser">-</b></div>
        <div class="stat">üí∞ Monedas: <b id="hudCoins">0</b></div>
        <div class="stat">üìà Nivel: <b id="hudLevel">1</b> / 15</div>
        <div class="stat">‚úÖ/‚ùå: <b id="hudStats">0 / 0</b></div>
      </div>

      <div id="trainInfo" class="pill" style="margin-top:8px;">üéÅ Te quedan <b id="freeLeft">3</b> preguntas de entrenamiento</div>

      <div id="betBox" class="betbox" style="margin-top:10px;">
        <div class="row">
          <input id="bet" type="number" min="500" step="100" value="500" />
          <button id="btnStartQ">Apostar y Jugar</button>
        </div>
        <small style="opacity:.8">Apuesta m√≠nima: <b>$500</b>. Primero apost√°s, <u>despu√©s</u> ves la pregunta.</small>
      </div>

      <div class="timer"><div id="tBar" class="bar"></div><div id="tBall" class="ball"></div></div>

      <div id="qBox">
        <div class="question" id="qText">‚Äî</div>
        <div class="opts" id="qOpts"></div>
      </div>

      <div class="flex right" style="margin-top:8px;">
        <button id="btnMenu" style="background:#1b2a80;color:#fff;border:1px solid #3e5cff">Volver al Men√∫</button>
      </div>
    </div>

    <!-- COLUMNA DERECHA: CHAT + RANK + TIENDA -->
    <div class="grid2">
      <div class="card">
        <h2>üí¨ Chat del Estadio</h2>
        <div id="chatList" class="chatlist"></div>
        <div class="row" style="margin-top:8px;">
          <input id="chatText" placeholder="Escrib√≠ tu mensaje..." />
          <button id="btnSend">Enviar</button>
        </div>
      </div>

      <div class="card">
        <h2>üèÜ Ranking</h2>
        <div id="rank" class="rank"></div>
      </div>

      <div class="card store">
        <h2>üõí Tienda de Monedas</h2>
        <p style="opacity:.9;margin-top:-4px;margin-bottom:8px">Ser√°s redirigido a Mercado Pago. Luego <b>compart√≠ el comprobante</b> en el chat y el admin acreditar√° las monedas a tu alias.</p>
        <div class="pack"><div><b>Pack $2.000</b><br><small>2.000 monedas</small></div><button data-url="https://mpago.la/16CyPeY" data-amt="2000">Comprar</button></div>
        <div class="pack"><div><b>Pack $5.000</b><br><small>5.000 monedas</small></div><button data-url="https://mpago.la/1TTVVcV" data-amt="5000">Comprar</button></div>
        <div class="pack"><div><b>Pack $10.000</b><br><small>10.000 monedas</small></div><button data-url="https://mpago.la/2HR6fjA" data-amt="10000">Comprar</button></div>
      </div>
    </div>

    <!-- PANEL ADMIN (OCULTO HASTA LOGUEAR CON TOKEN COMO ALIAS) -->
    <div class="card hidden" id="adminCard">
      <h2>üõ°Ô∏è Panel Admin</h2>
      <div class="row">
        <input id="aUser" placeholder="Alias usuario" />
        <input id="aAmount" type="number" placeholder="Monedas (+/-)" />
      </div>
      <div class="tools">
        <button id="aAdd">Cargar monedas</button>
        <button id="aSub">Restar monedas</button>
        <button id="aCreate" style="background:#13d4a3">Crear usuario</button>
        <button id="aDel" style="background:#ff4b4b">Eliminar usuario</button>
      </div>
      <hr style="border:none;border-top:1px solid #24317a;margin:12px 0">
      <div class="row">
        <input id="aMsgId" placeholder="ID mensaje chat" />
        <button id="aMsgDel" style="background:#ff8c5a">Borrar mensaje</button>
      </div>
      <div class="flex right" style="margin-top:8px;">
        <button id="aBack" style="background:#1b2a80;color:#fff;border:1px solid #3e5cff">Volver al Men√∫</button>
      </div>
      <small style="opacity:.7">‚ö†Ô∏è Si no pod√©s borrar un mensaje es por pol√≠ticas RLS de Supabase. Igual el cliente lo ocultar√°.</small>
    </div>

  </div>

<script>
/* ======================= SUPABASE CONFIG ======================= */
const SUPABASE_URL = "https://aqkqbtunbyifbfrvkpxv.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFxa3FidHVuYnlpZmJmcnZrcHh2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyOTg5NDgsImV4cCI6MjA3MDg3NDk0OH0.Xqtii5yiIO6tFOzzqza70ZA7N1KmbcTIkoNtV5YCVDY";
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ======================= STATE ======================= */
const ADMIN_TOKEN = "20250819802006";
let me = null; // {id, username, coins}
let level = 1;
let asked = new Set(); // ids preguntados
let correct = 0, wrong = 0;
let freeLeft = 3;
let ticking = null, timeLeft = 20;
let currentQ = null;
let currentBet = 0;

/* ======================= UI HELPERS ======================= */
const $ = id => document.getElementById(id);
const toast = (txt)=>{ $("toastText").textContent = txt; $("toast").classList.add("show"); setTimeout(()=>$("toast").classList.remove("show"),2000); }
const play = id => { const a=$(id); if(!a) return; a.currentTime=0; a.play().catch(()=>{}); }
const confetti = ()=>{
  const box=$("confetti"); box.innerHTML="";
  for(let i=0;i<80;i++){
    const p=document.createElement("i");
    p.style.left=(Math.random()*100)+"vw";
    p.style.background = Math.random()>.5? "var(--acc)" : "var(--neon)";
    p.style.animationDelay=(Math.random()*0.8)+"s";
    box.appendChild(p);
  }
  setTimeout(()=>box.innerHTML="",1500);
};

/* ======================= QUESTIONS (80) ======================= */
/* Cada item: {id, q, o:[a,b,c], c:indexCorrecto, d:dificultad 1..5} */
const QUESTIONS = [
  // Nivel 1-5 (b√°sico)
  {id:1,q:"¬øCu√°ntos jugadores por equipo en rugby XV?",o:["13","15","11"],c:1,d:1},
  {id:2,q:"¬øCu√°ntos puntos vale un try?",o:["5","3","7"],c:0,d:1},
  {id:3,q:"¬øEl bal√≥n de rugby tiene forma‚Ä¶?",o:["Esf√©rica","Ovalada","C√∫bica"],c:1,d:1},
  {id:4,q:"Duraci√≥n total de un partido de rugby XV (minutos)",o:["80","60","90"],c:0,d:1},
  {id:5,q:"Nombre del seleccionado argentino de rugby",o:["Los Jaguares","Los Pumas","Los C√≥ndores"],c:1,d:1},
  {id:6,q:"¬øCu√°ntos puntos suma una conversi√≥n?",o:["2","3","5"],c:0,d:1},
  {id:7,q:"¬øQu√© sucede tras un pase hacia adelante?",o:["Scrum","Line-out","Try"],c:0,d:1},
  {id:8,q:"¬øQu√© es un tackle alto?",o:["Contactar por encima de hombros","Derribar a la altura de la cintura","Barrer los pies"],c:0,d:1},
  {id:9,q:"¬øCu√°ntos puntos vale un penal convertido a los palos?",o:["2","3","4"],c:1,d:1},
  {id:10,q:"¬øDe qu√© pa√≠s es Jonah Lomu?",o:["Australia","Nueva Zelanda","Fiyi"],c:1,d:1},
  {id:11,q:"¬øCu√°ntos √°rbitros principales en cancha hay?",o:["1","2","3"],c:0,d:1},
  {id:12,q:"¬øQu√© reinicia el juego cuando la pelota sale por el lateral?",o:["Scrum","Line-out","Drop"],c:1,d:1},
  {id:13,q:"¬øCu√°ndo se marca un drop goal?",o:["Durante el juego abierto","S√≥lo tras penal","S√≥lo tras scrum"],c:0,d:1},
  {id:14,q:"Posici√≥n n√∫mero 10 habitualmente se llama‚Ä¶",o:["Apertura","Fullback","Hooker"],c:0,d:1},
  {id:15,q:"Posici√≥n n√∫mero 15 habitualmente es‚Ä¶",o:["Pilar","Wing","Fullback"],c:2,d:1},
  // Intermedio
  {id:16,q:"¬øQu√© hace el hooker en el scrum?",o:["Empuja desde afuera","Lanza el line","Talona el bal√≥n"],c:2,d:2},
  {id:17,q:"Un ruck ocurre cuando‚Ä¶",o:["La pelota est√° en el suelo y hay disputa","En el aire","En el line"],c:0,d:2},
  {id:18,q:"Tarjeta amarilla implica‚Ä¶",o:["Expulsi√≥n definitiva","10 min fuera","5 min fuera"],c:1,d:2},
  {id:19,q:"¬øCu√°ntos puntos vale un try penal?",o:["5","7","8"],c:1,d:2},
  {id:20,q:"En Argentina, el club SIC es de‚Ä¶",o:["San Isidro","Santa Fe","San Juan"],c:0,d:2},
  {id:21,q:"¬øQu√© equipo gan√≥ el Mundial 2023?",o:["Francia","Sud√°frica","Irlanda"],c:1,d:2},
  {id:22,q:"¬øCu√°l NO es funci√≥n de los forwards?",o:["Ganar pelotas fijas","Definir en velocidad por bandas","Formar scrums"],c:1,d:2},
  {id:23,q:"¬øQu√© marca la ventaja (advantage)?",o:["Se ignora toda infracci√≥n","Se permite continuar si conviene","Se anula el juego"],c:1,d:2},
  {id:24,q:"¬øQu√© es un maul?",o:["Disputa en el suelo","Formaci√≥n de pie con portador","Patada de reinicio"],c:1,d:2},
  {id:25,q:"¬øCu√°ntos puntos vale un drop goal?",o:["3","2","4"],c:0,d:2},
  {id:26,q:"¬øQu√© sucede con un knock-on?",o:["Line-out","Scrum para rival","Free-kick"],c:1,d:2},
  {id:27,q:"Capit√°n de Los Pumas en Bronce 2007",o:["Felipe Contepomi","Agust√≠n Pichot","Juan Mart√≠n Hern√°ndez"],c:1,d:2},
  {id:28,q:"¬øQu√© significa offside?",o:["Fuera de juego","Obstrucci√≥n","Juego peligroso"],c:0,d:2},
  {id:29,q:"¬øCu√°ntos cambios permitidos en rugby test (aprox.)?",o:["8","10","15"],c:0,d:2},
  {id:30,q:"Fullback suele ser el n√∫mero‚Ä¶",o:["14","15","13"],c:1,d:2},
  // Historia / AR
  {id:31,q:"M√≠tico apertura argentino, apodado 'El Mago'",o:["Hugo Porta","Juan Fern√°ndez Miranda","Nicol√°s S√°nchez"],c:0,d:3},
  {id:32,q:"Los Pumas entraron al Rugby Championship en‚Ä¶",o:["2010","2012","2014"],c:1,d:3},
  {id:33,q:"Primer triunfo de Los Pumas ante All Blacks fue en‚Ä¶",o:["2020","2022","2018"],c:0,d:3},
  {id:34,q:"M√°ximo try-man hist√≥rico de Los Pumas (test)",o:["Jos√© L. Gonz√°lez","Jos√© Mar√≠a N√∫√±ez Piossek","Juan Imhoff"],c:2,d:3},
  {id:35,q:"¬øQu√© hace el medio scrum (9)?",o:["Conduce desde base de ruck/scrum","Anota drops","Lanza el line"],c:0,d:3},
  {id:36,q:"En un line, ¬øqui√©n suele lanzar?",o:["Hooker","Apertura","Pilar"],c:0,d:3},
  {id:37,q:"¬øQu√© tarjeta implica expulsi√≥n definitiva?",o:["Amarilla","Roja","Azul"],c:1,d:3},
  {id:38,q:"El Mundial de Rugby se disputa cada‚Ä¶",o:["2 a√±os","3 a√±os","4 a√±os"],c:2,d:3},
  {id:39,q:"M√°ximo organismo rector del rugby mundial",o:["World Rugby","World Cup Board","IRL"],c:0,d:3},
  {id:40,q:"Apodo del seleccionado de Nueva Zelanda",o:["All Blacks","Springboks","Wallabies"],c:0,d:3},
  // Reglas m√°s finas / t√°ctica
  {id:41,q:"Se sanciona penal si el tackleador‚Ä¶",o:["No libera al tackleado","Pone la pelota al suelo","Se va hacia su campo"],c:0,d:3},
  {id:42,q:"¬øQu√© es contra-ruck?",o:["Empujar el scrum rival","Disputar el ruck agresivamente","Patear de sobrepique"],c:1,d:3},
  {id:43,q:"Zona de marca en rugby se llama‚Ä¶",o:["In-goal","Goal box","End zone"],c:0,d:3},
  {id:44,q:"Si una patada va directo afuera desde dentro de 22 propia‚Ä¶",o:["Line donde sali√≥","Line en origen","Scrum al pateador"],c:0,d:3},
  {id:45,q:"¬øQu√© es el mark?",o:["Pedir patada de salida","Se√±al al atrapar patada en 22","Orden de scrum"],c:1,d:3},
  {id:46,q:"¬øSe puede pasar hacia adelante?",o:["S√≠","No","S√≥lo en 22 rival"],c:1,d:3},
  {id:47,q:"'Drop out' se ejecuta desde‚Ä¶",o:["22 metros","Mitad de cancha","5 metros"],c:0,d:3},
  {id:48,q:"¬øQu√© penalidad por obstrucci√≥n intencional?",o:["Free-kick","Penal","Scrum"],c:1,d:3},
  {id:49,q:"¬øCu√°ntos puntos suma un try convertido?",o:["7","6","8"],c:0,d:3},
  {id:50,q:"Jugador 7 suele ser‚Ä¶",o:["Pilar derecho","Tercera l√≠nea ala","Centro"],c:1,d:3},
  // Avanzado
  {id:51,q:"¬øCu√°ndo se cobra 'holding on'?",o:["No liberar bal√≥n en el suelo","Cargar al pateador","Sujetar en line"],c:0,d:4},
  {id:52,q:"Deliberate knock-on usualmente resulta en‚Ä¶",o:["Scrum","Penal (y a veces amarilla)","Line"],c:1,d:4},
  {id:53,q:"En scrum, 'early push' es‚Ä¶",o:["Empujar antes de la orden","Entrar por el costado","No enganchar"],c:0,d:4},
  {id:54,q:"¬øQu√© es un 'box kick'?",o:["Patada corta del 9","Puntapi√© de salida","Drop a postes"],c:0,d:4},
  {id:55,q:"Si un defensor pisa dead-ball al atrapar bal√≥n en in-goal‚Ä¶",o:["22 drop out","Scrum 5 para atacante","Try penal"],c:0,d:4},
  {id:56,q:"Ley de ventaja termina cuando‚Ä¶",o:["√Årbitro lo indica o la ventaja se consume","Siempre que haya un pase","Con un knock-on"],c:0,d:4},
  {id:57,q:"¬øCu√°ntos saltadores t√≠picos en line est√°ndar?",o:["2‚Äì4","5‚Äì7","8‚Äì9"],c:0,d:4},
  {id:58,q:"'Counter-attack' describe‚Ä¶",o:["Defensa plegada","Salida r√°pida tras recuperar","Patada estrat√©gica"],c:1,d:4},
  {id:59,q:"En 5m de la l√≠nea de try, penal c/ scrum repetidas‚Ä¶",o:["Advertencia","Try penal probable","Free-kick"],c:1,d:4},
  {id:60,q:"Tarjeta por tackle peligroso con contacto cabeza (mitigaci√≥n baja)",o:["Generalmente roja","Generalmente amarilla","Nunca tarjeta"],c:0,d:4},
  // Muy dif√≠cil (14-15 casi imposibles)
  {id:61,q:"World Rugby Law 15 se refiere principalmente a‚Ä¶",o:["Ruck","Maul","Scrum"],c:0,d:5},
  {id:62,q:"Reinicio tras marca de fair catch fuera de 22 propia‚Ä¶",o:["Free-kick en lugar del mark","Scrum centro","Line rival"],c:0,d:5},
  {id:63,q:"Se permite quick throw en line si‚Ä¶",o:["Misma pelota y sin tocar a nadie","Cualquier pelota","Tras silbatazo"],c:0,d:5},
  {id:64,q:"En drop goal, la pelota debe‚Ä¶",o:["Picar antes de patear","Patearse de aire","Ser teed"],c:0,d:5},
  {id:65,q:"En scrum, el √°ngulo de entrada legal del pilar es‚Ä¶",o:["Hombro cuadrado y recto","45¬∞ hacia adentro","Cabeza por afuera"],c:0,d:5},
  {id:66,q:"Ley del '50:22' aplica cuando‚Ä¶",o:["Pate√°s detr√°s de mitad y sale dentro de 22 rival tras picar","Cualquier patada a touche","S√≥lo desde 22 propia"],c:0,d:5},
  {id:67,q:"Si un jugador en offside recibe patada rival desviada en compa√±ero‚Ä¶",o:["Sigue offside (no habilita)","Queda habilitado","Scrum"],c:0,d:5},
  {id:68,q:"¬øCu√°ndo se permite limpiar por el costado en ruck?",o:["Nunca, debe ser por puerta","Siempre","S√≥lo si bal√≥n afuera"],c:0,d:5},
  {id:69,q:"Try con 'double movement' generalmente implica‚Ä¶",o:["No try","Try v√°lido","Penal a favor atacante"],c:0,d:5},
  {id:70,q:"TMO puede intervenir para‚Ä¶",o:["Cualquier infracci√≥n menor","Incidentes de try/ foul play claro","Sanciones de touch"],c:1,d:5},
  {id:71,q:"En kick-off que sale directo al touch sin picar‚Ä¶",o:["Scrum centro o repetici√≥n","Line en mitad","Penal salida"],c:0,d:5},
  {id:72,q:"Formaci√≥n m√≠nima de un maul legal incluye‚Ä¶",o:["Portador + 1 rival + 1 compa√±ero","S√≥lo atacantes","S√≥lo defensores"],c:0,d:5},
  {id:73,q:"Off feet en ruck significa‚Ä¶",o:["Apoyo sin pies en el suelo","Jugar de rodillas permitido","Tackle alto"],c:0,d:5},
  {id:74,q:"En 22 propia, patada que sale directa: ¬øquick throw posible?",o:["No, toc√≥ a espectadores","S√≠, si misma pelota y sin tocar a nadie","Siempre no"],c:1,d:5},
  {id:75,q:"¬øCu√°ndo procede scrum por pase hacia adelante intencional?",o:["Nunca, es penal","Siempre scrum","S√≥lo si hay ventaja"],c:0,d:5},
  {id:76,q:"Argentina fue 3¬∞ en el Mundial‚Ä¶",o:["2007","2015","1999"],c:0,d:4},
  {id:77,q:"'White line fever' describe‚Ä¶",o:["Ansiedad al ver el in-goal y tomar malas decisiones","Fiebre previa al partido","Fatiga de scrum"],c:0,d:4},
  {id:78,q:"Mezcla de backs/forwards para emboscada se llama‚Ä¶",o:["Strike move","Counter ruck","Flying wedge"],c:0,d:4},
  {id:79,q:"¬øQu√© infracci√≥n invalida quick tap?",o:["Tap con pie equivocado","Tap correcto pero sin se√±alar","Tap y correr"],c:0,d:4},
  {id:80,q:"'Flying wedge' en kickoff est√°‚Ä¶",o:["Prohibido","Permitido","S√≥lo juvenil"],c:0,d:5},
];

/* ======================= LOGIN ======================= */
$("btnLogin").onclick = async ()=>{
  const alias = $("alias").value.trim();
  if(!alias) return toast("Ingres√° un alias");

  // ADMIN: si escribe exactamente el token en el mismo campo
  if(alias === ADMIN_TOKEN){
    $("loginCard").classList.add("hidden");
    $("adminCard").classList.remove("hidden");
    toast("Bienvenido Admin");
    play("s-join");
    return;
  }

  // Jugador
  try{
    // buscar o crear
    let { data: user, error } = await sb.from("users").select("*").eq("username", alias).maybeSingle();
    if(error) throw error;
    if(!user){
      const ins = await sb.from("users").insert([{ username: alias, coins: 0 }]).select().single();
      if(ins.error) throw ins.error;
      user = ins.data;
    }
    me = user;
    freeLeft = 3; correct=0; wrong=0; level=1; asked.clear();
    $("hudUser").textContent = me.username;
    $("hudCoins").textContent = me.coins ?? 0;
    $("hudLevel").textContent = level;
    $("hudStats").textContent = `${correct} / ${wrong}`;
    $("freeLeft").textContent = freeLeft;

    $("loginCard").classList.add("hidden");
    $("gameCard").classList.remove("hidden");
    toast(`Bienvenido ${me.username}!`);
    play("s-join");

    subscribeChat();
    loadChat();
    loadRank();
    nextScreenIdle();
  }catch(e){
    console.error(e);
    toast("Error de conexi√≥n. Revis√° Supabase.");
  }
};
$("btnMenu").onclick = ()=>{
  resetTimer();
  $("gameCard").classList.add("hidden");
  $("adminCard").classList.add("hidden");
  $("loginCard").classList.remove("hidden");
  toast("Volviste al men√∫");
};

/* ======================= LOGICA DE JUEGO ======================= */
function nextScreenIdle(){
  // mostrar/ocultar cajas seg√∫n freeLeft
  if(freeLeft>0){
    $("trainInfo").classList.remove("hidden");
    $("betBox").classList.add("hidden");
  }else{
    $("trainInfo").classList.add("hidden");
    $("betBox").classList.remove("hidden");
  }
  prepareQuestion();
}
function prepareQuestion(){
  // elegir pregunta no repetida del set acorde al nivel
  // 5 por nivel, vamos subiendo cada 5 correct/wrong total
  const levelIndex = Math.min(15, Math.floor((correct+wrong)/5)+1);
  level = levelIndex;
  $("hudLevel").textContent = level;

  // dificultad aproximada por level
  const targetD = level<=5?1 : level<=9?2 : level<=12?3 : level<=13?4 : 5;
  const pool = QUESTIONS.filter(q=>!asked.has(q.id) && q.d===targetD);
  const fallback = QUESTIONS.filter(q=>!asked.has(q.id));
  const pick = (pool.length? pool : fallback);
  if(!pick.length){ // sin preguntas
    toast("Sin preguntas disponibles");
    return;
  }
  currentQ = pick[Math.floor(Math.random()*pick.length)];
  asked.add(currentQ.id);

  // pintar
  $("qText").textContent = currentQ.q;
  const opts = $("qOpts"); opts.innerHTML="";
  currentQ.o.forEach((txt,idx)=>{
    const b=document.createElement("button");
    b.textContent = ["A) ","B) ","C) "][idx] + txt;
    b.onclick = ()=> answer(idx);
    opts.appendChild(b);
  });

  // timer
  startTimer();
}
function startTimer(){
  resetTimer();
  timeLeft = 20;
  moveBall();
  ticking = setInterval(()=>{
    timeLeft--;
    moveBall();
    if(timeLeft<=0){
      resetTimer();
      lose();
      afterAnswer();
    }
  },1000);
}
function moveBall(){
  const pct = Math.max(0,(timeLeft/20)*100);
  $("tBar").style.width = pct+"%";
  $("tBall").style.left = (100-pct)+"%";
}
function resetTimer(){ if(ticking){ clearInterval(ticking); ticking=null; } }

/* Responder */
async function answer(idx){
  resetTimer();
  // Entrenamiento sin apuesta (freeLeft>0)
  if(freeLeft>0){
    if(idx===currentQ.c){
      correct++; play("s-win"); confetti(); toast("¬°Correcto! (entrenamiento)");
    }else{
      wrong++; play("s-lose"); $("gameCard").classList.add("shake"); setTimeout(()=>$("gameCard").classList.remove("shake"),600);
      toast("Incorrecto (entrenamiento)");
    }
    freeLeft--; $("freeLeft").textContent = freeLeft;
    $("hudStats").textContent = `${correct} / ${wrong}`;
    afterAnswer();
    if(freeLeft===0){ toast("Para seguir jugando, compr√° monedas en la tienda."); }
    return;
  }

  // Con apuesta
  const bet = parseInt($("bet").value,10) || 0;
  if(bet<500){ toast("La apuesta m√≠nima es $500"); return; }
  if((me?.coins||0) < bet){ toast("No ten√©s monedas suficientes"); return; }
  currentBet = bet;
  play("s-bet");

  if(idx===currentQ.c){
    correct++;
    await changeCoins(+bet);
    play("s-win"); confetti();
    toast(`‚úÖ ¬°Correcto! +$${bet}`);
  }else{
    wrong++;
    await changeCoins(-bet);
    play("s-lose"); $("gameCard").classList.add("shake"); setTimeout(()=>$("gameCard").classList.remove("shake"),600);
    toast(`‚ùå Incorrecto. -$${bet}`);
  }
  $("hudStats").textContent = `${correct} / ${wrong}`;
  afterAnswer();
}
function afterAnswer(){
  // subir nivel cada 5 preguntas contestadas (acierte o no)
  const total = correct+wrong;
  if(total%5===0 && level<15){
    toast(`‚¨ÜÔ∏è Avanzaste al nivel ${level+1}`);
  }
  // siguiente pregunta
  setTimeout(()=> prepareQuestion(), 600);
}

/* ======================= COINS / RANK ======================= */
async function changeCoins(delta){
  if(!me) return;
  const newCoins = Math.max(0,(me.coins||0) + delta);
  const { error } = await sb.from("users").update({ coins: newCoins }).eq("id", me.id);
  if(!error){ me.coins = newCoins; $("hudCoins").textContent = me.coins; loadRank(); }
}
async function loadRank(){
  const { data, error } = await sb.from("users").select("*").order("coins",{ascending:false}).limit(50);
  const r=$("rank"); r.innerHTML="";
  (data||[]).forEach((u,i)=>{
    const row=document.createElement("div");
    row.className="item";
    row.innerHTML=`<span>#${i+1} ${u.username}</span><b>$${u.coins||0}</b>`;
    r.appendChild(row);
  });
}

/* ======================= CHAT ======================= */
async function loadChat(){
  const { data } = await sb.from("messages").select("*").order("created_at",{ascending:true}).limit(200);
  paintChat(data||[]);
}
function paintChat(rows){
  const c=$("chatList"); c.innerHTML="";
  rows.forEach(m=>{
    const d=document.createElement("div");
    d.className="msg"; d.id = "msg-"+m.id;
    d.innerHTML = `<div class="who">${m.username}</div><div>${m.content}</div><small style="opacity:.6">${(new Date(m.created_at)).toLocaleTimeString()}</small>`;
    c.appendChild(d);
  });
  c.scrollTop=c.scrollHeight;
}
$("btnSend").onclick = async ()=>{
  const t=$("chatText").value.trim();
  if(!t) return;
  if(!me){ toast("Primero inici√° sesi√≥n"); return; }
  $("chatText").value="";
  play("s-chat");
  await sb.from("messages").insert([{ username: me.username, content: t }]);
};
function subscribeChat(){
  sb.channel('room')
    .on('postgres_changes',{event:'INSERT',schema:'public',table:'messages'},payload=>{
      const m = payload.new;
      const c=$("chatList");
      const d=document.createElement("div");
      d.className="msg"; d.id="msg-"+m.id;
      d.innerHTML=`<div class="who">${m.username}</div><div>${m.content}</div><small style="opacity:.6">${(new Date(m.created_at)).toLocaleTimeString()}</small>`;
      c.appendChild(d); c.scrollTop=c.scrollHeight;
    })
    .subscribe();
}

/* ======================= ADMIN PANEL ======================= */
$("aAdd").onclick = async ()=>{
  const u=$("aUser").value.trim(); const amt=parseInt($("aAmount").value,10)||0;
  if(!u||!amt) return toast("Alias y monto (+) requeridos");
  const { data, error } = await sb.from("users").select("*").eq("username",u).maybeSingle();
  if(error||!data) return toast("Usuario no encontrado");
  const res = await sb.from("users").update({ coins: (data.coins||0)+amt }).eq("id", data.id);
  if(res.error) return toast("Error al cargar");
  toast("Monedas cargadas");
};
$("aSub").onclick = async ()=>{
  const u=$("aUser").value.trim(); const amt=parseInt($("aAmount").value,10)||0;
  if(!u||!amt) return toast("Alias y monto (-) requeridos");
  const { data, error } = await sb.from("users").select("*").eq("username",u).maybeSingle();
  if(error||!data) return toast("Usuario no encontrado");
  const newCoins = Math.max(0,(data.coins||0)-Math.abs(amt));
  const res = await sb.from("users").update({ coins: newCoins }).eq("id", data.id);
  if(res.error) return toast("Error al restar");
  toast("Monedas descontadas");
};
$("aCreate").onclick = async ()=>{
  const u=$("aUser").value.trim(); if(!u) return toast("Alias requerido");
  const ex = await sb.from("users").select("id").eq("username",u).maybeSingle();
  if(ex.data){ toast("Ya existe"); return; }
  const ins = await sb.from("users").insert([{ username:u, coins:0 }]);
  if(ins.error) return toast("Error al crear");
  toast("Usuario creado");
};
$("aDel").onclick = async ()=>{
  const u=$("aUser").value.trim(); if(!u) return toast("Alias requerido");
  const got = await sb.from("users").select("*").eq("username",u).maybeSingle();
  if(!got.data) return toast("No existe");
  const del = await sb.from("users").delete().eq("id", got.data.id);
  if(del.error) return toast("No se pudo eliminar (RLS?)");
  toast("Usuario eliminado");
};
$("aMsgDel").onclick = async ()=>{
  const id = $("aMsgId").value.trim(); if(!id) return toast("ID requerido");
  // intento borrar
  const del = await sb.from("messages").delete().eq("id", id);
  if(del.error){
    // fallback: ocultar cliente
    const el = $("msg-"+id);
    if(el){ el.remove(); toast("Ocultado localmente (RLS impidi√≥ borrar)"); }
    else toast("No se pudo borrar");
  }else{
    toast("Mensaje borrado");
  }
};
$("aBack").onclick = ()=>{
  $("adminCard").classList.add("hidden");
  $("loginCard").classList.remove("hidden");
};

/* ======================= TIENDA ======================= */
document.querySelectorAll(".store button").forEach(b=>{
  b.onclick=()=>{
    const url=b.getAttribute("data-url");
    const a=b.getAttribute("data-amt");
    toast(`Vas a Mercado Pago por ${a} monedas. Compart√≠ el comprobante en el chat.`);
    window.open(url,"_blank");
  };
});

/* ======================= INIT ======================= */
loadRank();
</script>
</body>
</html>
